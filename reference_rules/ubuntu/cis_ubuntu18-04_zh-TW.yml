# Security Configuration Assessment
# CIS Checks for Ubuntu Linux 18.04 LTS
# Copyright (C) 2015, Wazuh Inc.
#
# This program is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation
#
# Based on:
# Center for Internet Security Ubuntu Linux 18.04 LTS Benchmark v2.0.1 - 01-03-2020

policy:
  id: "cis_ubuntu18-04"
  file: "cis_ubuntu18-04.yml"
  name: "CIS Ubuntu Linux 18.04 LTS Benchmark v2.0.1"
  description: "This document provides prescriptive guidance for establishing a secure configuration posture for Ubuntu Linux 18.04 LTS."
  references:
    - https://www.cisecurity.org/cis-benchmarks/

requirements:
  title: "Check Ubuntu version."
  description: "Requirements for running the SCA scan against Ubuntu Linux 18.04 LTS"
  condition: all
  rules:
    - "f:/etc/os-release -> r:Ubuntu"
    - "f:/proc/sys/kernel/ostype -> Linux"

checks:
  ############################################################
  # 1 Initial Setup
  ############################################################

  # 1.1 Filesystem configuration

  - id: 18500
    title: "確保已停用cramfs 檔案系統的安裝。"
    description: "cramfs 檔案系統類型是嵌入在小型系統中的壓縮唯讀 Linux 檔案系統。無需先解壓縮影像即可使用cramfs影像。"
    rationale: "刪除對不需要的檔案系統類型的支援可以減少伺服器的本機攻擊面。如果不需要此檔案系統類型，請將其停用。"
    remediation: "1) 編輯或創建 /etc/modprobe.d/ 目錄下以 .conf 結尾的檔案，並添加以下行：install cramfs /bin/true。 2) 執行以下指令以卸載 cramfs 模組：# rmmod cramfs"
    compliance:
      - cis: ["1.1.1.1"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    condition: all
    rules:
      - "c:modprobe -n -v cramfs -> r:^install /bin/true"
      - "not c:lsmod -> r:cramfs"

  - id: 18501
    title: "確保 freevxfs 檔案系統的掛載已停用。"
    description: "freevxfs 檔案系統類型是 Veritas 類型檔案系統的免費版本。這是 HP-UX 作業系統的主要檔案系統類型。"
    rationale: "刪除對不需要的檔案系統類型的支援可以減少系統的本機攻擊面。如果不需要此檔案系統類型，請將其停用。"
    remediation: "在 /etc/modprobe.d/ 目錄中編輯或創建一個以 .conf 結尾的檔案 例如: vi /etc/modprobe.d/freevxfs.conf 並添加以下行: install freevxfs /bin/true 執行以下指令以卸載 freevxfs 模組: # rmmod freevxfs"
    compliance:
      - cis: ["1.1.1.2"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    condition: all
    rules:
      - "c:/sbin/modprobe -n -v freevxfs -> r:^install /bin/true"
      - "not c:lsmod -> r:freevxfs"

  - id: 18502
    title: "確保已停用 jffs2 檔案系統的安裝。"
    description: "jffs2（日誌快閃檔案系統 2）檔案系統類型是在快閃記憶體裝置中使用的日誌結構檔案系統。"
    rationale: "刪除對不需要的檔案系統類型的支援可以減少系統的本機攻擊面。如果不需要此檔案系統類型，請將其停用。"
    remediation: "在 /etc/modprobe.d/ 目錄中編輯或創建一個以 .conf 結尾的檔案 例如: vi /etc/modprobe.d/jffs2.conf 並添加以下行: install jffs2 /bin/true 執行以下指令以卸載 jffs2 模組: # rmmod jffs2"
    compliance:
      - cis: ["1.1.1.3"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    condition: all
    rules:
      - "c:/sbin/modprobe -n -v jffs2 -> r:^install /bin/true"
      - "not c:lsmod -> r:jffs2"

  - id: 18503
    title: "確保禁用 hfs 檔案系統的掛載。"
    description: "hfs 檔案系統類型是一種分層檔案系統，可讓您掛載 Mac OS 檔案系統。"
    rationale: "刪除對不需要的檔案系統類型的支援可以減少系統的本機攻擊面。如果不需要此檔案系統類型，請將其停用。"
    remediation: "編輯或創建 /etc/modprobe.d/ 目錄中的一個 .conf 檔案 例子: vi /etc/modprobe.d/hfs.conf 並添加以下行: install hfs /bin/true 執行以下指令以卸載 hfs 模組: # rmmod hfs"
    compliance:
      - cis: ["1.1.1.4"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    condition: all
    rules:
      - "c:/sbin/modprobe -n -v hfs -> r:^install /bin/true"
      - "not c:lsmod -> r:hfs"

  - id: 18504
    title: "確保已停用 hfsplus 檔案系統的安裝。"
    description: "hfsplus 檔案系統類型是一種分層檔案系統，旨在取代 hfs，可讓您掛載 Mac OS 檔案系統。"
    rationale: "刪除對不需要的檔案系統類型的支援可以減少系統的本機攻擊面。如果不需要此檔案系統類型，請將其停用。"
    remediation: "在 /etc/modprobe.d/ 目錄中編輯或創建一個以 .conf 結尾的檔案例如: vi /etc/modprobe.d/hfsplus.conf 並添加以下行: install hfsplus /bin/true 運行以下指令以卸載 hfsplus 模組: # rmmod hfsplus"
    compliance:
      - cis: ["1.1.1.5"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    condition: all
    rules:
      - "c:/sbin/modprobe -n -v hfsplus -> r:^install /bin/true"
      - "not c:lsmod -> r:hfsplus"

  - id: 18505
    title: "確保已停用了 squashfs 檔案系統的安裝。"
    description: "squashfs 檔案系統類型是嵌入在小型佔用空間系統中的壓縮唯讀 Linux 檔案系統（類似於cramfs）。無需先解壓縮映像即可使用 squashfs 映像。"
    rationale: "刪除對不需要的檔案系統類型的支援可以減少系統的本機攻擊面。如果不需要此檔案系統類型，請將其停用。"
    remediation: "編輯或建立 /etc/modprobe.d/ 目錄中以 .conf 結尾的檔案  例如: vi /etc/modprobe.d/squashfs.conf並新增以下一行: install squashfs /bin/true  執行以下指令以卸載 squashfs 模組: # rmmod squashfs"
    compliance:
      - cis: ["1.1.1.6"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - "c:modprobe -n -v squashfs -> r:install /bin/true|Module squashfs not found"
      - "not c:lsmod -> r:squashfs"

  - id: 18506
    title: "確保停用 udf 檔案系統的安裝。"
    description: "udf 檔案系統類型是用於實作 ISO/IEC 13346 和 ECMA-167 規範的通用磁碟格式。這是一種開放供應商檔案系統類型，用於在各種媒體上儲存資料。此檔案系統類型對於支援寫入 DVD 和更新的光碟格式是必要的。"
    rationale: "刪除對不需要的檔案系統類型的支援可以減少系統的本機攻擊面。如果不需要此檔案系統類型，請將其停用。"
    remediation: "在 /etc/modprobe.d/ 目錄中編輯或建立一個以 .conf 結尾的檔案 例如: vi /etc/modprobe.d/udf.conf 並添加以下行: install udf /bin/true 執行以下指令以卸載 udf 模組: # rmmod udf"
    compliance:
      - cis: ["1.1.1.7"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    condition: all
    rules:
      - "c:/sbin/modprobe -n -v udf -> r:^install /bin/true"
      - "not c:lsmod -> r:udf"

  - id: 18507
    title: "確保已停用 FAT 檔案系統的安裝。"
    description: "FAT 檔案系統格式主要用於較舊的 Windows 系統和可攜式 USB 隨身碟或快閃記憶體模組。它有 FAT12 、 FAT16 和 FAT32 三種類型，vfat 核心模組都支援這三種類型。"
    rationale: "刪除對不需要的檔案系統類型的支援可以減少系統的本機攻擊面。如果不需要此檔案系統類型，請將其停用。"
    remediation: "在 /etc/modprobe.d/ 目錄中編輯或創建一個以 .conf 結尾的檔案 例子: vi /etc/modprobe.d/vfat.conf: install vfat /bin/true. 執行以下指令以卸載 vfat 模組: rmmod vfat"
    compliance:
      - cis: ["1.1.1.8"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - "c:modprobe --showconfig -> r:install vfat /bin/true|Module vfat not found"
      - "not c:lsmod -> r:vfat"

  # 1.1.x Filesystem Configuration
  - id: 18508
    title: "確保 /tmp 已配置。"
    description: "/tmp 目錄是一個全域可寫入的目錄，用於所有使用者和某些應用程式的暫存。"
    rationale: "將 /tmp 設為自己的檔案系統允許管理員在掛載上設定 noexec 選項，從而使 /tmp 對於攻擊者安裝可執行程式碼而言毫無用處。它還可以防止攻擊者建立到系統 setuid 程式的硬連結並等待其更新。一旦程式被更新，硬連結就會被破壞，攻擊者就會擁有自己的程式副本。如果程式碰巧存在安全漏洞，攻擊者可以繼續利用已知的缺陷。這可以透過將 tmpfs 安裝到 /tmp 或為 /tmp 建立單獨的分割區來完成。"
    remediation: "設定 /etc/fstab 適當的內容。例如：tmpfs /tmp tmpfs defaults,rw,nosuid,nodev,noexec,relatime 0 0 或 執行以下指令來啟用 systemd 的 /tmp 掛載：systemctl unmask tmp.mount systemctl enable tmp.mount 編輯 /etc/systemd/system/local-fs.target.wants/tmp.mount 來配置 /tmp 掛載：[Mount] What=tmpfs Where=/tmp Type=tmpfs Options=mode=1777,strictatime,noexec,nodev,nosuid"
    compliance:
      - cis: ["1.1.2"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - http://tldp.org/HOWTO/LVM-HOWTO/
      - https://www.freedesktop.org/wiki/Software/systemd/APIFileSystems/
    condition: all
    rules:
      - 'c:mount -> r:\s/tmp\s'

  - id: 18509
    title: "確保 /tmp 分割區上設定了 nodev 選項。"
    description: "nodev 掛載選項指定檔案系統不能包含特殊裝置。"
    rationale: "由於 /tmp 檔案系統不支援設備，因此設定此選項可確保使用者無法嘗試在 /tmp 中建立區塊或字元特殊設備。"
    remediation: "編輯 /etc/fstab 檔案，為 /tmp 分區的第四欄（掛載選項）添加 nodev。更多資訊請參閱 fstab(5) 手冊頁。運行以下指令重新掛載 /tmp: # mount -o remount,nodev /tmp OR 編輯 /etc/systemd/system/local-fs.target.wants/tmp.mount，為 /tmp 挂載選項添加 nodev： [Mount] Options=mode=1777,strictatime,noexec,nodev,nosuid 運行以下指令重新掛載 /tmp: # mount -o remount,nodev /tmp"
    compliance:
      - cis: ["1.1.3"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/tmp\s && r:nodev'

  - id: 18510
    title: "確保 /tmp 分割區上設定了 nosuid 選項。"
    description: "nosuid 掛載選項指定檔案系統不能包含設定的使用者 ID 檔案。"
    rationale: "由於 /tmp 檔案系統僅用於臨時檔案存儲，因此設定此選項可確保使用者無法在 /tmp 中建立 set userid 檔案。"
    remediation: "編輯 /etc/fstab 檔案並在第四欄（掛載選項）中為 /tmp 分區添加 nosuid。更多資訊請參閱 fstab(5) 手冊頁。運行以下指令來重新掛載 /tmp：# mount -o remount,nosuid /tmp  或者   編輯 /etc/systemd/system/local-fs.target.wants/tmp.mount 以添加 nosuid 到 /tmp 的掛載選項：[Mount] Options=mode=1777,strictatime,noexec,nodev,nosuid 運行以下指令來重新掛載 /tmp： # mount -o remount,nosuid /tmp"
    compliance:
      - cis: ["1.1.4"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/tmp\s && r:nosuid'

  - id: 18511
    title: "確保 /tmp 分割區上設定了 noexec 選項。"
    description: "noexec 掛載選項指定檔案系統不能包含可執行二進位檔案。"
    rationale: "由於 /tmp 檔案系統僅用於臨時檔案存儲，因此設定此選項可確保使用者無法在 /tmp 中建立 set userid 檔案。"
    remediation: "編輯 /etc/fstab 檔案並在第四欄（掛載選項）為 /tmp 分區添加 noexec。詳情請參閱 fstab(5) 手冊頁面。執行以下指令重新掛載 /tmp：# mount -o remount,noexec /tmp    或    編輯 /etc/systemd/system/local-fs.target.wants/tmp.mount 為 /tmp 掛載選項添加 noexec：[Mount] Options=mode=1777,strictatime,noexec,nodev,nosuid 執行以下指令重新掛載 /tmp：# mount -o remount,noexec /tmp"
    compliance:
      - cis: ["1.1.5"]
      - cis_csc: ["2.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/tmp\s && r:noexec'

  - id: 18512
    title: "確保 /var 存在單獨的分割區。"
    description: "/var 目錄由守護程式和其他系統服務用來暫時儲存動態資料。這些程序所建立的某些目錄可能是全域可寫入的。"
    rationale: "由於/var目錄可能包含全域可寫入的檔案和目錄，如果不綁定到單獨的分區，則存在資源耗盡的風險。"
    remediation: "對於新安裝，在安裝期間創建自定義分區設置，並為/var指定單獨的分區。對於以前安裝的系統，創建一個新分區並適當配置/etc/fstab。"
    compliance:
      - cis: ["1.1.6"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - http://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var\s'

  - id: 18513
    title: "確保 /var/tmp 存在單獨的分割區。"
    description: "/var/tmp 目錄是一個全域可寫入的目錄，用於所有使用者和某些應用程式的暫存。"
    rationale: "由於 /var/tmp 目錄是全域可寫入的，因此如果不將其綁定到單獨的分區，則存在資源耗盡的風險。此外，使 /var/tmp 成為自己的檔案系統允許管理員在掛載上設定 noexec 選項，從而使 /var/tmp 對於攻擊者安裝可執行程式碼來說毫無用處。它還可以防止攻擊者建立到系統 setuid 程式的硬連結並等待其更新。一旦程式被更新，硬連結就會被破壞，攻擊者就會擁有自己的程式副本。如果程式碰巧存在安全漏洞，攻擊者可以繼續利用已知的缺陷。"
    remediation: "對於新的安裝，在安裝過程中創建一個自訂的分割區設置並為 /var/tmp 指定一個獨立的分割區。對於以前安裝的系統，創建一個新的分割區並適當地配置 /etc/fstab。"
    compliance:
      - cis: ["1.1.7"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - http://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var/tmp\s'

  - id: 18514
    title: "確保在 /var/tmp 分割區上設定了 nodev 選項。"
    description: "nodev 掛載選項指定檔案系統不能包含特殊裝置。"
    rationale: "由於 /var/tmp 檔案系統不支援設備，因此設定此選項可確保使用者無法嘗試在 /var/tmp 中建立區塊或字元特殊設備。"
    remediation: "編輯 /etc/fstab 檔案並將 nodev 添加到 /var/tmp 區段的第四欄位（掛載選項）。欲了解更多資訊，請參閱 fstab(5) 手冊頁。運行以下指令重新掛載 /var/tmp ：# mount -o remount,nodev /var/tmp"
    compliance:
      - cis: ["1.1.8"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/var/tmp\s && r:nodev'

  - id: 18515
    title: "確保 /var/tmp 分區上設定了 nosuid 選項。"
    description: "nosuid 掛載選項指定檔案系統不能包含 setuid 檔案。"
    rationale: "由於 /var/tmp 檔案系統僅用於臨時檔案存儲，因此設定此選項可確保使用者無法在 /var/tmp 中建立 setuid 檔案。"
    remediation: "編輯 /etc/fstab 檔案並在第四個欄位(掛載選項)添加 nosuid 給 /var/tmp 區塊。更多資訊請參閱 fstab(5) 手冊頁。執行以下指令重新掛載 /var/tmp：# mount -o remount,nosuid /var/tmp"
    compliance:
      - cis: ["1.1.9"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/var/tmp\s && r:nosuid'

  - id: 18516
    title: "確保 /var/tmp 分割區上設定了 noexec 選項。"
    description: "noexec 掛載選項指定檔案系統不能包含可執行二進位檔案。"
    rationale: "由於 /var/tmp 檔案系統僅用於臨時檔案存儲，因此設定此選項可確保使用者無法執行 /var/tmp 中的可執行二進位檔案。"
    remediation: "編輯/etc/fstab檔案,在/var/tmp分區的第四欄（掛載選項）中添加noexec。查看fstab(5)手冊頁面以獲取更多資訊。運行以下指令以重新掛載/var/tmp：# mount -o remount,noexec /var/tmp"
    compliance:
      - cis: ["1.1.10"]
      - cis_csc: ["2.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/var/tmp\s && r:noexec'

  - id: 18517
    title: "確保 /var/log 存在單獨的分割區。"
    description: "/var/log 目錄用於系統服務儲存日誌資料。"
    rationale: "確保系統日誌儲存在單獨的分割區上有兩個重要原因：防止資源耗盡（因為日誌可能會變得非常大）和保護稽核資料。"
    remediation: "對於新安裝，請在安裝過程中創建自定義分區設置，並為 /var/log 指定一個單獨的分區。對於先前已安裝的系統，請創建一個新分區並適當配置 /etc/fstab。"
    compliance:
      - cis: ["1.1.11"]
      - cis_csc: ["6.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - http://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var/log\s'

  - id: 18518
    title: "確保 /var/log/audit 存在單獨的分割區。"
    description: "稽核守護程式auditd 將日誌資料儲存在/var/log/audit 目錄中。"
    rationale: "確保將auditd收集的資料儲存在單獨的分割區上有兩個重要原因：防止資源耗盡（因為audit.log檔案可能會變得很大）和保護稽核資料。審核守護程序計算剩餘的可用空間並根據結果執行操作。如果其他程序（例如 syslog）與auditd 佔用相同分割區中的空間，則它可能無法如預期執行。"
    remediation: "對於新安裝的系統，在安裝過程中創建一個自定義分區設置，並為 /var/log/audit 指定一個單獨的分區。對於先前安裝的系統，創建一個新分區並適當配置 /etc/fstab。"
    compliance:
      - cis: ["1.1.12"]
      - cis_csc: ["6.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - http://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var/log/audit\s'

  - id: 18519
    title: "確保 /home 存在單獨的分區。"
    description: "/home目錄用於支援本機用戶的磁碟儲存需求。"
    rationale: "如果系統打算支援本機用戶，請為/home目錄建立一個單獨的分割區，以防止資源耗盡並限制/home下可以儲存的檔案類型。"
    remediation: "對於新安裝，在安裝過程中創建自訂分區配置並指定一個單獨的分區給 /home。對於已經安裝的系統，創建一個新分區並適當配置 /etc/fstab。"
    compliance:
      - cis: ["1.1.13"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - http://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/home\s'

  - id: 18520
    title: "確保在 /home 分割區上設定了 nodev 選項。"
    description: "nodev 掛載選項指定檔案系統不能包含特殊裝置。"
    rationale: "由於使用者分區不支援設備，因此設定此選項可確保使用者無法嘗試建立區塊或字元特殊設備。  注意：此項目中的操作涉及 /home 分區，它是許多發行版中定義的預設使用者分區。如果您建立了其他使用者分割區，建議也將修復和審核步驟套用到這些分割區。"
    remediation: "編輯 /etc/fstab 檔案，並為 /home 區段的第四個欄位（掛載選項）添加 nodev。請參閱 fstab(5) 手冊頁以獲取更多資訊。 # mount -o remount,nodev /home"
    compliance:
      - cis: ["1.1.14"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/home\s && r:nodev'

  - id: 18521
    title: "確保在 /dev/shm 分割區上設定了 nodev 選項。"
    description: "nodev 掛載選項指定檔案系統不能包含特殊裝置。"
    rationale: "由於 /dev/shm 檔案系統不支援設備，因此設定此選項可確保使用者無法嘗試在 /dev/shm 分割區中建立特殊設備。"
    remediation: "編輯 /etc/fstab 檔案，在第四個字段（掛載選項）中為 /dev/shm 分區添加 nodev。更多資訊請參見 fstab(5) 手冊頁。運行以下指令重新掛載 /dev/shm：# mount -o remount,nodev /dev/shm"
    compliance:
      - cis: ["1.1.15"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/dev/shm\s && r:nodev'

  - id: 18522
    title: "確保 /dev/shm 分割區上設定了 nosuid 選項。"
    description: "nosuid 掛載選項指定檔案系統不能包含 setuid 檔案。"
    rationale: "在檔案系統上設定此選項可防止使用者將特權程序引入系統並允許非 root 使用者執行它們。"
    remediation: "編輯 /etc/fstab 檔案，並在 /dev/shm 分區的第四欄位（掛載選項）添加 nosuid。更多資訊請參閱 fstab(5) 手冊頁。運行以下指令以重新掛載 /dev/shm： # mount -o remount,nosuid /dev/shm"
    compliance:
      - cis: ["1.1.16"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/dev/shm\s && r:nosuid'

  - id: 18523
    title: "確保 /dev/shm 分割區上設定了 noexec 選項。"
    description: "noexec 掛載選項指定檔案系統不能包含可執行二進位檔案。"
    rationale: "在檔案系統上設定此選項可防止使用者從共享記憶體執行程式。這可以阻止用戶在系統上引入潛在的惡意軟體。"
    remediation: "編輯 /etc/fstab 檔案並在 /dev/shm 區分的第四欄（掛載選項）添加 noexec。更多資訊請參見 fstab(5) 手冊頁。執行以下指令以重新掛載 /dev/shm: # mount -o remount,noexec /dev/shm"
    compliance:
      - cis: ["1.1.17"]
      - cis_csc: ["2.6", "8"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/dev/shm\s && r:noexec'

  - id: 18524
    title: "停用自動安裝。"
    description: "autofs 允許自動安裝設備，通常包括 CD/DVD 和 USB 驅動器。"
    rationale: "啟用自動掛載後，任何具有實體存取權限的人都可以連接 USB 隨身碟或光碟，並在系統中使用其內容，即使他們沒有自行掛載的權限。"
    remediation: "執行以下其中一個指令： 執行以下指令以停用 autofs： # systemctl --now disable autofs 或 執行以下指令以移除 autofs： # apt purge autofs"
    compliance:
      - cis: ["1.1.22"]
      - cis_csc: ["8.4", "8.5"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled autofs -> enabled"

  - id: 18525
    title: "停用 USB 儲存。"
    description: "USB 儲存提供了一種傳輸和儲存檔案的方法，可確保檔案的持續性和可用性，而不受網路連線狀態的影響。它的流行和實用性使得基於 USB 的惡意軟體成為一種簡單而常見的網路滲透手段，也是在網路環境中建立持續威脅的第一步。"
    rationale: "限制系統上的 USB 存取將減少裝置的實體攻擊面，並減少引入惡意軟體的可能媒介。"
    remediation: "在 /etc/modprobe.d/ 目錄中編輯或創建以 .conf 結尾的檔案 例如: vi /etc/modprobe.d/usb_storage.conf 並添加以下行: # install usb-storage /bin/true . 執行以下指令來卸載 usb-storage 模組: # rmmod usb-storage"
    compliance:
      - cis: ["1.1.23"]
      - cis_csc: ["8.4", "8.5"]
      - pci_dss: ["2.2.5"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC6.3"]
    condition: all
    rules:
      - "c:/sbin/modprobe -n -v usb-storage -> r:install /bin/true"
      - "not c:lsmod -> r:usb-storage"

  # 1.3 Configure Sudo

  - id: 18526
    title: "確保已安裝 sudo。"
    description: "sudo 允許允許的使用者作為超級使用者或安全策略指定的其他使用者執行指令。呼叫使用者的真實（非有效）使用者 ID 用於決定用於查詢安全性原則的使用者名稱。"
    rationale: "sudo 支援安全性原則和輸入/輸出日誌記錄的插件架構。第三方可以開發和分發自己的策略和 I/O 日誌記錄插件，以便與 sudo 前端無縫協作。預設安全性策略是 sudoers，它是透過檔案 /etc/sudoers 配置的。安全性策略確定使用者必須執行 sudo 的權限（如果有）。此政策可能要求使用者使用密碼或其他身份驗證機制來驗證自己的身份。如果需要身份驗證，如果在可設定的時間限制內未輸入使用者密碼，sudo 將退出。此限制是特定於政策的。"
    remediation: "使用以下指令安裝 sudo。 # apt install sudo 或 # apt install sudo-ldap"
    compliance:
      - cis: ["1.3.1"]
      - cis_csc: ["4.3"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - http://www.sudo.ws/
    condition: any
    rules:
      - "c:dpkg -s sudo -> r:install ok installed"
      - "c:dpkg -s sudo-ldap -> r:install ok installed"

  - id: 18527
    title: "確保 sudo 指令使用 pty。"
    description: "sudo 可以配置為僅從偽 pty 運行"
    rationale: "攻擊者可以使用 sudo 運行惡意程序，這將再次分叉一個後台程序，即使主程式已完成執行，該程序仍然存在。"
    remediation: "編輯檔案 /etc/sudoers 或 /etc/sudoers.d/ 中的一個檔案，用 visudo -f 並添加以下行：Defaults use_pty"
    compliance:
      - cis: ["1.3.2"]
      - cis_csc: ["4.3"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: any
    rules:
      - 'f:/etc/sudoers -> r:^\s*\t*Defaults\s*\t*use_pty'
      - 'd:/etc/sudoers.d -> r:\.* -> r:^\s*\t*Defaults\s*\t*use_pty'

  - id: 18528
    title: "確保 sudo 日誌檔案存在。"
    description: "sudo 可以使用自訂日誌檔案"
    rationale: "sudo 日誌檔簡化了 sudo 指令的審核"
    remediation: '編輯檔案 /etc/sudoers 或 /etc/sudoers.d/ 中的某個檔案，使用 visudo -f 並添加以下行：   Defaults logfile="<PATH TO CUSTOM LOG FILE>"   例子    Defaults logfile="/var/log/sudo.log"'
    compliance:
      - cis: ["1.3.3"]
      - cis_csc: ["6.3"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: any
    rules:
      - 'f:/etc/sudoers -> r:^\s*\t*Defaults\s*\t*logfile='
      - 'd:/etc/sudoers.d -> r:\.* -> r:^\s*\t*Defaults\s*\t*logfile='

  # 1.4 Filesystem Integrity Checking
  - id: 18529
    title: "確保已安裝 AIDE。"
    description: "AIDE 拍攝檔案系統狀態的快照，包括修改時間、權限和檔案雜湊值，然後可以與檔案系統的當前狀態進行比較，以偵測系統的修改。"
    rationale: "透過監視檔案系統狀態，可以偵測受損檔案，以防止或限制意外或惡意的錯誤配置或修改的二進位檔案的暴露。"
    remediation: "安裝 AIDE: # apt install aide aide-common。根據您的環境配置 AIDE。請參閱 AIDE 檔案以瞭解選項。初始化 AIDE: # aideinit。注意: 預鏈接功能可能會干擾 AIDE，因為它會更改二進制檔案以加快啟動時間。運行 prelink -ua 將二進制檔案恢復到預鏈接狀態，以避免 AIDE 的誤報。"
    compliance:
      - cis: ["1.4.1"]
      - cis_csc: ["14.9"]
      - pci_dss: ["11.5"]
      - tsc: ["PI1.4", "PI1.5", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "c:dpkg -s aide -> r:install ok installed"

  - id: 18530
    title: "確保定期檢查檔案系統的完整性。"
    description: "需要定期檢查檔案系統完整性以檢測檔案系統的變更。"
    rationale: "定期檔案檢查允許系統管理員定期確定關鍵檔案是否已被未經授權的方式更改。"
    remediation: "執行以下指令： # cp ./config/aidecheck.service /etc/systemd/system/aidecheck.service  # cp ./config/aidecheck.timer /etc/systemd/system/aidecheck.timer  # chmod 0644 /etc/systemd/system/aidecheck.*  # systemctl reenable aidecheck.timer  # systemctl restart aidecheck.timer  # systemctl daemon-reload  或者  如果將使用 cron 來排程和執行 aide 檢查，執行以下指令：  # crontab -u root -e  在 crontab 中添加以下行：  0 5 * * * /usr/bin/aide.wrapper --config /etc/aide/aide.conf --check"
    compliance:
      - cis: ["1.4.2"]
      - cis_csc: ["14.9"]
      - pci_dss: ["11.5"]
      - tsc: ["PI1.4", "PI1.5", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    references:
      - https://github.com/konstruktoid/hardening/blob/master/config/aidecheck.service
      - https://github.com/konstruktoid/hardening/blob/master/config/aidecheck.timer
    condition: all
    rules:
      - 'c:grep -Rh aide /etc/cron.d /etc/cron.daily /etc/cron.hourly /etc/cron.monthly /etc/cron.weekly /etc/crontab -> r:\.+'
      - "c:crontab -u root -l -> r:aide"

  # 1.5 Secure Boot Settings
  - id: 18531
    title: "確保配置了引導程式配置的權限。"
    description: "grub 設定檔包含有關引導設定和解鎖引導選項的密碼的資訊。 grub 配置通常是儲存在 /boot/grub 中的 grub.cfg。"
    rationale: "設定 root 的讀寫權限只能防止非 root 使用者檢視或變更啟動參數。讀取啟動參數的非 root 使用者可能能夠在啟動時識別安全漏洞並能夠利用它們。"
    remediation: "執行以下指令來設定你的 grub 配置的權限： chown root:root /boot/grub/grub.cfg, chmod og-rwx /boot/grub/grub.cfg"
    compliance:
      - cis: ["1.5.1"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /boot/grub/grub.cfg -> r:Access:\s*\(0\d00/-\w\w\w------\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  - id: 18532
    title: "確保設定了引導程式密碼。"
    description: "設定引導程式密碼將要求任何重新啟動系統的人都必須輸入密碼才能設定指令列引導參數。"
    rationale: "在執行引導程式時要求輸入引導密碼將防止未經授權的使用者輸入引導參數或變更引導分割區。這可以防止使用者削弱安全性（例如在啟動時關閉 SELinux）。"
    remediation: '使用 grub-mkpasswd-pbkdf2 創建加密密碼: # grub-mkpasswd-pbkdf2     Enter password: <password>      Reenter password: <password> PBKDF2 hash of your password is <encrypted-password> 將以下內容添加到自定義 /etc/grub.d 配置檔案中: cat <<EOF     set superusers="<username>"   password_pbkdf2 <username> <encrypted-password>      EOF     超級用戶/用戶資訊和密碼不應包含在 /etc/grub.d/00_header 檔案中，因為該檔案可能會在軟件包更新時被覆蓋。如果需要在不輸入密碼的情況下啟動/重新啟動，編輯 /etc/grub.d/10_linux 並在 CLASS= 行中添加 --unrestricted 示例: CLASS="--class gnu-linux --class gnu --class os --unrestricted" 運行以下指令來更新 grub2 配置: # update-grub'
    compliance:
      - cis: ["1.5.2"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'f:/boot/grub/grub.cfg -> r:^\s*\t*set superusers'
      - 'f:/boot/grub/grub.cfg -> r:^\s*\t*password'

  - id: 18533
    title: "確保單一使用者模式所需的身份驗證。"
    description: "單一使用者模式用於當系統在引導期間或透過引導程式手動選擇偵測到問題時進行復原。"
    rationale: "要求在單一用戶模式下進行身份驗證可防止未經授權的用戶將系統重新啟動為單用戶，以在沒有憑證的情況下獲得 root 權限。"
    remediation: "執行以下指令並按照提示為 root 用戶設置密碼：# passwd root"
    compliance:
      - cis: ["1.5.3"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "f:/etc/shadow -> r:^root:*:|^root:!:"

  - id: 18534
    title: "確保未啟用互動式啟動。"
    description: "互動式啟動允許控制台使用者以互動方式選擇啟動時啟動哪些服務。並非所有發行版都支援此功能。"
    rationale: "關閉控制台上的 PROMPT_FOR_CONFIRM 選項，以防止控制台使用者潛在地覆蓋已建立的安全設定。"
    remediation: "如果有互動式啟動功能，請將其停用。"
    compliance:
      - cis: ["1.5.4"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "f:/etc/shadow -> r:^root:*:|^root:!:"

  # 1.6 Additional Process Hardening

  - id: 18535
    title: "確保啟用 XD/NX 支援。"
    description: "x86 系列中的最新處理器支援阻止基於每個記憶體頁執行程式碼的功能。一般而言，在 AMD 處理器上，此功能稱為「不執行」(NX)，而在 Intel 處理器上，此功能稱為「執行停用」(XD)。此功能有助於防止利用緩衝區溢位漏洞，應盡可能啟動。必須採取額外的步驟來確保啟用此保護，特別是在 32 位元 x86 系統上。其他處理器（例如 Itanium 和 POWER）從一開始就包含此類支持，而這些平台的標準核心也支援該功能。"
    rationale: "啟用任何可以防止緩衝區溢位攻擊的功能都可以增強系統的安全性。"
    remediation: "在32位系統上安裝具有PAE支持的核心，64位系統上則無需安裝：如有必要，配置您的啟動載入程式以載入新的核心並重新啟動系統。您可能需要在BIOS中啟用NX或XD支持。"
    compliance:
      - cis: ["1.6.1"]
      - cis_csc: ["8.3"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sh -c "journalctl | grep \"protection: active\"" -> r:NX \(Execute Disable\) protection: active'

  - id: 18536
    title: "確保啟用位址空間佈局隨機化 (ASLR)。"
    description: "位址空間佈局隨機化 (ASLR) 是一種漏洞緩解技術，它隨機排列程序關鍵資料區域的位址空間。"
    rationale: "隨機放置虛擬記憶體區域將使編寫記憶體頁面漏洞變得困難，因為記憶體放置將持續變化。"
    remediation: "在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中設置以下參數： kernel.randomize_va_space = 2 執行以下指令以設置活動內核參數： # sysctl -w kernel.randomize_va_space=2"
    compliance:
      - cis: ["1.6.2"]
      - cis_csc: ["8.3"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:grep -Rh ^kernel\.randomize_va_space /etc/sysctl.conf /etc/sysctl.d -> r:\s*\t*2$'
      - 'c:sysctl kernel.randomize_va_space -> r:^kernel.randomize_va_space\s*\t*=\s*\t*2'

  - id: 18537
    title: "確保預鏈接已停用。"
    description: "prelink 是修改 ELF 共享庫和 ELF 動態連結二進位檔案的程序，其方式是動態連結器在啟動時執行重定位所需的時間顯著減少。"
    rationale: "預連結功能可能會幹擾 AIDE 的操作，因為它會更改二進位。如果惡意使用者能夠破壞 libc 等通用函式庫，預先連結也會增加系統的漏洞。"
    remediation: "執行以下指令以將二進位檔案恢復正常: # prelink -ua 使用適當的套件管理器或手動安裝來卸載 prelink: # apt purge prelink"
    compliance:
      - cis: ["1.6.3"]
      - cis_csc: ["14.9"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:dpkg -s prelink -> r:install ok installed"

  - id: 18538
    title: "確保核心轉儲受到限制。"
    description: "核心轉儲是可執行程式的記憶體。它通常用於確定程式中止的原因。它還可用於從核心檔案中收集機密資訊。系統提供了為核心轉儲設定軟限制的功能，但這可以由使用者覆蓋。"
    rationale: "對核心轉儲設定硬限制可以防止使用者覆蓋軟變數。如果需要核心轉儲，請考慮為使用者群組設定限制（請參閱limits.conf(5)）。此外，將 fs.suid_dumpable 變數設為 0 將阻止 setuid 程式轉儲核心。"
    remediation: "將以下行新增到 /etc/security/limits.conf 或 /etc/security/limits.d/* 檔案中: * hard core 0 在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中設置以下參數: fs.suid_dumpable = 0 執行以下指令以設置活動的核心參數: # sysctl -w fs.suid_dumpable=0"
    compliance:
      - cis: ["1.6.4"]
      - cis_csc: ["13"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl fs.suid_dumpable -> r:=\s*\t*0$'
      - 'c:grep -Rh fs\.suid_dumpable /etc/sysctl.conf /etc/sysctl.d -> !r:^# && r:=\s*\t*0$'
      - 'c:grep -Rh ^*[[:space:]]*hard[[:space:]][[:space:]]*core[[:space:]][[:space:]]* /etc/security/limits.conf /etc/security/limits.d -> r:\s*\t*0$'

  # 1.7 Mandatory Access Control

  - id: 18539
    title: "確保已安裝 AppArmor。"
    description: "AppArmor 提供強制存取控制。"
    rationale: "如果未安裝強制存取控制系統，則僅預設的自主存取控制系統可用。"
    remediation: "安裝 Apparmor. # apt install apparmor # apt install apparmor-utils"
    compliance:
      - cis: ["1.7.1.1"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: any
    rules:
      - "c:dpkg -s apparmor-utils -> r:install ok installed"
      - "c:dpkg -s apparmor -> r:install ok installed"

  - id: 18540
    title: "確保在引導程式配置中啟用 AppArmor。"
    description: "將 AppArmor 配置為在啟動時啟用，並驗證它是否未被引導程式引導參數覆蓋。"
    rationale: "AppArmor 必須在引導時在 grub 配置中啟用，以確保它提供的控制項不會被覆寫。"
    remediation: '編輯 /etc/default/grub 並將 apparmor=1 和 security=apparmor 參數添加到 GRUB_CMDLINE_LINUX= 行   GRUB_CMDLINE_LINUX="apparmor=1 security=apparmor"    運行以下指令以更新 grub2 配置 # update-grub    注意：此建議設計針對 grub 引導程序，如果在您的環境中使用的是 LILO 或其他引導程序，請採取等效設置。'
    compliance:
      - cis: ["1.7.1.2"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - 'f:/boot/grub/grub.cfg -> r:^\s*linux && !r:apparmor=1 && !r:/boot/memtest86+.bin'
      - 'f:/boot/grub/grub.cfg -> r:^\s*linux && !r:security=apparmor && !r:/boot/memtest86+.bin'

  - id: 18541
    title: "確保所有 AppArmor 設定檔均處於強製或投訴模式。"
    description: "AppArmor 設定檔定義應用程式能夠存取哪些資源。"
    rationale: "安全配置要求因網站而異。有些網站可能會強制執行比預設策略更嚴格的策略，這是完全可以接受的。此項旨在確保系統上存在的任何策略都已啟動。"
    remediation: "執行以下指令將所有配置檔設置為強制模式: # aa-enforce /etc/apparmor.d/*   或者   執行以下指令將所有配置檔設置為抱怨模式: # aa-complain /etc/apparmor.d/* 任何未受限的程序可能需要創建或啟用配置檔，然後重新啟動它們。"
    compliance:
      - cis: ["1.7.1.3"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - "c:apparmor_status -> r:0 processes are unconfined"

  - id: 18542
    title: "確保所有 AppArmor 設定檔均有效。"
    description: "AppArmor 設定檔定義應用程式能夠存取哪些資源。"
    rationale: "安全配置要求因網站而異。有些網站可能會強制執行比預設策略更嚴格的策略，這是完全可以接受的。此項旨在確保系統上存在的任何策略都已啟動。"
    remediation: "執行以下指令將所有配置檔案設置為強制模式: # aa-enforce /etc/apparmor.d/* 任何未受限制的程序可能需要為其創建或啟動配置檔案，然後重新啟動。"
    compliance:
      - cis: ["1.7.1.4"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:apparmor_status -> n:^(\d+)\s*profiles are loaded compare > 0'
      - 'c:apparmor_status -> r:^0\s*profiles are in complain mode'
      - 'c:apparmor_status -> r:^0\s*processes are unconfined'

  # 1.8 Warning Banners
  - id: 18543
    title: "確保當天的訊息配置正確。"
    description: "/etc/motd 檔案的內容在用戶登入後顯示給用戶，並作為經過身份驗證的用戶的當天訊息。基於 Unix 的系統通常在登入系統時顯示有關作業系統版本和修補程式層級的資訊。此資訊對於為特定作業系統平台開發軟體的開發人員非常有用。如果 Mingetty(8) 支援下列選項，它們會顯示作業系統資訊： \\m - 機器架構 \\r - 作業系統版本 \\s - 作業系統名稱 \\v - 作業系統版本"
    rationale: '警告訊息會通知嘗試登入系統的使用者有關系統的法律狀態，並且必須包含擁有該系統的組織的名稱以及任何現有的監控策略。在登入橫幅中顯示作業系統和修補程式等級資訊也會產生副作用，即向試圖針對系統的特定漏洞進行攻擊的攻擊者提供詳細的系統資訊。授權使用者登入後可以透過執行「uname -a」指令輕鬆取得此資訊。'
    remediation: "編輯 /etc/motd 檔案並依照您站點的政策適當填充內容，移除任何 \\m、\\r、\\s、\\v 或參考作業系統平台的實例；或者，如果 motd 未使用，此檔案可以刪除。執行以下指令來刪除 motd 檔案：# rm /etc/motd"
    compliance:
      - cis: ["1.8.1.1"]
      - cis_csc: ["5.1"]
      - pci_dss: ["7.1"]
      - tsc: ["CC6.4"]
    condition: any
    rules:
      - 'not f:/etc/motd -> r:\\v|\\r|\\m|\\s|Debian|Ubuntu'
      - "not f:/etc/motd"

  - id: 18544
    title: "確保本地登入警告橫幅配置正確。"
    description: "/etc/issue 檔案的內容在使用者登入本機終端之前顯示給使用者。基於 Unix 的系統通常在登入系統時顯示有關作業系統版本和修補程式層級的資訊。此資訊對於為特定作業系統平台開發軟體的開發人員非常有用。如果 Mingetty(8) 支援下列選項，它們會顯示作業系統資訊： \\m - 機器架構 \\r - 作業系統版本 \\s - 作業系統名稱 \\v - 作業系統版本"
    rationale: '警告訊息會通知嘗試登入系統的使用者有關系統的法律狀態，並且必須包含擁有該系統的組織的名稱以及任何現有的監控策略。在登入橫幅中顯示作業系統和修補程式等級資訊也會產生副作用，即向試圖針對系統的特定漏洞進行攻擊的攻擊者提供詳細的系統資訊。授權使用者登入後可以透過執行「uname -a」指令輕鬆取得此資訊。'
    remediation: "編輯 /etc/issue 檔案，根據您的站點政策填寫適當的內容，移除任何 \\m 、\\r 、\\s 或 \\v 的實例，或對作業系統平台的引用 # echo \"僅限授權使用。所有活動可能會被監控和報告.\" > /etc/issue"
    compliance:
      - cis: ["1.8.1.2"]
      - cis_csc: ["5.1"]
      - pci_dss: ["7.1"]
      - tsc: ["CC6.4"]
    condition: none
    rules:
      - 'f:/etc/issue -> r:\\v|\\r|\\m|\\s|Debian|Ubuntu'

  - id: 18545
    title: "確保遠端登入警告橫幅配置正確。"
    description: "/etc/issue.net 檔案的內容在使用者從配置的服務登入遠端連線之前顯示給使用者。基於 Unix 的系統通常在登入系統時顯示有關作業系統版本和修補程式層級的資訊。此資訊對於為特定作業系統平台開發軟體的開發人員非常有用。如果 Mingetty(8) 支援下列選項，它們會顯示作業系統資訊： \\m - 機器架構 \\r - 作業系統版本 \\s - 作業系統名稱 \\v - 作業系統版本"
    rationale: '警告訊息會通知嘗試登入系統的使用者有關系統的法律狀態，並且必須包含擁有該系統的組織的名稱以及任何現有的監控策略。在登入橫幅中顯示作業系統和修補程式等級資訊也會產生副作用，即向試圖針對系統的特定漏洞進行攻擊的攻擊者提供詳細的系統資訊。授權使用者登入後可以透過執行「uname -a」指令輕鬆取得此資訊。'
    remediation: "編輯 /etc/issue.net 檔案，根據您的站點政策填寫適當的內容，移除任何出現的 \\m, \\r, \\s 或 \\v 或對 OS 平台的引用： # echo \"Authorized uses only. All activity may be monitored and reported.\" > /etc/issue.net"
    compliance:
      - cis: ["1.8.1.3"]
      - cis_csc: ["5.1"]
      - pci_dss: ["7.1"]
      - tsc: ["CC6.4"]
    condition: none
    rules:
      - 'f:/etc/issue.net -> r:\\v|\\r|\\m|\\s|Debian|Ubuntu'

  - id: 18546
    title: "確保配置了 /etc/motd 的權限。"
    description: "/etc/motd 檔案的內容在用戶登入後顯示給用戶，並作為經過身份驗證的用戶的當天訊息。"
    rationale: "如果 /etc/motd 檔案沒有正確的所有權，則未經授權的使用者可能會使用不正確或誤導性的資訊對其進行修改。"
    remediation: "執行以下指令來設置 /etc/motd 的權限： # chown root:root /etc/motd # chmod u-x,go-wx /etc/motd"
    compliance:
      - cis: ["1.8.1.4"]
      - cis_csc: ["5.1"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - 'c:stat /etc/motd -> r:Access:\s*\(0644/-rw-r--r--\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  - id: 18547
    title: "確保配置了 /etc/issue 的權限。"
    description: "/etc/issue 檔案的內容在使用者登入本機終端之前顯示給使用者。"
    rationale: "如果 /etc/issue 檔案沒有正確的所有權，則未經授權的使用者可能會使用不正確或誤導性的資訊對其進行修改。"
    remediation: "運行以下指令來設置 /etc/issue 的權限: # chown root:root /etc/issue # chmod u-x,go-wx /etc/issue"
    compliance:
      - cis: ["1.8.1.5"]
      - cis_csc: ["5.1"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - 'c:stat /etc/issue -> r:Access:\s*\(0644/-rw-r--r--\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  - id: 18548
    title: "確保配置了 /etc/issue.net 上的權限。"
    description: "/etc/issue.net 檔案的內容在使用者從配置的服務登入遠端連線之前顯示給使用者。"
    rationale: "如果 /etc/issue.net 檔案沒有正確的所有權，則未經授權的使用者可能會使用不正確或誤導性的資訊對其進行修改。"
    remediation: "執行以下指令來設定 /etc/issue.net 的權限： # chown root:root /etc/issue.net # chmod u-x,go-wx /etc/issue.net"
    compliance:
      - cis: ["1.8.1.6"]
      - cis_csc: ["5.1"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - 'c:stat /etc/issue.net -> r:Access:\s*\(0644/-rw-r--r--\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  - id: 18549
    title: "確保已配置 GDM 登入橫幅。"
    description: "GDM 是 GNOME 顯示管理器，它處理基於 GNOME 的系統的圖形登入。"
    rationale: "警告訊息會通知嘗試登入系統的使用者有關系統的法律狀態，並且必須包含擁有該系統的組織的名稱以及任何現有的監控策略。"
    remediation: "編輯或創建檔案 /etc/gdm3/greeter.dconf-defaults 並添加: [org/gnome/login-screen], banner-message-enable=true, banner-message-text='僅限授權使用。所有活動可能會被監控和報告。'"
    compliance:
      - cis: ["1.8.2"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - "f:/etc/gdm3/greeter.dconf-defaults -> r:^[org/gnome/login-screen]"
      - "f:/etc/gdm3/greeter.dconf-defaults -> r:^banner-message-enable=true"
      - 'f:/etc/gdm3/greeter.dconf-defaults -> r:^banner-message-text=\.+'

  - id: 18550
    title: "確保安裝更新、修補程式和其他安全軟體。"
    description: "由於安全缺陷或包含附加功能，會定期發布包含的軟體的修補程式。"
    rationale: "較新的更新檔可能包含最新完整更新無法提供的安全性增強功能。因此，建議使用最新的軟體修補程式以利用最新的功能。與任何軟體安裝一樣，組織需要確定給定的更新是否符合其要求，並根據所選的更新版本驗證任何其他軟體的相容性和可支援性。"
    remediation: "使用您的套件管理器根據站點政策更新系統上的所有套件。 注意：站點政策可能會要求在將可用更新安裝到生產系統之前進行測試期。"
    compliance:
      - cis: ["1.9"]
      - cis_csc: ["3.4", "3.5"]
      - pci_dss: ["5.2"]
      - nist_800_53: ["AU.6", "SI.4"]
      - gpg_13: ["4.2"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["A1.2"]
    condition: none
    rules:
      - "c:apt -s upgrade -> r:^The following packages will be upgraded"

  ############################################################
  # 2 Services
  ############################################################

  - id: 18551
    title: "確保未安裝 xinetd。"
    description: "eXtending Internet Daemon (xinetd) 是一個開源超級守護程序，它取代了原始的 inetd 守護程式。 xinetddaemon 偵聽眾所周知的服務並調度適當的守護程序以正確回應服務請求。"
    rationale: "如果不需要 xinetd 服務，建議刪除該軟體包。"
    remediation: "執行以下指令來移除 xinetd: # apt purge xinetd"
    compliance:
      - cis: ["2.1.1"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:dpkg -s xinetd -> r:install ok installed"

  - id: 18552
    title: "確保未安裝 openbsd-inetd。"
    description: "inetd 守護程式偵聽眾所周知的服務並調度適當的守護程序以正確回應服務請求。"
    rationale: "如果不需要 inetd 服務，建議刪除該守護程式。"
    remediation: "運行以下指令來卸載 openbsd-inetd: apt-get remove openbsd-inetd"
    compliance:
      - cis: ["2.1.2"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:dpkg -s openbsd-inetd -> r:install ok installed"

  - id: 18553
    title: "確保正在使用時間同步。"
    description: "系統時間應在環境中的所有系統之間同步。這通常是透過建立一個權威時間伺服器或一組伺服器並使所有系統將其時鐘與它們同步來完成的。"
    rationale: "時間同步對於支援 Kerberos 等時間敏感的安全機制非常重要，並且還確保記錄檔在整個企業中具有一致的時間記錄，這有助於取證調查。"
    remediation: '在主機端時間同步不可用的系統上，請配置 systemd-timesyncd。如果需要「全功能」和/或加密時間同步，請安裝 chrony 或 NTP。要安裝 chrony：# apt install chrony 要安裝 ntp：# apt install ntp 在主機端時間同步可用的虛擬系統上，請查閱您的虛擬化軟體檔案並設置主機端同步。'
    compliance:
      - cis: ["2.2.1.1"]
      - cis_csc: ["6.1"]
      - pci_dss: ["10.4"]
      - nist_800_53: ["AU.8"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: any
    rules:
      - "c:dpkg -s ntp -> r:install ok installed"
      - "c:dpkg -s chrony -> r:install ok installed"
      - "c:systemctl is-enabled systemd-timescynd -> enabled"

  - id: 18554
    title: "確保已配置 systemd-timesyncd。"
    description: 'systemd-timesyncd 是為跨網路同步系統時鐘而新增的守護程式。它實作了 SNTP 客戶端。與 chrony 或 NTP 參考伺服器等 NTP 實作相比，它僅實作客戶端，並且不會考慮完整的 NTP 複雜性，僅關注從一台遠端伺服器查詢時間並將本地時鐘與其同步。此守護程序以最小的權限運行，並且已與網路連接，僅在網路連接可用時運行。每次取得新的 NTP 同步時，守護程式都會將當前時鐘儲存到磁碟，並使用它在啟動早期修正系統時鐘，以適應缺乏 RTC 的系統，例如 Raspberry Pi 和嵌入式設備，並確保這些系統上的時間單調前進，即使它並不總是正確的。要使用此守護程序，需要在安裝 systemd 時建立新的系統使用者和群組「systemd-timesync」。注意：systemd-timesyncd 服務專門只實作 SNTP。這種簡約的服務將設定系統時鐘以獲得較大的偏移量或緩慢地調整它以獲得較小的增量。 systemd-timesyncd 不涵蓋更複雜的用例。此建議僅適用於系統上使用 timesyncd 的情況。'
    rationale: "正確的配置對於確保時間同步正常運作至關重要。此建議僅適用於系統上使用 timesyncd 的情況。"
    remediation: "運行以下指令以啟用 systemd-timesyncd   # systemctl enable systemd-timesyncd.service  ||  編輯檔案 /etc/systemd/timesyncd.conf 並根據當地網站政策新增/修改以下行:    (1) NTP=0.ubuntu.pool.ntp.org 1.ubuntu.pool.ntp.org 2.ubuntu.pool.ntp.org        (2) FallbackNTP=ntp.ubuntu.com 3.ubuntu.pool.ntp.org        (3) RootDistanceMaxSec=1    || 運行以下指令以啟動 systemd-timesyncd.service   # systemctl start systemd-timesyncd.service   # timedatectl set-ntp true  || 注意事項: 伺服器列表和 RootDistanceMax 應符合當地政策，某些版本的 systemd 在編譯時未包含 systemd-timesyncd。在這些發行版上，應使用 chrony 或 NTP 替代 systemd-timesyncd。並非所有選項在所有版本的 systemd-timesyncd 上都可用。"
    compliance:
      - cis: ["2.2.1.2"]
      - cis_csc: ["6.1"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - "c:systemctl is-enabled systemd-timesyncd.service -> enabled"

  - id: 18555
    title: "確保配置了 chrony。"
    description: "chrony 是一個實作網路時間協定 (NTP) 的守護程序，旨在跨各種系統同步系統時鐘並使用高度準確的來源。有關 chrony 的更多資訊，請存取 http://chrony.tuxfamily.org/。 chrony 可以設定為客戶端和/或伺服器。"
    rationale: "如果系統上使用 chrony，正確的配置對於確保時間同步正常運作至關重要。此建議僅適用於系統上使用 chrony 的情況。"
    remediation: "將或編輯 server 或 pool 行添加到 /etc/chrony/chrony.conf 中: server <remote-server> 透過配置適當的啟動腳本將 chrony 配置為以 chrony 用戶運行，適用於您的發行版。啟動腳本通常存儲在 /etc/init.d 或 /etc/systemd 中。"
    compliance:
      - cis: ["2.2.1.3"]
      - cis_csc: ["6.1"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'f:/etc/chrony/chrony.conf -> r:^server\.+|^pool\.+'

  - id: 18556
    title: "確保 ntp 已設定。"
    description: "ntp 是一個實作網路時間協定（NTP）的守護程式。它旨在同步各種系統之間的系統時鐘並使用高度準確的來源。有關 NTP 的更多資訊，請存取 http://www.ntp.org。 ntp 可以設定為客戶端和/或伺服器。此建議僅適用於系統上使用 ntp 的情況。"
    rationale: "如果系統上使用 ntp，正確的配置對於確保時間同步正常運作至關重要。"
    remediation: "在 /etc/ntp.conf 中添加或編輯限制行以符合以下內容: restrict -4 default kod nomodify notrap nopeer noquery restrict -6 default kod nomodify notrap nopeer noquery 根據需要在 /etc/ntp.conf 中添加或編輯服務器或池行: server <remote-server> 通過添加或編輯 /etc/init.d/ntp 檔案來配置 ntp 以 ntp 用戶身份運行: RUNASUSER=ntp"
    compliance:
      - cis: ["2.2.1.4"]
      - cis_csc: ["6.1"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - http://www.ntp.org/
    condition: all
    rules:
      - 'f:/etc/ntp.conf -> r:^restrict\s+-4\s+default|^restrict\s+default && r:\s+kod\s+ && r:\s+nomodify\s+ && r:\s+notrap\s+ && r:\s+nopeer\s+ && r:\s+noquery'
      - 'f:/etc/ntp.conf -> r:^restrict\s+-6\s+default && r:\s+kod\s+ && r:\s+nomodify\s+ && r:\s+notrap\s+ && r:\s+nopeer\s+ && r:\s+noquery'
      - 'f:/etc/ntp.conf -> r:^server\.+|^pool\.+'
      - 'f:/etc/init.d/ntp -> r:^RUNASUSER\s*\t*=\s*\t*ntp'

  # 2.2.2 Ensure the X Window system is not installed (Scored)
  - id: 18557
    title: "確保未安裝 X Window 系統。"
    description: "X Window 系統提供了圖形使用者介面 (GUI)，使用者可以在其中擁有多個視窗來運行程式和各種附加元件。 X Windows 系統通常用於使用者登入的工作站，但不適用於使用者通常不登入的伺服器。"
    rationale: "除非您的組織特別需要透過 X Windows 進行圖形登入存取，否則請將其刪除以減少潛在的攻擊面。"
    remediation: "移除 X 視窗系統封包：apt purge xserver-xorg*"
    compliance:
      - cis: ["2.2.2"]
      - cis_csc: ["2.6"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2", "CC6.1", "CC6.8", "CC7.1", "CC7.2", "CC8.1"]
    condition: none
    rules:
      - 'c:dpkg -l xserver-xorg-core* -> r:^\wi\s*xserver-xorg'

  - id: 18558
    title: "確保 Avahi 伺服器未啟用。"
    description: "Avahi 是一個免費的 Zeroconf 實作，包括用於多播 DNS/DNS-SD 服務發現的系統。 Avahi 允許程式發布和發現在本機網路上執行的服務和主機，無需進行特定配置。例如，使用者可以將電腦插入網路，Avahi 會自動尋找要列印的印表機、要查看的檔案和要交談的人，以及電腦上執行的網路服務。"
    rationale: "系統功能通常不需要自動發現網路服務。建議停用該服務以減少潛在的連接表面。"
    remediation: "運行以下指令以停用 avahi-daemon: # systemctl --now disable avahi-daemon"
    compliance:
      - cis: ["2.2.3"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled avahi-daemon -> enabled"

  - id: 18559
    title: "確保 CUPS 未啟用。"
    description: "通用 Unix 列印系統 (CUPS) 提供了列印到本機和網路印表機的功能。運行 CUPS 的系統還可以接受來自遠端系統的列印作業並將其列印到本機印表機。它還提供基於網路的遠端管理功能。"
    rationale: "如果系統不需要列印作業或接受其他系統的列印作業，建議停用CUPS以減少潛在的攻擊面。"
    remediation: "執行以下指令以停用cups: # systemctl --now disable cups"
    compliance:
      - cis: ["2.2.4"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - https://www.cups.org
    condition: none
    rules:
      - "c:systemctl is-enabled cups -> enabled"

  - id: 18560
    title: "確保 DHCP 伺服器未啟用。"
    description: "動態主機設定協定 (DHCP) 是一項允許為電腦動態指派 IP 位址的服務。"
    rationale: "除非系統專門設定為充當 DHCP 伺服器，否則建議停用此服務以減少潛在的攻擊面。"
    remediation: "執行以下指令來停用 dhcpd: # systemctl --now disable isc-dhcp-server # systemctl --now disable isc-dhcp-server6"
    references:
      - https://www.isc.org/dhcp/
    compliance:
      - cis: ["2.2.5"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled isc-dhcp-server -> enabled"
      - "c:systemctl is-enabled isc-dhcp-server6 -> enabled"

  - id: 18561
    title: "確保 LDAP 伺服器未啟用。"
    description: "引入輕量級目錄存取協定 (LDAP) 作為 NIS/YP 的替代品。它是一種提供從中央資料庫中尋找資訊的方法的服務。"
    rationale: "如果系統不需要充當 LDAP 伺服器，建議停用該軟體以減少潛在的攻擊面。"
    remediation: "要停用 slapd，請執行以下指令： # systemctl --now disable slapd"
    compliance:
      - cis: ["2.2.6"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - https://www.openldap.org
    condition: none
    rules:
      - "c:systemctl is-enabled slapd -> enabled"

  - id: 18562
    title: "確保未啟用 NFS 和 RPC。"
    description: "網路檔案系統 (NFS) 是 UNIX 環境中最早且分佈最廣泛的檔案系統之一。它為系統提供了透過網路掛載其他伺服器的檔案系統的能力。"
    rationale: "如果系統不匯出NFS共用或充當NFS客戶端，建議停用這些服務以減少遠端攻擊面。"
    remediation: "執行以下指令以禁用nfs和rpcbind: # systemctl --now disable nfs-server # systemctl --now disable rpcbind"
    compliance:
      - cis: ["2.2.7"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled nfs-server -> enabled"
      - "c:systemctl is-enabled rpcbind -> enabled"

  - id: 18563
    title: "確保 DNS 伺服器未啟用。"
    description: "網域名稱系統 (DNS) 是一種分層命名系統，它將名稱對應到連接到網路的電腦、服務和其他資源的 IP 位址。"
    rationale: "除非專門指定系統充當 DNS 伺服器，否則建議刪除該軟體包以減少潛在的攻擊面。"
    remediation: "執行以下指令來停用named: # systemctl --now disable bind9"
    compliance:
      - cis: ["2.2.8"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled bind9 -> enabled"

  - id: 18564
    title: "確保 FTP 伺服器未啟用。"
    description: "檔案傳輸協定 (FTP) 為聯網電腦提供了傳輸檔案的能力。"
    rationale: "FTP 不保護資料或身分驗證憑證的機密性。如果需要傳輸檔案，建議使用sftp。除非需要將系統作為FTP伺服器運行（例如，允許匿名下載），否則建議刪除該軟體包以減少潛在的攻擊面。"
    remediation: "運行以下指令來停用 vsftpd: # systemctl --now disable vsftpd"
    compliance:
      - cis: ["2.2.9"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled vsftpd -> enabled"

  - id: 18565
    title: "確保 HTTP 伺服器未啟用。"
    description: "HTTP 或 Web 伺服器提供託管網站內容的能力。"
    rationale: "除非需要將系統作為Web伺服器運行，否則建議刪除該軟體包以減少潛在的攻擊面。"
    remediation: "執行以下指令來停用 apache2: # systemctl --now disable apache2"
    compliance:
      - cis: ["2.2.10"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled apache2 -> enabled"

  - id: 18566
    title: "確保電子郵件服務未啟用。"
    description: "dovecot 是一個基於 Linux 系統的開源郵件提交和傳輸伺服器。"
    rationale: "除非該系統要提供郵件傳輸服務，否則建議停用或刪除該服務以減少潛在的攻擊面。"
    remediation: "運行以下指令之一以禁用 dovecot ： # systemctl --now disable dovecot"
    compliance:
      - cis: ["2.2.11"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled dovecot -> enabled"

  - id: 18567
    title: "確保 Samba 未啟用。"
    description: "Samba 守護程序可讓系統管理員將其 Linux 系統設定為與 Windows 桌面共用檔案系統和目錄。 Samba 將透過小消息區塊 (SMB) 協定通告檔案系統和目錄。 Windows 桌面用戶將能夠將這些目錄和檔案系統作為磁碟機安裝在其系統上。"
    rationale: "如果不需要將目錄和檔案系統掛載到Windows系統上，那麼可以刪除這個服務，以減少潛在的攻擊面。"
    remediation: "執行以下指令以停用 smbd：# systemctl --now disable smbd"
    compliance:
      - cis: ["2.2.12"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled smbd -> enabled"

  - id: 18568
    title: "確保未啟用 HTTP 代理伺服器。"
    description: "Squid 是許多發行版和環境中使用的標準代理伺服器。"
    rationale: "如果不需要代理伺服器，建議刪除squid代理，以減少潛在的攻擊面。"
    remediation: "執行以下指令來停用 squid: # systemctl --now disable squid"
    compliance:
      - cis: ["2.2.13"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled squid -> enabled"

  - id: 18569
    title: "確保 SNMP 伺服器未啟用。"
    description: "簡單網路管理協定（SNMP）伺服器用於偵聽來自 SNMP 管理系統的 SNMP 指令，執行指令或收集訊息，然後將結果傳回請求系統。"
    rationale: "SNMP 伺服器可以使用 SNMP v1 進行通訊，該協定以明文方式傳輸資料，並且不需要身份驗證即可執行指令。除非絕對必要，建議不要使用 SNMP 服務。如果需要 SNMP，則應將伺服器設定為不允許 SNMP v1。"
    remediation: "執行以下指令以停用 snmpd: # systemctl --now disable snmpd"
    compliance:
      - cis: ["2.2.14"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled snmpd -> enabled"

  - id: 18570
    title: "確保郵件傳輸代理程式配置為僅本機模式。"
    description: "郵件傳輸代理程式 (MTA)，例如 sendmail 和 Postfix，用於偵聽傳入郵件並將訊息傳送到適當的使用者或郵件伺服器。如果系統不打算用作郵件伺服器，建議將 MTA 設定為僅處理本機郵件。"
    rationale: "所有郵件傳輸代理程式的軟體都很複雜，而且大多數都存在長期的安全性問題。雖然確保系統可以處理本地郵件訊息很重要，但沒有必要讓 MTA 的守護程序偵聽端口，除非伺服器打算成為接收和處理來自其他系統的郵件的郵件伺服器。"
    remediation: "編輯 /etc/postfix/main.cf 並將以下行添加到接收郵件部分。如果這行已經存在，將其更改為如下所示：   inet_interfaces = loopback-only   重新啟動 postfix：    # systemctl restart postfix"
    compliance:
      - cis: ["2.2.15"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1", "AC.4", "SC.7"]
      - tsc: ["CC5.2", "CC6.4", "CC6.6", "CC6.7"]
    condition: none
    rules:
      - 'c:ss -lntu -> r:\.*:25\.*LISTEN && !r:127.0.0.1:25\.+LISTEN|::1:25\.*LISTEN'

  - id: 18571
    title: "確保 rsync 服務未啟用。"
    description: "rsyncd 服務可用於透過網路連結在系統之間同步檔案。"
    rationale: "rsyncd 服務有安全風險，因為它使用未加密的協定進行通訊。"
    remediation: "請執行以下指令來停用 rsync: # systemctl --now disable rsync"
    compliance:
      - cis: ["2.2.16"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - "c:systemctl is-enabled rsync -> enabled"

  - id: 18572
    title: "確保 NIS 伺服器未啟用。"
    description: "網路資訊服務 (NIS)（以前稱為黃頁）是一種用於分發系統設定檔的用戶端伺服器目錄服務協定。 NIS 伺服器是允許分發設定檔的程式的集合。"
    rationale: "NIS 服務本質上是一個不安全的系統，容易受到 DOS 攻擊、緩衝區溢出，並且查詢 NIS 映射的身份驗證很差。 NIS 通常被輕量級目錄存取協定 (LDAP) 等協定所取代。建議停用該服務並使用其他更安全的服務"
    remediation: "要執行以下指令來停用NIS：# systemctl --now disable nis"
    compliance:
      - cis: ["2.2.17"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:systemctl is-enabled nis -> enabled"

  - id: 18573
    title: "確保未安裝 NIS 用戶端。"
    description: "網路資訊服務 (NIS)，以前稱為黃頁，是一種用於分發系統設定檔的用戶端伺服器目錄服務協定。"
    rationale: "NIS 服務本質上是一個不安全的系統，容易受到 DOS 攻擊、緩衝區溢出，並且查詢 NIS 映射的身份驗證很差。 NIS 通常已被輕量級目錄存取協定 (LDAP) 等協定所取代。建議刪除該服務。"
    remediation: "卸載 nis：apt purge nis"
    compliance:
      - cis: ["2.3.1"]
      - cis_csc: ["2.6"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:dpkg -s nis -> r:install ok installed"

  - id: 18574
    title: "確保未安裝 rsh 用戶端。"
    description: "rsh-client 軟體包包含 rsh 服務的客戶端指令。"
    rationale: "這些舊版客戶端存在大量安全漏洞，已被更安全的 SSH 軟體包取代。即使伺服器被刪除，最好也確保客戶端也被刪除，以防止使用者無意中嘗試使用這些指令並因此暴露其憑證。請注意，刪除 rsh 軟體包會刪除 rsh 、 rcp 和 rlogin 的客戶端。"
    remediation: "卸載 rsh : apt remove rsh-client"
    compliance:
      - cis: ["2.3.2"]
      - cis_csc: ["4.5"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:dpkg -s rsh-client -> r:install ok installed"

  - id: 18575
    title: "確保未安裝談話客戶端。"
    description: "此談話軟體使用戶可以透過終端會話跨系統發送和接收訊息。預設會安裝talkclient，它允許初始化通話會話。"
    rationale: "該軟體存在安全風險，因為它使用未加密的協定進行通訊。"
    remediation: "卸載 talk : apt remove talk"
    compliance:
      - cis: ["2.3.3"]
      - cis_csc: ["2.6"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:dpkg -s talk -> r:install ok installed"

  - id: 18576
    title: "確保未安裝 telnet 用戶端。"
    description: "telnet 軟體包包含 telnet 用戶端，它允許使用者透過 telnet 協定啟動與其他系統的連線。"
    rationale: "telnet 協定不安全且未加密。使用未加密的傳輸媒體可能會導致未經授權的使用者竊取憑證。 ssh 軟體包提供加密會話和更強的安全性，並包含在大多數 Linux 發行版中。"
    remediation: "卸載 telnet ：# apt purge telnet"
    compliance:
      - cis: ["2.3.4"]
      - cis_csc: ["4.5"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:dpkg -s telnet -> r:install ok installed"

  - id: 18577
    title: "確保未安裝 LDAP 用戶端。"
    description: "引入輕量級目錄存取協定 (LDAP) 作為 NIS/YP 的替代品。它是一種提供從中央資料庫中尋找資訊的方法的服務。"
    rationale: "如果系統不需要充當 LDAP 用戶端，建議刪除該軟體以減少潛在的攻擊面。"
    remediation: "卸載 ldap-utils : # apt purge ldap-utils"
    compliance:
      - cis: ["2.3.5"]
      - cis_csc: ["2.6"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "c:dpkg -s ldap-utils -> r:install ok installed"

  ############################################################
  # 3 Network Configuration
  ############################################################

  ##########################################################
  # 3.1 Network Parameters
  ##########################################################
  # 3.1.1 Ensure packet redirect sending is disabled
  - id: 18578
    title: "確保資料包重新導向發送已停用。"
    description: "ICMP 重新導向用於向其他主機發送路由資訊。由於主機本身不充當路由器（在僅主機配置中），因此無需發送重新導向。"
    rationale: "攻擊者可以使用受感染的主機向其他路由器設備發送無效的 ICMP 重新導向，試圖破壞路由並讓使用者存取攻擊者設定的系統而不是有效的系統。"
    remediation: "在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中設置以下參數： net.ipv4.conf.all.send_redirects = 0 net.ipv4.conf.default.send_redirects = 0 運行以下指令來設置活動的內核參數: # sysctl -w net.ipv4.conf.all.send_redirects=0 # sysctl -w net.ipv4.conf.default.send_redirects=0 # sysctl -w net.ipv4.route.flush=1"
    compliance:
      - cis: ["3.1.1"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.conf.all.send_redirects -> r:=\s*\t*0$'
      - 'c:sysctl net.ipv4.conf.default.send_redirects -> r:=\s*\t*0$'
      - 'c:grep -Rh net\.ipv4\.conf\.all\.send_redirects /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.all.send_redirects\s*=\s*0$'
      - 'c:grep -Rh net\.ipv4\.conf\.default\.send_redirects /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.default.send_redirects\s*=\s*0$'

  # 3.1.2 Ensure IP forwarding is disabled
  - id: 18579
    title: "確保 IP 轉送已停用。"
    description: "net.ipv4.ip_forward 和 net.ipv6.conf.all.forwarding 標誌用於告訴系統是否可以轉送封包。"
    rationale: "將標誌設為 0 可確保具有多個介面的系統（例如硬代理）永遠無法轉送封包，因此永遠無法充當路由器。"
    remediation: "執行以下指令以恢復預設參數並設置活動內核參數：# grep -Els \"^\\s*net\\.ipv4\\.ip_forward\\s*=\\s*1\" /etc/sysctl.conf /etc/sysctl.d/*.conf /usr/lib/sysctl.d/*.conf /run/sysctl.d/*.conf | while read filename; do sed -ri \"s/^\\s*(net\\.ipv4\\.ip_forward\\s*)(=)(\\s*\\S+\\b).*$/# *REMOVED* \\1/\" $filename; done; sysctl -w net.ipv4.ip_forward=0; sysctl -w net.ipv4.route.flush=1 如果啟用了IPv6：執行以下指令以恢復預設參數並設置活動內核參數：# grep -Els \"^\\s*net\\.ipv6\\.conf\\.all\\.forwarding\\s*=\\s*1\" /etc/sysctl.conf /etc/sysctl.d/*.conf /usr/lib/sysctl.d/*.conf /run/sysctl.d/*.conf | while read filename; do sed -ri \"s/^\\s*(net\\.ipv6\\.conf\\.all\\.forwarding\\s*)(=)(\\s*\\S+\\b).*$/# *REMOVED* \\1/\" $filename; done; sysctl -w net.ipv6.conf.all.forwarding=0; sysctl -w net.ipv6.route.flush=1"
    compliance:
      - cis: ["3.1.2"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.ip_forward -> r:=\s*\t*0$'
      - 'c:grep -Rh net\.ipv4\.ip_forward /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.ip_forward\s*=\s*0$'
      - 'c:sysctl net.ipv6.conf.all.forwarding -> r:=\s*\t*0$'
      - 'c:grep -Rh net\.ipv6\.conf\.all\.forwarding /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv6.conf.all.forwarding\s*=\s*0$'

  #############################################################
  # 3.2 Network Parameters
  #############################################################
  # 3.2.1 Ensure source routed packets are not accepted
  - id: 18580
    title: "確保來源路由資料包不被接受。"
    description: "在網路中，來源路由允許發送者部分或完全指定資料包通過網路的路由。相反，非來源路由資料包沿著網路中的路由器確定的路徑行進。在某些情況下，系統可能無法從某些位置路由或存取（例如私人位址與網際網路可路由），因此需要使用來源路由封包。"
    rationale: "將net.ipv4.conf.all.accept_source_route、net.ipv4.conf.default.accept_source_route、net.ipv6.conf.all.accept_source_route 和net.ipv6.conf.default.accept_source_route 設定為0 將禁止系統接受來源路由資料包。假設該系統能夠將封包路由到一個介面上的 Internet 可路由位址和另一介面上的專用位址。假設私有位址不可路由至網際網路可路由位址，反之亦然。在正常路由情況下，來自 Internet 的可路由位址系統的攻擊者無法利用該系統作為到達專用位址系統的路徑。然而，如果允許來源路由資料包，則可以使用它們來存取專用位址系統，因為可以指定路由，而不是依賴不允許此路由的路由協定。"
    remediation: "在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中設置以下參數: net.ipv4.conf.all.accept_source_route = 0 net.ipv4.conf.default.accept_source_route = 0 net.ipv6.conf.all.accept_source_route = 0 net.ipv6.conf.default.accept_source_route = 0 || 執行以下指令以設定活動的內核參數: # sysctl -w net.ipv4.conf.all.accept_source_route=0 # sysctl -w net.ipv4.conf.default.accept_source_route=0 # sysctl -w net.ipv4.route.flush=1 # sysctl -w net.ipv6.conf.all.accept_source_route=0 # sysctl -w net.ipv6.conf.default.accept_source_route=0 # sysctl -w net.ipv6.route.flush=1"
    compliance:
      - cis: ["3.2.1"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.conf.all.accept_source_route -> r:=\s*\t*0$'
      - 'c:sysctl net.ipv4.conf.default.accept_source_route -> r:=\s*\t*0$'
      - 'c:grep -Rh net\.ipv4\.conf\.all\.accept_source_route /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.all.accept_source_route\s*=\s*0$'
      - 'c:grep -Rh net\.ipv4\.conf\.default\.accept_source_route /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.default.accept_source_route\s*=\s*0$'
      - 'c:sysctl net.ipv6.conf.all.accept_source_route -> r:=\s*\t*0$'
      - 'c:sysctl net.ipv6.conf.default.accept_source_route -> r:=\s*\t*0$'
      - 'c:grep -Rh net\.ipv6\.conf\.all\.accept_source_route /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv6.conf.all.accept_source_route\s*=\s*0$'
      - 'c:grep -Rh net\.ipv6\.conf\.default\.accept_source_route /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv6.conf.default.accept_source_route\s*=\s*0$'

  # 3.2.2 Ensure ICMP redirects are not accepted
  - id: 18581
    title: "確保不接受 ICMP 重新導向。"
    description: "ICMP 重新導向訊息是傳送路由資訊並告訴主機（充當路由器）透過備用路徑發送封包的封包。這是一種允許外部路由設備更新系統路由表的方法。透過將 net.ipv4.conf.all.accept_redirects 設為 0，系統將不會接受任何 ICMP 重新導向訊息，因此不會允許外部人員更新系統的路由表。"
    rationale: "攻擊者可以使用偽造的 ICMP 重新導向訊息來惡意更改系統路由表，並使他們將資料包發送到不正確的網路，從而允許捕獲您的系統資料包。"
    remediation: "在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中設定以下參數: net.ipv4.conf.all.accept_redirects = 0 net.ipv4.conf.default.accept_redirects = 0 執行以下指令來設置活動內核參數: # sysctl -w net.ipv4.conf.all.accept_redirects=0 # sysctl -w net.ipv4.conf.default.accept_redirects=0 # sysctl -w net.ipv4.route.flush=1  # sysctl -w net.ipv6.conf.all.accept_redirects=0 # sysctl -w net.ipv6.conf.default.accept_redirects=0 # sysctl -w net.ipv6.route.flush=1"
    compliance:
      - cis: ["3.2.2"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.conf.all.accept_redirects -> r:=\s*\t*0$'
      - 'c:sysctl net.ipv4.conf.default.accept_redirects -> r:=\s*\t*0$'
      - 'c:grep -Rh net\.ipv4\.conf\.all\.accept_redirects /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.all.accept_redirects\s*=\s*0$'
      - 'c:grep -Rh net\.ipv4\.conf\.default\.accept_redirects /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.default.accept_redirects\s*=\s*0$'
      - 'c:sysctl net.ipv6.conf.all.accept_redirects -> r:=\s*\t*0$'
      - 'c:sysctl net.ipv6.conf.default.accept_redirects -> r:=\s*\t*0$'
      - 'c:grep -Rh net\.ipv6\.conf\.all\.accept_redirects /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv6.conf.all.accept_redirects\s*=\s*0$'
      - 'c:grep -Rh net\.ipv6\.conf\.default\.accept_redirects /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv6.conf.default.accept_redirects\s*=\s*0$'

  # 3.2.3 Ensure secure ICMP redirects are not accepted
  - id: 18582
    title: "確保不接受安全 ICMP 重新導向。"
    description: "安全性 ICMP 重新導向與 ICMP 重新導向相同，只不過它們來自預設閘道器清單中列出的閘道器。假設您的系統已知這些閘道器，並且它們可能是安全的。"
    rationale: "即使是已知的閘道器也仍然有可能受到損害。將 net.ipv4.conf.all.secure_redirects 設定為 0 可保護系統免受可能受損的已知閘道器更新路由表的影響。"
    remediation: "在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中設置以下參數：net.ipv4.conf.all.secure_redirects = 0 net.ipv4.conf.default.secure_redirects = 0。運行以下指令來設置活動的內核參數：# sysctl -w net.ipv4.conf.all.secure_redirects=0 # sysctl -w net.ipv4.conf.default.secure_redirects=0 # sysctl -w net.ipv4.route.flush=1"
    compliance:
      - cis: ["3.2.3"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.conf.all.secure_redirects -> r:=\s*\t*0$'
      - 'c:sysctl net.ipv4.conf.default.secure_redirects -> r:=\s*\t*0$'
      - 'c:grep -Rh net\.ipv4\.conf\.all\.secure_redirects /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.all.secure_redirects\s*=\s*0$'
      - 'c:grep -Rh net\.ipv4\.conf\.default\.secure_redirects /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.default.secure_redirects\s*=\s*0$'

  # 3.2.4 Ensure suspicious packets are logged (Scored)
  - id: 18583
    title: "確保記錄可疑資料包。"
    description: "啟用後，此功能會將具有不可路由來源位址的資料包記錄到核心日誌中。"
    rationale: "啟用此功能並記錄這些資料包允許管理員調查攻擊者向其伺服器發送欺騙資料包的可能性。"
    remediation: "將以下參數設定在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中: net.ipv4.conf.all.log_martians = 1 net.ipv4.conf.default.log_martians = 1。執行以下指令來設定即時的內核參數: # sysctl -w net.ipv4.conf.all.log_martians=1 # sysctl -w net.ipv4.conf.default.log_martians=1 # sysctl -w net.ipv4.route.flush=1"
    compliance:
      - cis: ["3.2.4"]
      - cis_csc: ["6.2", "6.3"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.conf.all.log_martians -> r:=\s*\t*1$'
      - 'c:sysctl net.ipv4.conf.default.log_martians -> r:=\s*\t*1$'
      - 'c:grep -Rh net\.ipv4\.conf\.all\.log_martians /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.all.log_martians\s*=\s*1$'
      - 'c:grep -Rh net\.ipv4\.conf\.default\.log_martians /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.default.log_martians\s*=\s*1$'

  # 3.2.5 Ensure broadcast ICMP requests are ignored
  - id: 18584
    title: "確保廣播 ICMP 請求被忽略。"
    description: "將 net.ipv4.icmp_echo_ignore_broadcasts 設為 1 將導致系統忽略對廣播和多播位址的所有 ICMP 回顯和時間戳請求。"
    rationale: "接受具有網路廣播或多播目標的 ICMP 回顯和時間戳請求可用於欺騙您的主機開始（或參與）Smurf 攻擊。 Smurf 攻擊依賴攻擊者使用欺騙性來源位址發送大量 ICMP 廣播訊息。所有接收此訊息並回應的主機都會將回顯應答訊息傳送回欺騙位址，該位址可能無法路由。如果許多主機回應資料包，網路上的流量可能會顯著增加。"
    remediation: "將以下參數設置在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中: net.ipv4.icmp_echo_ignore_broadcasts = 1。運行以下指令以設置活動內核參數: # sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1 # sysctl -w net.ipv4.route.flush=1"
    compliance:
      - cis: ["3.2.5"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.icmp_echo_ignore_broadcasts -> r:=\s*\t*1$'
      - 'c:grep -Rh net\.ipv4\.icmp_echo_ignore_broadcasts /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.icmp_echo_ignore_broadcasts\s*=\s*1$'

  # 3.2.6 Ensure bogus ICMP responses are ignored (Scored)
  - id: 18585
    title: "確保忽略偽造的 ICMP 回應。"
    description: "將 icmp_ignore_bogus_error_responses 設為 1 可防止核心記錄來自廣播重新訊框的虛假回應（不符合 RFC-1122），從而防止檔案系統填滿無用的日誌訊息。"
    rationale: "一些路由器（和一些攻擊者）將發送違反 RFC-1122 的回應，並嘗試用許多無用的錯誤訊息填充日誌檔案系統。"
    remediation: "在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中設置以下參數: net.ipv4.icmp_ignore_bogus_error_responses = 1. 執行以下指令以設置活動的內核參數: # sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=1 # sysctl -w net.ipv4.route.flush=1"
    compliance:
      - cis: ["3.2.6"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.icmp_ignore_bogus_error_responses -> r:=\s*\t*1$'
      - 'c:grep -Rh net\.ipv4\.icmp_ignore_bogus_error_responses /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.icmp_ignore_bogus_error_responses\s*=\s*1$'

  # 3.2.7 Ensure Reverse Path Filtering is enabled (Scored)
  - id: 18586
    title: "確保啟用反向路徑過濾。"
    description: "將 net.ipv4.conf.all.rp_filter 和 net.ipv4.conf.default.rp_filter 設為 1 會強制 Linux 核心對收到的封包使用反向路徑過濾來確定封包是否有效。本質上，透過反向路徑過濾，如果傳回封包沒有從對應來源封包來自的相同介面發出，則封包將被丟棄（如果設定了 log_martians，則會被記錄）。"
    rationale: "設定這些標誌是阻止攻擊者向您的系統發送無法回應的偽造資料包的好方法。此功能失效的一個例子是採用非對稱路由。在系統上使用動態路由協定（bgp、ospf 等）時會發生這種情況。如果您在系統上使用非對稱路由，則在不破壞路由的情況下將無法啟用此功能。"
    remediation: "在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中設置以下參數: net.ipv4.conf.all.rp_filter = 1 net.ipv4.conf.default.rp_filter = 1。執行以下指令以設置活動內核參數: # sysctl -w net.ipv4.conf.all.rp_filter=1 # sysctl -w net.ipv4.conf.default.rp_filter=1 # sysctl -w net.ipv4.route.flush=1"
    compliance:
      - cis: ["3.2.7"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.conf.all.rp_filter -> r:=\s*\t*1$'
      - 'c:sysctl net.ipv4.conf.default.rp_filter -> r:=\s*\t*1$'
      - 'c:grep -Rh net\.ipv4\.conf\.all\.rp_filter /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.all.rp_filter\s*=\s*1$'
      - 'c:grep -Rh net\.ipv4\.conf\.default\.rp_filter /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.conf.default.rp_filter\s*=\s*1$'

  # 3.2.8 Ensure TCP SYN Cookies is enabled (Scored)
  - id: 18587
    title: "確保 TCP SYN Cookie 已啟用。"
    description: "當設定 tcp_syncookies 時，核心將正常處理 TCP SYN 封包，直到半開連線佇列已滿，此時 SYN cookie 功能啟動。相反，核心只是用 SYN|ACK 回覆 SYN，但會包含一個特製的 TCP 序號，該序號對來源和目標 IP 位址以及連接埠號碼以及封包發送時間進行編碼。合法連線將發送帶有特製序號的三向握手的 ACK 資料包。這允許系統驗證它是否已收到對 SYN cookie 的有效回應並允許連接，即使佇列中沒有相應的 SYN。"
    rationale: "攻擊者使用 SYN Flood 攻擊，透過發送大量 SYN 封包而不完成三向握手來對系統執行拒絕服務攻擊。這將快速耗盡核心半開連接佇列中的插槽位，並阻止合法連線成功。 SYN cookie 允許系統持續接受有效連接，即使受到拒絕服務攻擊也是如此。"
    remediation: "在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中設置以下參數: net.ipv4.tcp_syncookies = 1。執行以下指令來設置活動的內核參數: # sysctl -w net.ipv4.tcp_syncookies=1 # sysctl -w net.ipv4.route.flush=1"
    compliance:
      - cis: ["3.2.8"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv4.tcp_syncookies -> r:=\s*\t*1$'
      - 'c:grep -Rh net\.ipv4\.tcp_syncookies /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv4.tcp_syncookies\s*=\s*1$'

  # 3.3.9 Ensure IPv6 router advertisements are not accepted (Scored)
  - id: 18588
    title: "確保 IPv6 路由器通告不被接受。"
    description: "此設定禁用系統接受路由器通告的能力"
    rationale: "建議系統不要接受路由器通告，因為它們可能會被欺騙將流量路由到受感染的電腦。在系統內設定硬路由（通常是到可信任路由器的單一預設路由）可以保護系統免受不良路由的影響。"
    remediation: "將以下參數設置在 /etc/sysctl.conf 或 /etc/sysctl.d/* 檔案中: net.ipv6.conf.all.accept_ra = 0 net.ipv6.conf.default.accept_ra = 0. 執行以下指令設置活動的內核參數: # sysctl -w net.ipv6.conf.all.accept_ra=0 # sysctl -w net.ipv6.conf.default.accept_ra=0 # sysctl -w net.ipv6.route.flush=1"
    compliance:
      - cis: ["3.3.9"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sysctl net.ipv6.conf.all.accept_ra -> r:=\s*\t*0$'
      - 'c:sysctl net.ipv6.conf.default.accept_ra -> r:=\s*\t*0$'
      - 'c:grep -Rh net\.ipv6\.conf\.all\.accept_ra /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv6.conf.all.accept_ra\s*=\s*0$'
      - 'c:grep -Rh net\.ipv6\.conf\.default\.accept_ra /etc/sysctl.conf /etc/sysctl.d -> r:^net.ipv6.conf.default.accept_ra\s*=\s*0$'

  #####################################################################
  # 3.3 TCP Wrappers
  #####################################################################

  # 3.3.1 Ensure TCP Weappers is installed (Not Scored)
  - id: 18589
    title: "安裝 TCP 包裝器。"
    description: "TCP Wrappers 為能夠支援它的服務提供了簡單的存取清單和標準化的日誌記錄方法。過去，從 inetd 和 xinetd 調用的服務支援使用 tcp 包裝器。由於 inetd 和 xinetd 已不再使用，任何可以支援 tcp 包裝器的服務都將附加 libwrap.so 庫。"
    rationale: "TCP Wrappers 為可能沒有內建支援的服務提供了一個很好的簡單存取清單機制。"
    remediation: "安裝 tcpd ： # apt-get install tcpd 要驗證某個服務是否支援 TCP Wrappers，請執行以下指令： # ldd <path-to-daemon> | grep libwrap.so 如果有任何輸出，那麼該服務支援 TCP Wrappers。"
    compliance:
      - cis: ["3.4.1"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.3.5"]
    condition: all
    rules:
      - "c:dpkg -s tcpd -> r:install ok installed"

  - id: 18590
    title: "確保 /etc/hosts.allow 已配置。"
    description: "/etc/hosts.allow 檔案指定允許哪些 IP 位址連接到主機。它旨在與 /etc/hosts.deny 檔案結合使用。"
    rationale: "/etc/hosts.allow 檔案支援 IP 存取控制，有助於確保只有授權的系統才能連接到系統。"
    remediation: '執行以下指令來建立 /etc/hosts.allow: # echo "ALL: <net>/<mask>, <net>/<mask>, ..." >/etc/hosts.allow。 每個 <net>/<mask> 組合（例如 "192.168.1.0/255.255.255.0"）代表一個需要存取此系統的組織所使用的網路區塊。'
    compliance:
      - cis: ["3.3.2"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.3.5"]
    condition: all
    rules:
      - "f:/etc/hosts.allow"

  - id: 18591
    title: "確保 /etc/hosts.deny 已設定。"
    description: "/etc/hosts.deny 檔案指定不允許哪些 IP 位址連接到主機。它旨在與 /etc/hosts.allow 檔案結合使用。"
    rationale: "/etc/hosts.deny 檔案用作故障保護，以便拒絕 /etc/hosts.allow 中未指定的任何主機存取伺服器。"
    remediation: '運行以下指令來創建 /etc/hosts.deny: # echo "ALL: ALL" >> /etc/hosts.deny'
    compliance:
      - cis: ["3.3.3"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.3.5"]
    condition: all
    rules:
      - "f:/etc/hosts.deny"
      - 'f:/etc/hosts.deny -> r:^ALL:\s*ALL'

  - id: 18592
    title: "驗證 /etc/hosts.allow 上的權限是否已配置。"
    description: "/etc/hosts.allow 檔案包含許多系統應用程式使用的網路訊息，因此必須可讀，這些應用程式才能運行。"
    rationale: "確保 /etc/hosts.allow 檔案免受未經授權的寫入存取至關重要。儘管預設情況下它受到保護，但檔案權限可能會被無意或透過惡意操作更改。"
    remediation: "執行以下指令來設置 /etc/hosts.allow 的權限:  # chown root:root /etc/hosts.allow  # chmod 644 /etc/hosts.allow"
    compliance:
      - cis: ["3.3.4"]
      - cis_csc: ["5.1"]
      - pci_dss: ["1.3.5"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/hosts.allow -> r:^Access: \(0644/-rw-r--r--\)\s*\t*Uid:\s*\t*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\t*\(\s*\t*0/\s*\t*root\)$'

  - id: 18593
    title: "驗證 /etc/hosts.deny 上的權限是否已配置。"
    description: "/etc/hosts.deny 檔案包含許多系統應用程式使用的網路訊息，因此必須可讀，這些應用程式才能運作。"
    rationale: "確保 /etc/hosts.deny 檔案免受未經授權的寫入存取至關重要。儘管預設情況下它受到保護，但檔案權限可能會被無意或透過惡意操作更改。"
    remediation: "執行以下指令來設定 /etc/hosts.deny 的權限 : # chown root:root /etc/hosts.deny  # chmod 644 /etc/hosts.deny"
    compliance:
      - cis: ["3.3.5"]
      - cis_csc: ["5.1"]
      - pci_dss: ["1.3.5"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/hosts.deny -> r:^Access: \(0644/-rw-r--r--\)\s*\t*Uid:\s*\t*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\t*\(\s*\t*0/\s*\t*root\)$'

  #####################################################################
  # 3.4 Uncommon Network Protocols
  #####################################################################
  # 3.4.1 Ensure DCCP is disabled (Scored)
  - id: 18594
    title: "確保 DCCP 已停用。"
    description: "資料封包擁塞控制協定 (DCCP) 是支援串流媒體和電話的傳輸層協定。 DCCP 提供了一種無需在應用層執行擁塞控制的方法，但不提供按順序傳送。"
    rationale: "如果不需要該協定，建議不要安裝驅動程式，以減少潛在的攻擊面。"
    remediation: "編輯或建立 /etc/modprobe.d/ 目錄中以 .conf 結尾的檔案 範例: vim /etc/modprobe.d/dccp.conf 並新增以下行: install dccp /bin/true"
    compliance:
      - cis: ["3.4.1"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "not c:modprobe -n -v dccp -> r:install /bin/true"
      - "c:lsmod -> r:dccp"

  # 3.4.2 Ensure SCTP is disabled (Scored)
  - id: 18595
    title: "確保 SCTP 已停用。"
    description: "流控制傳輸協定 (SCTP) 是一種傳輸層協定，用於支援面向訊息的通訊，在一個連接中具有多個訊息流。它的功能與 TCP 和 UDP 類似，融合了兩者的功能。它像UDP一樣是面向訊息的，並且像TCP一樣透過擁塞控制確保訊息的可靠的順序傳輸。"
    rationale: "如果協定沒有被使用，建議不要載入核心模組，停用該服務以減少潛在的攻擊面。"
    remediation: "編輯或建立 /etc/modprobe.d/ 目錄下以 .conf 結尾的檔案 例如: vim /etc/modprobe.d/sctp.conf 並添加以下行: install sctp /bin/true"
    compliance:
      - cis: ["3.4.2"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "not c:modprobe -n -v sctp -> r:install /bin/true"
      - "c:lsmod -> r:sctp"

  # 3.4.3 Ensure RDS is disabled (Scored)
  - id: 18596
    title: "確保 RDS 已停用。"
    description: "可靠資料報套接字 (RDS) 協定是一種傳輸層協定，旨在在叢集節點之間提供低延遲、高頻寬通訊。它是由 Oracle 公司開發的。"
    rationale: "如果協定沒有被使用，建議不要載入核心模組，停用該服務以減少潛在的攻擊面。"
    remediation: "編輯或創建 /etc/modprobe.d/ 目錄中以 .conf 結尾的檔案 範例: vim /etc/modprobe.d/rds.conf 並添加以下行: install rds /bin/true"
    compliance:
      - cis: ["3.4.3"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "not c:modprobe -n -v rds -> r:install /bin/true"
      - "c:lsmod -> r:rds"

  # 3.4.4 Ensure TIPC is disabled (Scored)
  - id: 18597
    title: "確保 TIPC 已停用。"
    description: "透明程序間通訊 (TIPC) 協定旨在提供叢集節點之間的通訊。"
    rationale: "如果協定沒有被使用，建議不要載入核心模組，停用該服務以減少潛在的攻擊面。"
    remediation: "編輯或建立一個位於 /etc/modprobe.d/ 目錄內，名稱以 .conf 結尾的檔案。 例如：vim /etc/modprobe.d/tipc.conf 並添加以下行：install tipc /bin/true"
    compliance:
      - cis: ["3.4.4"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - "not c:modprobe -n -v tipc -> r:install /bin/true"
      - "c:lsmod -> r:tipc"

  #################################################################
  # 3.5 Firewall configuration
  #################################################################
  #################################################################
  # 3.5.1 Ensure Firewall software is installed
  #################################################################
  # 3.5.1.1 Ensure a Firewall package is installed (Scored)
  - id: 18598
    title: "確保安裝了防火牆軟體包。"
    description: "應選擇防火牆包。大多數防火牆配置實用程式作為 nftables 或 iptables 的前端運作。"
    rationale: "防火牆管理和設定需要防火牆軟體套件。"
    remediation: "運行以下其中一個指令來安裝符合本地站點政策的防火牆套件: 要安裝 UFW，運行以下指令: # apt install ufw 要安裝 nftables，運行以下指令: # apt install nftables 要安裝 iptables，運行以下指令: # apt install iptables"
    compliance:
      - cis: ["3.5.1.1"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.1"]
      - tsc: ["CC6.6"]
    condition: any
    rules:
      - "c:dpkg -s ufw -> r:Status: install ok installed"
      - "c:dpkg -s nftables -> r:Status: install ok installed"
      - "c:dpkg -s iptables -> r:Status: install ok installed"
  #################################################################
  # 3.5.2 Configure UncomplicatedFirewall
  #################################################################
  # 3.5.2.1 Ensure ufw service is enabled (Scored)
  - id: 18599
    title: "確保 ufw 服務已啟用。"
    description: "UncomplicatedFirewall (ufw) 是 iptables 的前端。 ufw 提供了一個用於管理 netfilter 的框架，以及用於操作防火牆的指令列和可用的圖形使用者介面。確保啟用 ufw 服務以保護您的系統。"
    rationale: "必須啟用並運行 ufw 服務，ufw 才能保護系統"
    remediation: "請執行以下指令來啟用 ufw: # ufw enable"
    compliance:
      - cis: ["3.5.2.1"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2.1"]
      - tsc: ["CC8.1"]
    reference:
      - "http://manpages.ubuntu.com/manpages/precise/en/man8/ufw.8.html"
    condition: all
    rules:
      - "c:systemctl is-enabled ufw -> enabled"
      - "c:ufw status -> Status: active"

  # 3.5.2.2 Ensure default deny firewall policy (Scored)
  - id: 18600
    title: "確保預設拒絕防火牆策略。"
    description: "預設拒絕所有連線原則可確保拒絕任何未設定的網路使用。"
    rationale: "使用預設接受策略，防火牆將接受任何未配置為拒絕的資料包。將可接受的用法列入白名單比將不可接受的用法列入黑名單更容易。"
    remediation: "執行以下指令以實施預設拒絕政策: # ufw default deny incoming # ufw default deny outgoing # ufw default deny routed"
    compliance:
      - cis: ["3.5.2.2"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2.1"]
      - tsc: ["CC8.1"]
    condition: all
    rules:
      - 'c:ufw status verbose -> r:^Default && r:deny\W+(incoming)|reject\W+(incoming)'
      - 'c:ufw status verbose -> r:^Default && r:deny\W+(outgoing)|reject\W+(outgoing)'
      - 'c:ufw status verbose -> r:^Default && r:deny\W+(routed)|reject\W+(routed)'

  # 3.5.2.3 Ensure loopback traffic is configured (Scored)
  - id: 18601
    title: "確保環回流量已配置。"
    description: "配置環回介面以接受流量。設定所有其他介面以拒絕流向環回網路的流量（對於 IPv4 為 127.0.0.0/8，對於 IPv6 為::1/128）。"
    rationale: "環回流量是在電腦上的程序之間產生的，通常對系統的運作至關重要。環回介面是環回網路流量唯一可見的地方，所有其他介面都應忽略該網路上的流量，作為反欺騙措施。"
    remediation: "運行以下指令來實現 loopback 規則： # ufw allow in on lo  # ufw deny in from 127.0.0.0/8 # ufw deny in from ::1"
    compliance:
      - cis: ["3.5.2.3"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2.1"]
      - tsc: ["CC8.1"]
    condition: all
    rules:
      - 'c:ufw status verbose -> r:Anywhere on lo\s*\t*ALLOW IN\s*\t*Anywhere'
      - 'c:ufw status verbose -> r:Anywhere\s*\t*DENY IN\s*\t*127.0.0.0/8'
      - 'c:ufw status verbose -> r:Anywhere \(v6\) on lo\s*\t*ALLOW IN\s*\t*Anywhere \(v6\)'
      - 'c:ufw status verbose -> r:Anywhere \(v6\)\s*\t*DENY IN\s*\t*::1'
      - 'c:ufw status verbose -> r:Anywhere\s*\t*ALLOW OUT\s*\t*Anywhere on lo'
      - 'c:ufw status verbose -> r:Anywhere \(v6\)\s*\t*ALLOW OUT\s*\t*Anywhere \(v6\) on lo'

  ######################################################################
  # 3.5.3 Configure nftables
  ######################################################################

  # 3.5.3.2 Ensure a table exists (Scored)
  - id: 18602
    title: "確保表存在。"
    description: "桌子上有鏈條。每個表只有一個位址族，且僅適用於該位址族的資料包。表格可以有五個系列之一。"
    rationale: "nftables 沒有任何預設表。如果沒有建置表，nftables 將不會過濾網路流量。"
    remediation: "執行以下指令來在 nftables 中建立一個表: # nft create table inet <table name>。範例: # nft create table inet filter"
    compliance:
      - cis: ["3.5.3.2"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2"]
      - tsc: ["CC6.6"]
    condition: all
    rules:
      - 'c:nft list tables -> r:\w+'

  # 3.5.3.3 Ensure base chains exist (Scored)
  - id: 18603
    title: "確保基礎鏈存在。"
    description: "鍊是規則的容器。它們以兩種形式存在：基礎鍊和常規鏈。基本鍊是來自網路堆疊的資料包的入口點，常規鏈可以用作跳轉目標並用於更好的規則組織。"
    rationale: "如果不存在帶有用於輸入、轉發和刪除的鉤子的基本鏈，則流經這些鏈的資料包將不會被 nftables 觸及。"
    remediation: "執行以下指令來建立基礎鏈：# nft create chain inet <table name> <base chain name> { type filter hook <(input|forward|output)> priority 0 \\; } 。範例：# nft create chain inet filter input { type filter hook input priority 0 \\; } # nft create chain inet filter forward { type filter hook forward priority 0\\; } # nft create chain inet filter output { type filter hook output priority 0 \\; }"
    compliance:
      - cis: ["3.5.3.3"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2"]
      - tsc: ["CC6.6"]
    condition: all
    rules:
      - "c:nft list ruleset -> r:hook input"
      - "c:nft list ruleset -> r:hook forward"
      - "c:nft list ruleset -> r:hook output"

  # 3.5.3.6 Ensure default deny firewall policy (Scored)
  - id: 18604
    title: "確保預設拒絕防火牆策略。"
    description: "基本鏈策略是將應用於到達鏈末端的資料包的預設判決。"
    rationale: "有兩種策略：接受（預設）和丟棄。如果政策設定為接受，防火牆將接受任何未配置為拒絕的資料包，並且資料包將繼續穿越網路堆疊。將可接受的用法列入白名單比將不可接受的用法列入黑名單更容易。"
    remediation: "執行以下指令，對基鏈設置輸入、轉發和輸出掛鉤來實現預設的DROP策略：# nft chain <table family> <table name> <chain name> { policy drop \\; } 。 例如：# nft chain inet filter input { policy drop \\; } ; # nft chain inet filter forward { policy drop \\; } 以及 # nft chain inet filter output { policy drop \\; }"
    compliance:
      - cis: ["3.5.3.6"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2.1"]
      - tsc: ["CC6.6"]
    condition: all
    rules:
      - "c:nft list ruleset -> r:hook input && r:policy drop"
      - "c:nft list ruleset -> r:hook forward && r:policy drop"
      - "c:nft list ruleset -> r:hook output && r:policy drop"

  # 3.5.3.7 Ensure nftables service is enabled (Scored)
  - id: 18605
    title: "確保 nftables 服務已啟用。"
    description: "nftables 服務允許在引導或啟動 nftables 服務期間載入 nftables 規則集。"
    rationale: "nftables 服務在引導或 nftables 服務啟動期間從 /etc/sysconfig/nftables.conf 檔案中引用的規則檔案還原 nftables 規則。"
    remediation: "執行以下指令來啟用 nftables 服務：# systemctl enable nftables"
    compliance:
      - cis: ["3.5.3.7"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2"]
      - tsc: ["CC6.6"]
    condition: all
    rules:
      - "c:systemctl is-enabled nftables -> enabled"

  #######################################################################
  # 3.5.4 Configure iptables
  #######################################################################
  #######################################################################
  # 3.5.4.1 Configure IPv4 iptables
  #######################################################################
  # 3.5.4.1.1 Ensure default deny firewall policy (Scored)
  - id: 18606
    title: "確保預設拒絕防火牆策略。"
    description: "預設拒絕所有連線原則可確保拒絕任何未設定的網路使用。"
    rationale: "使用預設接受策略，防火牆將接受任何未配置為拒絕的資料包。將可接受的用法列入白名單比將不可接受的用法列入黑名單更容易。"
    remediation: "執行以下指令來設定預設的 DROP 政策： # iptables -P INPUT DROP; # iptables -P OUTPUT DROP; # iptables -P FORWARD DROP"
    compliance:
      - cis: ["3.5.4.1.1"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2.1"]
      - tsc: ["CC6.6"]
    condition: all
    rules:
      - 'c:iptables -L -> r:Chain INPUT \(policy DROP\)|Chain INPUT \(policy REJECT\)'
      - 'c:iptables -L -> r:Chain FORWARD \(policy DROP\)|Chain FORWARD \(policy REJECT\)'
      - 'c:iptables -L -> r:Chain OUTPUT \(policy DROP\)|Chain OUTPUT \(policy REJECT\)'

  # 3.5.4.1.2 Ensure loopback traffic is configured (Scored)
  - id: 18607
    title: "確保環回流量已配置。"
    description: "配置環回介面以接受流量。設定所有其他介面以拒絕流向環回網路 (127.0.0.0/8) 的流量。"
    rationale: "環回流量是在電腦上的程序之間產生的，通常對系統的運作至關重要。環回介面是唯一可以看到環回網路 (127.0.0.0/8) 流量的地方，所有其他介面都應忽略該網路上的流量，作為反欺騙措施。"
    remediation: "執行以下指令以實施回環規則: # iptables -A INPUT -i lo -j ACCEPT # iptables -A OUTPUT -o lo -j ACCEPT # iptables -A INPUT -s 127.0.0.0/8 -j DROP"
    compliance:
      - cis: ["3.5.4.1.2"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2.1"]
      - tsc: ["CC6.6"]
    condition: all
    rules:
      - 'c:iptables -L INPUT -v -n -> r:\.*ACCEPT\.*all\.*lo\.**\.*0.0.0.0/0\.*0.0.0.0/0'
      - 'c:iptables -L INPUT -v -n -> r:\.*DROP\.*all\.**\.**\.*127.0.0.0/8\.*0.0.0.0/0'
      - 'c:iptables -L OUTPUT -v -n -> r:\.*ACCEPT\.*all\.**\.*lo\.*0.0.0.0/0\.*0.0.0.0/0'

  #########################################################################
  # 3.5.4.2 Configure IPv6 ip6tables
  #########################################################################
  # 3.5.4.2.1 Ensure IPv6 default deny firewall policy (Scored)
  - id: 18608
    title: "確保 IPv6 預設拒絕防火牆政策。"
    description: "預設拒絕所有連線原則可確保拒絕任何未設定的網路使用。"
    rationale: "使用預設接受策略，防火牆將接受任何未配置為拒絕的資料包。將可接受的用法列入白名單比將不可接受的用法列入黑名單更容易。"
    remediation: "執行以下指令以實現預設 DROP 策略：# ip6tables -P INPUT DROP # ip6tables -P OUTPUT DROP # ip6tables -P FORWARD DROP。注意：在網路連接情況下更改防火牆設定可能會導致系統被鎖定。補救措施只會影響當前系統的防火牆，請確保在防火牆管理中設置在啟動時也應用的預設策略。"
    compliance:
      - cis: ["3.5.4.2.1"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2.1"]
      - tsc: ["CC8.1"]
    condition: all
    rules:
      - "c:ip6tables -L -> r:^Chain INPUT && r:policy DROP"
      - "c:ip6tables -L -> r:^Chain FORWARD && r:policy DROP"
      - "c:ip6tables -L -> r:^Chain OUTPUT && r:policy DROP"

  # 3.5.4.2.2 Ensure IPv6 loopback traffic is configured (Scored)
  - id: 18609
    title: "確保配置了 IPv6 環回流量。"
    description: "配置環回介面以接受流量。設定所有其他介面以拒絕流向環回網路 (::1) 的流量。"
    rationale: "環回流量是在電腦上的程序之間產生的，通常對系統的運作至關重要。環回介面是唯一可以看到環回網路 (::1) 流量的地方，所有其他介面都應忽略該網路上的流量，作為反欺騙措施。"
    remediation: "執行以下指令以實現回環規則: # ip6tables -A INPUT -i lo -j ACCEPT # ip6tables -A OUTPUT -o lo -j ACCEPT # ip6tables -A INPUT -s ::1 -j DROP"
    compliance:
      - cis: ["3.5.4.2.2"]
      - cis_csc: ["9.4"]
      - pci_dss: ["1.2.1"]
      - tsc: ["CC8.1"]
    condition: all
    rules:
      - 'c:ip6tables -L INPUT -v -n -> r:\.*ACCEPT\.*all\.*lo\.**\.*::/0\.*::/0'
      - 'c:ip6tables -L INPUT -v -n -> r:\.*DROP\.*all\.**\.**\.*::1\.*::/0'
      - 'c:ip6tables -L OUTPUT -v -n -> r:\.*ACCEPT\.*all\.**\.*lo\.*::/0\.*::/0'

  # 3.6 Ensure wireless interfaces are disabled (Scored)
  - id: 18610
    title: "確保無線介面已停用。"
    description: "當有線網路不可用時，使用無線網路。 Ubuntu 包含一個無線工具包，可讓系統管理員配置和使用無線網路。"
    rationale: "如果不使用無線，可以停用無線設備以減少潛在的攻擊面。"
    remediation: "運行以下指令以停用所有無線界面: # nmcli radio all off"
    compliance:
      - cis: ["3.6"]
      - cis_csc: ["15.4", "15.5"]
      - pci_dss: ["1.2.3"]
      - tsc: ["CC6.6"]
    references:
      - nmcli(1) - Linux man page
    condition: all
    rules:
      - "c:nmcli radio wifi -> r:^disabled"
      - "c:nmcli radio wwan -> r:^disabled"

  # 3.7 Disable IPv6 (Not Scored)
  - id: 18611
    title: "禁用 IPv6。"
    description: "儘管 IPv6 比 IPv4 具有許多優勢，但並非所有組織都實施 IPv6 或雙堆疊配置。"
    rationale: "如果不使用IPv6或雙堆疊，建議停用IPv6，以減少系統的攻擊面。"
    remediation: '編輯 /etc/default/grub 並將 ipv6.disable=1 添加到 GRUB_CMDLINE_LINUX 參數: GRUB_CMDLINE_LINUX="ipv6.disable=1" 運行以下指令來更新 grub2 配置: # update-grub'
    compliance:
      - cis: ["3.7"]
      - cis_csc: ["9.4"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.6", "CC5.2"]
    condition: none
    rules:
      - 'f:/boot/grub/grub.cfg -> r:^\s*\t*linux && !r:ipv6.disable=1'

  ############################################################
  # 4 Logging and Auditing
  ############################################################

  - id: 18612
    title: "確保安裝了auditd。"
    description: "auditd 是 Linux 稽核系統的使用者空間元件。它負責將審計記錄寫入磁碟"
    rationale: "系統事件的捕獲為系統管理員提供了資訊，使他們能夠確定是否正在發生對其系統的未經授權的存取。"
    remediation: "執行以下指令以啟用 auditd: # apt install auditd audispd-plugins"
    compliance:
      - cis: ["4.1.1.1"]
      - cis_csc: ["6.2", "6.3"]
      - pci_dss: ["10.1"]
      - nist_800_53: ["AU.2"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.1", "CC6.2", "CC6.3", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "c:dpkg -s auditd -> r:install ok installed"
      - "c:dpkg -s audispd-plugins -> r:install ok installed"

  - id: 18613
    title: "確保auditd服務已啟用。"
    description: "啟用並啟動auditd守護程序來記錄系統事件。"
    rationale: "系統事件的捕獲為系統管理員提供了資訊，使他們能夠確定是否正在發生對其系統的未經授權的存取。"
    remediation: "運行以下指令以啟用 auditd: # systemctl --now enable auditd"
    compliance:
      - cis: ["4.1.1.2"]
      - cis_csc: ["6.2", "6.3"]
      - pci_dss: ["10.1", "10.7"]
      - nist_800_53: ["AU.2"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.1", "CC6.2", "CC6.3", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "c:systemctl is-enabled auditd -> enabled"

  - id: 18614
    title: "確保啟用對在auditd之前啟動的程序進行審核。"
    description: "配置 grub，以便能夠審核能夠被審核的程序，即使它們在auditd 啟動之前啟動也是如此。"
    rationale: "需要在auditd之前啟動的程序上捕獲審核事件，以便潛在的惡意活動不會被偵測不到。"
    remediation: '編輯 /etc/default/grub 並將 audit=1 新增到 GRUB_CMDLINE_LINUX: GRUB_CMDLINE_LINUX="audit=1" 執行以下指令以更新 grub2 配置: # update-grub 注意: 此建議基於 grub bootloader，如果您的環境中使用的是 LILO 或其他 bootloader，請採用等效設置。'
    compliance:
      - cis: ["4.1.1.3"]
      - cis_csc: ["6.2", "6.3"]
      - pci_dss: ["10.2.6", "10.7"]
      - nist_800_53: ["AU.2"]
      - gpg_13: ["7.9"]
      - gdpr_IV: ["35.7.d", "32.2"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: none
    rules:
      - 'f:/boot/grub/grub.cfg -> r:^\s*\t*linux && !r:audit=1 && !r:/boot/memtest86+.bin'

  - id: 18615
    title: "確保配置審核日誌儲存大小。"
    description: "配置審核日誌檔案的最大大小。一旦日誌達到最大大小，它將被輪換並啟動新的日誌檔案。"
    rationale: "為日誌檔案確定適當的大小非常重要，這樣它們就不會影響系統並且審計資料也不會遺失。"
    remediation: "在 /etc/audit/auditd.conf 中根據站點政策設定以下參數：max_log_file = <MB> 注：max_log_file 參數以兆位元組計量。"
    compliance:
      - cis: ["4.1.2.1"]
      - cis_csc: ["6.4"]
      - pci_dss: ["10.7"]
      - nist_800_53: ["AU.4"]
      - hipaa: ["164.312.b"]
    condition: all
    rules:
      - "d:/etc/audit"
      - "f:/etc/audit/auditd.conf"
      - 'f:/etc/audit/auditd.conf -> r:^\s*\t*max_log_file\s*\t*=\s*\t*\d+'

  - id: 18616
    title: "確保審核日誌不會自動刪除。"
    description: "max_log_file_action 設定決定如何處理達到最大檔案大小的審核日誌檔案。 keep_logs 的值將輪換日誌，但永遠不會刪除舊日誌。"
    rationale: "在高安全性環境中，維護較長審計歷史記錄的好處超過了儲存審計歷史記錄的成本。"
    remediation: "將以下參數設置在 /etc/audit/auditd.conf: max_log_file_action = keep_logs"
    compliance:
      - cis: ["4.1.2.2"]
      - cis_csc: ["6.4"]
      - pci_dss: ["10.7"]
      - nist_800_53: ["AU.9"]
      - hipaa: ["164.312.b"]
    condition: all
    rules:
      - "d:/etc/audit"
      - "f:/etc/audit/auditd.conf"
      - 'f:/etc/audit/auditd.conf -> r:^\s*\t*max_log_file_action\s*\t*=\s*\t*keep_logs'

  - id: 18617
    title: "確保審核日誌已滿時停用系統。"
    description: "可以將auditd 守護程式設定為在審核日誌已滿時停止系統。"
    rationale: "在高安全性環境中，偵測未經授權的存取或不可否認性的風險超過了系統可用性的好處。"
    remediation: "在 /etc/audit/auditd.conf 中設置以下參數: space_left_action = email action_mail_acct = root admin_space_left_action = halt"
    compliance:
      - cis: ["4.1.2.3"]
      - cis_csc: ["6.4"]
      - pci_dss: ["10.7"]
    condition: all
    rules:
      - "d:/etc/audit"
      - "f:/etc/audit/auditd.conf"
      - 'f:/etc/audit/auditd.conf -> r:^\s*\t*action_mail_acct\s*\t*=\s*\t*root'
      - 'f:/etc/audit/auditd.conf -> r:^\s*\t*space_left_action\s*\t*=\s*\t*email'
      - 'f:/etc/audit/auditd.conf -> r:^\s*\t*admin_space_left_action\s*\t*=\s*\t*halt'

  - id: 18618
    title: "確保收集修改日期和時間資訊的事件。"
    description: '捕獲系統日期和/或時間已修改的事件。本節中的參數設定確定是否為adjtimex（調整內核時鐘）、settimeofday（設定時間，使用timeval 和時區結構）、stime（使用自1970 年1 月1 日以來的秒數）或clock_settime（允許設定多個內部時鐘）。'
    rationale: "系統日期和/或時間的意外變更可能是系統上存在惡意活動的跡象。"
    remediation: "在 32 位元系統中，編輯或創建 /etc/audit/rules.d/ 目錄中以 .rules 結尾的檔案，並添加以下行: -a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change | -a always,exit -F arch=b32 -S clock_settime -k time-change | -w /etc/localtime -p wa -k time-change。 在 64 位元系統中，編輯或創建 /etc/audit/rules.d/ 目錄中以 .rules 結尾的檔案，並添加以下行: -a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change | -a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change | -a always,exit -F arch=b64 -S clock_settime -k time-change -a always,exit -F arch=b32 -S clock_settime -k time-change | -w /etc/localtime -p wa -k time-change"
    compliance:
      - cis: ["4.1.3"]
      - cis_csc: ["5.5"]
      - pci_dss: ["10.4.2", "10.2.7"]
      - nist_800_53: ["AU.14", "AU.6"]
      - gpg_13: ["7.9"]
      - gdpr_IV: ["32.2", "35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b32 && r:-S adjtimex && r:-S settimeofday && r:-S stime && r:-k time-change'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b32 && r:-S clock_settime && r:-k time-change'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/localtime && r:-p wa && r:-k time-change'

  - id: 18619
    title: "確保收集修改使用者/群組資訊的事件。"
    description: '記錄影響 group 、 passwd （使用者 ID）、shadow 和 gshadow （密碼）或 /etc/security/opasswd （舊密碼，基於 PAM 設定中的記住參數）檔案的事件。本節中的參數將監視檔案以查看它們是否已開啟以進行寫入或已進行屬性變更（例如權限），並在審核日誌檔案中使用識別碼「identity」對其進行標記。'
    rationale: "這些檔案的意外變更可能表示系統已受到損害，且未經授權的使用者正試圖隱藏其活動或損害其他帳戶。"
    remediation: "在 /etc/audit/rules.d/ 目錄中編輯或創建一個以 .rules 結尾的檔案，並添加以下行： -w /etc/group -p wa -k identity | -w /etc/passwd -p wa -k identity | -w /etc/gshadow -p wa -k identity | -w /etc/shadow -p wa -k identity | -w /etc/security/opasswd -p wa -k identity 注意: 重新載入 auditd 配置以設置有效設置可能需要重啟系統。"
    compliance:
      - cis: ["4.1.4"]
      - cis_csc: ["4.8"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/group && r:-p wa && r:-k identity'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/passwd && r:-p wa && r:-k identity'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/gshadow && r:-p wa && r:-k identity'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/shadow && r:-p wa && r:-k identity'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/security/opasswd && r:-p wa && r:-k identity'

  - id: 18620
    title: "確保收集修改系統網路環境的事件。"
    description: "記錄網路環境檔案或系統呼叫的變更。以下參數監視 sethostname（設定系統主機名稱）或 setdomainname（設定系統網域名稱）系統調用，並在系統調用退出時寫入審核事件。其他參數監視 /etc/issue 和 /etc/issue.net 檔案（登入前顯示的訊息）、/etc/hosts（包含主機名稱和關聯 IP 位址的檔案）和 /etc/sysconfig/network（包含網路的目錄）介面腳本和配置）檔案。"
    rationale: '監視 sethostname 和 setdomainname 將識別對系統主機和網域的潛在未經授權的變更。更改這些名稱可能會破壞基於這些名稱設定的安全性參數。監視 /etc/hosts 檔案中的檔案更改，這些更改可能表明未經授權的入侵者正在嘗試更改電腦與 IP 位址的關聯，並誘騙使用者和程序連接到非預期的電腦。監視 /etc/issue 和 /etc/issue.net 非常重要，因為入侵者可能會將虛假資訊放入這些檔案中並誘騙用戶向入侵者提供資訊。監視 /etc/network 非常重要，因為它可以顯示網路介面或腳本是否已修改，從而導致電腦不可用或受到損害。所有審核記錄都將標有識別碼「系統區域設定」。'
    remediation: "對於32位元系統，編輯或創建位於 /etc/audit/rules.d/ 目錄下，以 .rules 結尾的檔案，例如：vi /etc/audit/rules.d/system-locale.rules，並添加以下行： -a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale      -w /etc/issue -p wa -k system-locale      -w /etc/issue.net -p wa -k system-locale     -w /etc/hosts -p wa -k system-locale-w /etc/network -p wa -k system-locale     對於64位元系統，編輯或創建位於 /etc/audit/rules.d/ 目錄下，以 .rules 結尾的檔案，例如：vi /etc/audit/rules.d/system-locale.rules，並添加以下行：  -a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale   -a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale       -w /etc/issue -p wa -k system-locale          -w /etc/issue.net -p wa -k system-locale           -w /etc/hosts -p wa -k system-locale         -w /etc/network -p wa -k system-locale"
    compliance:
      - cis: ["4.1.5"]
      - cis_csc: ["5.5"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:exit,always|always,exit && r:-F arch=b32 && r:-S sethostname && r:-S setdomainname && r:-k system-locale'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/issue && r:-p wa && r:-k system-locale'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/issue.net && r:-p wa && r:-k system-locale'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/hosts && r:-p wa && r:-k system-locale'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/network && r:-p wa && r:-k system-locale'

  - id: 18621
    title: "確保收集修改系統強制存取控制的事件。"
    description: "監控AppArmor強制存取控制。以下參數監控對 /etc/apparmor 和 /etc/apparmor.d 目錄的任何寫入存取（目錄中檔案的潛在附加、刪除或修改）或屬性變更。"
    rationale: "對這些目錄中的檔案進行更改可能表示未經授權的使用者正在嘗試修改存取控制並更改安全上下文，從而導致系統受到損害。"
    remediation: "在使用AppArmor的系統上，在/etc/audit/audit.rules檔案中新增以下行: -w /etc/apparmor/ -p wa -k MAC-policy | -w /etc/apparmor.d/ -p wa -k MAC-policy。注意: 重新載入auditd配置以設置有效的設定可能需要重新啟動系統。"
    compliance:
      - cis: ["4.1.6"]
      - cis_csc: ["5.5"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/apparmor/ && r:-p wa && r:-k MAC-policy'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/apparmor.d/ && r:-p wa && r:-k MAC-policy'

  - id: 18622
    title: "確保收集登入和登出事件。"
    description: "監控登入和登出事件。以下參數追蹤與登入/登出事件關聯的檔案的變更。檔案 /var/log/faillog 追蹤登入失敗事件。檔案 /var/log/lastlog 維護使用者上次成功登入的記錄。"
    rationale: "監視登入/登出事件可以為系統管理員提供與針對使用者登入的暴力攻擊相關的資訊。"
    remediation: "在 /etc/audit/rules.d/ 目錄中編輯或創建一個以 .rules 結尾的檔案，並添加以下內容: -w /var/log/faillog -p wa -k logins | -w /var/log/lastlog -p wa -k logins | -w /var/log/tallylog -p wa -k logins。注意: 重新載入 auditd 配置以設定活動設置可能需要重新啟動系統。"
    compliance:
      - cis: ["4.1.7"]
      - cis_csc: ["4.9", "16.11", "16.13"]
      - pci_dss: ["10.2.1", "10.2.4", "10.3"]
      - nist_800_53: ["AC.7", "AU.14"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["32.2", "35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/var/log/faillog && r:-p wa && r:-k logins'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/var/log/lastlog && r:-p wa && r:-k logins'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/var/log/tallylog && r:-p wa && r:-k logins'

  - id: 18623
    title: "確保收集會話啟動資訊。"
    description: '監視會話啟動事件。本節中的參數追蹤與會話事件關聯的檔案的變更。 /var/run/utmp 檔案追蹤所有目前登入的使用者。所有審核記錄都將標有識別字「會話」。 /var/log/wtmp 檔案追蹤登入、登出、關閉和重新啟動事件。檔案 /var/log/btmp 追蹤失敗的登入嘗試，可以透過輸入指令 /usr/bin/last -f /var/log/btmp 來讀取。所有審核記錄都將標有識別碼「登入」。'
    rationale: "監視這些檔案的變更可以提醒系統管理員在異常時間發生登入，這可能表示入侵者活動（即使用者在正常不登入的時間登入）。"
    remediation: "在 /etc/audit/rules.d/ 目錄下編輯或創建一個以 .rules 結尾的檔案，並添加以下內容: -w /var/run/utmp -p wa -k session | -w /var/log/wtmp -p wa -k logins | -w /var/log/btmp -p wa -k logins。注意: 最後一個指令可以用來讀取 /var/log/wtmp (last 不帶參數) 和 /var/run/utmp (last -f /var/run/utmp)。重載 auditd 配置以設置活動設置可能需要系統重啟。"
    compliance:
      - cis: ["4.1.8"]
      - cis_csc: ["4.9", "16.11", "16.13"]
      - pci_dss: ["10.3"]
      - nist_800_53: ["AC.7", "AU.14"]
      - hipaa: ["164.312.b"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/var/run/utmp && r:-p wa && r:-k session'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/var/log/wtmp && r:-p wa && r:-k logins'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/var/log/btmp && r:-p wa && r:-k logins'

  - id: 18624
    title: "確保收集酌情存取控制權限修改事件。"
    description: '監視檔案權限、屬性、所有權和群組的變更。本節中的參數追蹤影響檔案權限和屬性的系統呼叫的變更。 chmod 、 fchmod 和 fchmodat 系統呼叫會影響與檔案關聯的權限。 chown 、 fchown 、 fchownat 和 lchown 系統呼叫會影響檔案的擁有者和群組屬性。 setxattr 、 lsetxattr 、 fsetxattr （設定擴充檔屬性）和removexattr 、 lremovexattr 、 fremovexattr （刪除擴充檔屬性）控制擴充檔屬性。在所有情況下，只會為非系統使用者 ID (auid >= 1000) 寫入審核記錄，並將忽略守護程序事件 (auid = 4294967295)。所有審核記錄都將標有識別字“perm_mod”。'
    rationale: "監視檔案屬性的變更可以提醒系統管理員注意可能表示入侵者活動或違反策略的活動。"
    remediation: "對於64位系統，在/etc/audit/rules.d/目錄中編輯或創建一個以.rules結尾的檔案，並添加以下行： -a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod | -a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod | -a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod | -a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod | -a always,exit -F arch=b64 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod | -a always,exit -F arch=b32 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod. 注：重新載入auditd配置以設置活動設置可能需要系統重啟。"
    compliance:
      - cis: ["4.1.9"]
      - cis_csc: ["5.5"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b32 && r:-S chmod && r:-S fchmod && r:-S fchmodat && r:-F auid>=1000 && r:-F auid!=4294967295 && r:-k perm_mod'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b32 && r:-S chown && r:-S fchown && r:-S fchownat && r:-S lchown && r:-F auid>=1000 && r:-F auid!=4294967295 && r:-k perm_mod'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b32 && r:-S setxattr && r:-S lsetxattr && r:-S fsetxattr && r:-S removexattr && r:-S lremovexattr && r:-S fremovexattr && r:-F auid>=1000 && r:-F auid!=4294967295 && r:-k perm_mod'

  - id: 18625
    title: "確保收集不成功的未經授權的檔案存取嘗試。"
    description: '監視存取檔案的失敗嘗試。以下參數與控制檔案的建立 ( creat )、開啟 ( open 、 openat ) 和截斷 ( truncate 、 ftruncate ) 的系統呼叫相關聯。只有當使用者是非特權使用者 (auid > = 1000)、不是守護程序事件 (auid=4294967295) 且系統呼叫傳回 EACCES（檔案權限被拒絕）或 EPERM 時，才會寫入審核日誌記錄（與特定系統呼叫相關的其他一些永久性錯誤）。所有審核記錄都將標有識別碼「存取」。'
    rationale: "嘗試開啟、建立或截斷檔案失敗可能表示個人或程序正在嘗試獲得對系統的未經授權的存取。"
    remediation: "對於 32 位系統，編輯或創建 /etc/audit/rules.d/ 目錄下以 .rules 為結尾的檔案 例如: vi /etc/audit/rules.d/audit.rules 並添加以下行:    -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access    |    -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access                    對於 64 位系統，編輯或創建 /etc/audit/rules.d/ 目錄下以 .rules 為結尾的檔案 例如: vi /etc/audit/rules.d/access.rules 並添加以下行:                -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access     |  -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access     |    -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access   |  -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access          注意: 重新載入 auditd 配置以設置有效設置需要重新啟動 auditd 服務，並且可能需要重新啟動系統。"
    compliance:
      - cis: ["4.1.10"]
      - cis_csc: ["14.9"]
      - pci_dss: ["10.2.4"]
      - nist_800_53: ["AC.7"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["32.2", "35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b32 && r:-S creat && r:-S open && r:-S openat && r:-S truncate && r:-F exit=-EACCES && r:-F auid>=1000 && r:-F auid!=4294967295 && r:-k access'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b32 && r:-S creat && r:-S open && r:-S openat && r:-S truncate && r:-F exit=-EPERM && r:-F auid>=1000 && r:-F auid!=4294967295 && r:-k access'

  - id: 18626
    title: "確保收集成功的檔案系統安裝。"
    description: "監控 mount 系統呼叫的使用情況。 mount （和 umount ）系統呼叫控製檔案系統的安裝和卸載。以下參數將系統配置為在非特權使用者使用 mount 系統呼叫時建立審核記錄。"
    rationale: "非特權使用者將檔案系統掛載到系統的情況非常罕見。雖然追蹤安裝指令為系統管理員提供了外部媒體可能已安裝的證據（基於對安裝來源的審查並確認其是外部介質類型），但它並不能最終表明資料已匯出到媒體。希望確定資料是否已匯出的系統管理員還必須追蹤成功的 open 、 creat 和 truncate 系統調用，這些系統調用需要對外部媒體檔案系統安裝點下的檔案進行寫入存取。這可以清楚地表明發生了寫入。真正證明這一點的唯一方法是追蹤對外部媒體的成功寫入。追蹤寫入系統呼叫可能會快速填滿審核日誌，因此不建議這樣做。有關追蹤資料匯出到媒體的配置選項的建議超出了本檔案的範圍。"
    remediation: "對於 32 位元系統，在 /etc/audit/rules.d/ 目錄中編輯或創建一個以 .rules 結尾的檔案，並添加以下行：-a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts。對於 64 位元系統，在 /etc/audit/rules.d/ 目錄中編輯或創建一個以 .rules 結尾的檔案，並添加以下行：-a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts | -a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts。注意：這將追踪成功和失敗的掛載指令。檔案系統掛載不必來自外部媒體，且此操作仍未驗證寫入（例如 CD-ROM）。重新載入 auditd 配置以設置活動設置可能需要系統重新啟動。"
    compliance:
      - cis: ["4.1.12"]
      - cis_csc: ["13"]
      - pci_dss: ["10.2.7"]
      - nist_800_53: ["AU.14", "AU.6"]
      - gpg_13: ["7.9"]
      - gdpr_IV: ["32.2", "35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b32 && r:-S mount && r:-F auid>=1000 && r:-F auid!=4294967295 && r:-k mounts'

  - id: 18627
    title: "確保收集使用者的檔案刪除事件。"
    description: '監視與刪除或重新命名檔案和檔案屬性相關的系統呼叫的使用情況。此設定敘述對 unlink（刪除檔案）、unlinkat（刪除檔案屬性）、rename（重新命名檔案）和 renameat（重新命名檔案屬性）系統呼叫的監視，並用識別碼「delete」標記它們。'
    rationale: "監視來自非特權使用者的這些呼叫可以為系統管理員提供證據，表明正在發生與受保護檔案關聯的檔案和檔案屬性的不當刪除。雖然此審核選項將查看所有事件，但系統管理員將希望尋找正在刪除或變更的特定特權檔案。"
    remediation: "對於32位系統，在/etc/audit/rules.d/目錄中編輯或創建一個以.rules結尾的檔案，並添加以下行：-a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete。對於64位系統，在/etc/audit/rules.d/目錄中編輯或創建一個以.rules結尾的檔案，並添加以下行：-a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete | -a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete。註：至少應配置審計系統以收集所有用戶和root的檔案刪除事件。重新載入auditd配置以設置活動設置可能需要重新啟動系統。"
    compliance:
      - cis: ["4.1.13"]
      - cis_csc: ["6.2", "13"]
      - pci_dss: ["10.5.5"]
      - nist_800_53: ["AU.14"]
      - hipaa: ["164.312.b"]
      - tsc: ["PI1.4", "PI1.5", "CC7.1", "CC7.2", "CC7.3", "CC8.1"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b32 && r:-S unlink && r:-S unlinkat && r:-S rename && r:-S renameat && r:-F auid>=1000 && r:-F auid!=4294967295 && r:-k delete'

  - id: 18628
    title: "確保收集對系統管理範圍 (sudoers) 的變更。"
    description: '監視系統管理範圍的變更。如果系統已正確配置為強制系統管理員首先以自己的身分登入，然後使用 sudo 指令執行特權指令，則可以監視範圍的變更。當檔案或其屬性發生變更時，將寫入檔案 /etc/sudoers。審計記錄將標有識別字“範圍”。'
    rationale: "/etc/sudoers 檔案中的變更可能表示對系統管理員活動範圍進行了未經授權的更改。"
    remediation: "將以下行添加到 /etc/audit/audit.rules 檔案中：-w /etc/sudoers -p wa -k scope | -w /etc/sudoers.d/ -p wa -k scope。注意：重新載入 auditd 配置以設置活動設置可能需要重新啟動系統。"
    compliance:
      - cis: ["4.1.14"]
      - cis_csc: ["4.8"]
      - pci_dss: ["10.5.5"]
      - nist_800_53: ["AU.14"]
      - hipaa: ["164.312.b"]
      - tsc: ["PI1.4", "PI1.5", "CC7.1", "CC7.2", "CC7.3", "CC8.1"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/sudoers && r:-p wa && r:-k scope'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/etc/sudoers.d/ && r:-p wa && r:-k scope'

  - id: 18629
    title: "確保收集系統管理員操作 (sudolog)。"
    description: "監視 sudo 日誌檔。如果系統已正確配置為停用 su 指令並強制所有管理員必須先登入然後使用 sudo 執行特權指令，則所有管理員指令都將記錄到 /var/log/sudo.log 。每當執行指令時，都會觸發審核事件，因為 /var/log/sudo.log 檔案將開啟進行寫入，並且執行的管理指令將寫入日誌。"
    rationale: "/var/log/sudo.log 中的變更表示管理員已執行指令或日誌檔案本身已被竄改。管理者希望將寫入稽核追蹤的事件與寫入 /var/log/sudo.log 的記錄相關聯，以驗證是否執行了未經授權的指令。"
    remediation: "在 /etc/audit/rules.d/ 目錄中編輯或創建一個以 .rules 結尾的檔案，並添加以下行: -w <Path to sudo logfile> -p wa -k actions。注意事項: 系統必須配置為禁用 su (參見項目 5.6 確保 su 指令的存取受限) 以強制所有指令通過 sudo 執行。這在控制台上不會生效，因為管理員可以以 root 身份登入。重新載入 auditd 配置以設置活動設置可能需要重新啟動系統。"
    compliance:
      - cis: ["4.1.15"]
      - cis_csc: ["4.9"]
      - pci_dss: ["10.2.2"]
      - nist_800_53: ["AU.14", "AC.6", "AC.7"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["32.2", "35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w \.+ && r:-p wa && r:-k actions'

  - id: 18630
    title: "確保收集內核模組載入和卸載。"
    description: '監控核心模組的載入和卸載。程式 insmod（安裝核心模組）、rmmod（刪除核心模組）和 modprobe（用於載入和卸載模組的更複雜的程序，以及一些其他功能）控制模組的載入和卸載。 init_module（載入模組）和delete_module（刪除模組）系統呼叫控制模組的載入和卸載。任何載入、卸載模組程式和系統呼叫的執行都會觸發一條標識為「modules」的稽核記錄。'
    rationale: "監視 insmod、rmmod 和 modprobe 的使用可以為系統管理員提供未經授權的使用者載入或卸載核心模組的證據，這可能會危及系統的安全。對 init_module 和 delete_module 系統呼叫的監視將反映未經授權的使用者試圖使用不同的程式來載入和卸載模組。"
    remediation: "對於32位元系統，請在 /etc/audit/rules.d/ 目錄下編輯或創建一個以 .rules 結尾的檔案，並添加以下行: -w /sbin/insmod -p x -k modules | -w /sbin/rmmod -p x -k modules | -w /sbin/modprobe -p x -k modules | -a always,exit -F arch=b32 -S init_module -S delete_module -k modules. 對於64位元系統，請在 /etc/audit/rules.d/ 目錄下編輯或創建一個以 .rules 結尾的檔案，並添加以下行: -w /sbin/insmod -p x -k modules | -w /sbin/rmmod -p x -k modules | -w /sbin/modprobe -p x -k modules | -a always,exit -F arch=b64 -S init_module -S delete_module -k modules. 注意: 重新載入 auditd 配置以設置活動設置可能需要重新啟動系統。"
    compliance:
      - cis: ["4.1.16"]
      - cis_csc: ["5.1"]
      - pci_dss: ["10.2.7"]
      - nist_800_53: ["AU.14", "AU.6"]
      - gpg_13: ["7.9"]
      - gdpr_IV: ["32.2", "35.7.d"]
      - hipaa: ["164.312.b"]
      - tsc: ["CC6.1", "CC6.8", "CC7.2", "CC7.3", "CC7.4"]
    condition: all
    rules:
      - "d:/etc/audit"
      - 'd:/etc/audit/rules.d -> r:\.+.rules$'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/sbin/insmod && r:-p x && r:-k modules'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/sbin/rmmod && r:-p x && r:-k modules'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-w && r:/sbin/modprobe && r:-p x && r:-k modules'
      - 'd:/etc/audit/rules.d -> r:\.+.rules$ -> r:^-a && r:always,exit|exit,always && r:-F arch=b64|-F arch=b32 && r:-S init_module && r:-S delete_module && r:-k modules'

  - id: 18631
    title: "確保審核配置不可變。"
    description: '設定系統審計，使審計規則不能用auditctl修改。設定標誌“-e 2”強制審核置於不可變模式。審核變更只能在系統重新啟動時進行。'
    rationale: "在不可變模式下，未經授權的使用者無法對審核系統執行變更以隱藏惡意活動，然後復原審核規則。使用者很可能會注意到系統重新啟動，這可能會提醒管理員嘗試進行未經授權的審核變更。"
    remediation: "編輯或創建檔案 /etc/audit/rules.d/99-finalize.rules 並添加以下行: -e 2。 注意: 此設置將確保重新載入 auditd 配置以設置啟用設置需要系統重新啟動。"
    compliance:
      - cis: ["4.1.17"]
      - cis_csc: ["6.2", "6.3"]
      - pci_dss: ["10.5"]
      - nist_800_53: ["AU.9"]
      - hipaa: ["164.312.b"]
    condition: all
    rules:
      - "d:/etc/audit"
      - "d:/etc/audit/rules.d -> r:^99-finalize.rules$"
      - 'd:/etc/audit/rules.d -> r:^99-finalize.rules$ -> r:^\s*\t*-e 2$'

  # 4.2,1 Configure rsyslog
  - id: 18632
    title: "確保 rsyslog 已安裝。"
    description: "The rsyslog software are recommended replacements to the original syslogd daemon which provide improvements over syslogd , such as connection-oriented (i.e. TCP) transmission of logs, the option to log to database formats, and the encryption of log data en route to a central logging伺服器."
    rationale: "rsyslog 的安全性增強功能（例如連線導向（即 TCP）的日誌傳輸、記錄到資料庫格式的選項以及到中央日誌伺服器的日誌資料加密）證明了安裝和設定該軟體包的合理性。"
    remediation: "安裝 rsyslog：# apt install rsyslog"
    compliance:
      - cis: ["4.2.1.1"]
      - cis_csc: ["6.2"]
      - pci_dss: ["10.1"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2", "CC6.1", "CC6.2", "CC6.3", "CC7.2", "CC7.3", "CC7.4"]
      - hipaa: ["164.312.b"]
    condition: any
    rules:
      - "c:dpkg -s rsyslog -> r:install ok installed"
  - id: 18633
    title: "確保 rsyslog 服務已啟用。"
    description: "安裝 rsyslog 軟體包後，需要將其啟動。"
    rationale: "如果 rsyslog 服務未啟用，系統將不會執行 syslog 服務。"
    remediation: "執行以下指令來啟用 rsyslog: # systemctl --now enable rsyslog"
    compliance:
      - cis: ["4.2.1.2"]
      - cis_csc: ["6.2", "6.3"]
      - pci_dss: ["10.1"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2", "CC6.1", "CC6.2", "CC6.3", "CC7.2", "CC7.3", "CC7.4"]
      - hipaa: ["164.312.b"]
    condition: all
    rules:
      - "c:systemctl is-enabled rsyslog -> enabled"

  - id: 18634
    title: "確保配置了 rsyslog 預設檔權限。"
    description: "rsyslog 將建立系統上尚不存在的日誌檔案。此設定控制將哪些權限套用至這些新建立的檔案。"
    rationale: "確保日誌檔案具有正確的權限以確保敏感資料已歸檔和保護非常重要。"
    remediation: "編輯 /etc/rsyslog.conf 和 /etc/rsyslog.d/*.conf 檔案並將 $FileCreateMode 設為 0640 或更嚴格:   $FileCreateMode 0640"
    compliance:
      - cis: ["4.2.1.4"]
      - cis_csc: ["5.1"]
      - pci_dss: ["10.5.1", "10.5.2"]
      - nist_800_53: ["CM.1", "AU.9"]
      - tsc: ["CC5.2", "CC6.1", "CC7.2", "CC.7.3", "CC7.4"]
    condition: any
    rules:
      - 'f:/etc/rsyslog.conf -> r:^\$FileCreateMode 06\d0|^\$FileCreateMode 04\d0|^\$FileCreateMode 02\d0|^\$FileCreateMode 00\d0 && r:^\$FileCreateMode 0\d40|^\$FileCreateMode 0\d00'
      - 'd:/etc/rsyslog.d/ -> r:\. -> r:^\$FileCreateMode 06\d0|^\$FileCreateMode 04\d0|^\$FileCreateMode 02\d0|^\$FileCreateMode 00\d0 && r:^\$FileCreateMode 0\d40|^\$FileCreateMode 0\d00'

  - id: 18635
    title: "確保 rsyslog 配置為將日誌傳送到遠端日誌主機。"
    description: "rsyslog 實用程式支援將其收集的日誌傳送至執行 syslogd(8) 的遠端日誌主機或從遠端主機接收訊息的功能，從而減少管理開銷。"
    rationale: "在遠端主機上儲存日誌資料可以保護日誌完整性免受本機攻擊。如果攻擊者獲得本機系統的 root 存取權限，他們就可以篡改或刪除本機系統上儲存的日誌資料。"
    remediation: '編輯 /etc/rsyslog.conf 和 /etc/rsyslog.d/*.conf 檔案並加入以下其中一行： 較新的語法： <files to sent to the remote log server> action(type="omfwd" target="<FQDN or ip of loghost>" port="<port number>" protocol="tcp" action.resumeRetryCount="<number of re-tries>" queue.type="linkList" queue.size=<number of messages to queue>") 例如： *.* action(type="omfwd" target="192.168.2.100" port"514" protocol="tcp" action.resumeRetryCount="100" queue.type="linkList" queue.size="1000") 較舊的語法： *.* @@<FQDN or ip of loghost>'
    compliance:
      - cis: ["4.2.1.5"]
      - cis_csc: ["6.6", "6.8"]
      - pci_dss: ["10.5.3"]
      - nist_800_53: ["CM.1", "AU.4"]
      - tsc: ["CC5.2"]
    references:
      - rsyslog.conf(5) man page
    condition: all
    rules:
      - 'c:grep -Rh ^*.* /etc/rsyslog.conf /etc/rsyslog.d/ -> r:^*.* action\.+target='

  - id: 18636
    title: "確保遠端 rsyslog 訊息僅在指定的日誌主機上接受。"
    description: "預設情況下，rsyslog 不偵聽來自遠端系統的日誌訊息。 ModLoad 告訴 rsyslog 載入 imtcp.so 模組，以便它可以透過 TCP 監聽網路。 InputTCPServerRun 選項指示 rsyslogd 偵聽指定的 TCP 連接埠。"
    rationale: "本節中的指示可確保遠端日誌主機已配置為僅接受來自指定網域內的主機的 rsyslog 資料，且未設計為日誌主機的系統不接受任何遠端 rsyslog 訊息。這可以防止日誌資料被欺騙，並確保系統管理員在中央位置檢查相當完整的系統日誌資料。"
    remediation: "對於被指定為日誌主機的主機，編輯 /etc/rsyslog.conf 檔案並取消註釋或新增以下行：$ModLoad imtcp        $InputTCPServerRun 514。對於未被指定為日誌主機的主機，編輯 /etc/rsyslog.conf 檔案並註釋或移除以下行：# $ModLoad imtcp # $InputTCPServerRun 514。運行以下指令來重新載入 rsyslogd 配置：# pkill -HUP rsyslogd"
    compliance:
      - cis: ["4.2.1.6"]
      - cis_csc: ["9.2"]
      - pci_dss: ["10.5.1"]
    references:
      - rsyslog.conf(8) man page
    condition: all
    rules:
      - 'c:grep -Rh ^\$ModLoad[[:space:]]*imtcp /etc/rsyslog.conf /etc/rsyslog.d/ -> r:^\$ModLoad\s*\t*imtcp'
      - 'c:grep -Rh ^\$InputTCPServerRun /etc/rsyslog.conf /etc/rsyslog.d/ -> r:^\$InputTCPServerRun\s*\t*514'

  # 4.2.2.1 Ensure journald is configured to send logs to rsyslog (Scored)
  - id: 18637
    title: "確保journald配置為將日誌傳送到rsyslog。"
    description: "來自日誌的資料可能儲存在易失性記憶體中或保留在伺服器本地。存在接受日誌日誌遠端匯出的實用程序，但是，使用 rsyslog 服務提供了一致的日誌收集和匯出方法。"
    rationale: "在遠端主機上儲存日誌資料可以保護日誌完整性免受本機攻擊。如果攻擊者獲得本機系統的 root 存取權限，他們就可以篡改或刪除本機系統上儲存的日誌資料。"
    remediation: "編輯 /etc/systemd/journald.conf 檔案並新增以下行: ForwardToSyslog=yes"
    compliance:
      - cis: ["4.2.2.1"]
      - cis_csc: ["6.5"]
      - pci_dss: ["10.5.3"]
      - nist_800_53: ["CM.1", "AU.9", "AU.4"]
      - tsc: ["CC5.2", "CC7.2"]
    references:
      - "https://github.com/konstruktoid/hardening/blob/master/systemd.adoc#etcsystemdjournaldconf"
    condition: all
    rules:
      - 'f:/etc/systemd/journald.conf -> r:^\s*\t*ForwardToSyslog\s*=\s*yes'

  # 4.2.2.2 Ensure journald is configured to compress large log files (Scored)
  - id: 18638
    title: "確保journald配置為壓縮大型日誌檔案。"
    description: "日誌系統具有壓縮過大檔案的功能，以避免日誌填滿系統或使日誌過大而難以管理。"
    rationale: "未壓縮的大檔案可能會意外填滿檔案系統，從而導致資源不可用。在寫入之前壓縮日誌可以防止突然的、意外的檔案系統影響。"
    remediation: "編輯 /etc/systemd/journald.conf 檔案並添加以下行: Compress=yes"
    compliance:
      - cis: ["4.2.2.2"]
      - cis_csc: ["6.4"]
      - pci_dss: ["10.7"]
      - nist_800_53: ["CM.1", "AU.4"]
      - tsc: ["CC5.2"]
    references:
      - "https://github.com/konstruktoid/hardening/blob/master/systemd.adoc#etcsystemdjournaldconf"
    condition: all
    rules:
      - 'f:/etc/systemd/journald.conf -> r:^\s*\t*Compress\s*=\s*yes'

  # 4.2.2.3 Ensure journald is configured to write logfiles to persistent disk (Scored)
  - id: 18639
    title: "確保journald配置為將日誌檔案寫入永久磁碟。"
    description: "來自日誌的資料可能儲存在易失性記憶體中或保留在伺服器本地。系統重新啟動後，記憶體中的日誌將會遺失。透過將日誌儲存到伺服器上的本機磁碟，可以防止日誌遺失。"
    rationale: "將日誌資料寫入磁碟將提供取證重建事件的能力，即使在系統當機或重新啟動後，這些事件也可能影響系統的操作或安全性。"
    remediation: "編輯 /etc/systemd/journald.conf 檔案並新增以下行:   Storage=persistent"
    compliance:
      - cis: ["4.2.2.3"]
      - cis_csc: ["6.2", "6.3"]
      - pci_dss: ["10.7"]
      - nist_800_53: ["CM.1", "AU.4"]
      - tsc: ["CC5.2"]
    references:
      - "https://github.com/konstruktoid/hardening/blob/master/systemd.adoc#etcsystemdjournaldconf"
    condition: all
    rules:
      - 'f:/etc/systemd/journald.conf -> r:^\s*\t*Storage\s*=\s*persistent'

  # 4.2.3 Ensure permissions on all logfiles are configured (Scored)
  - id: 18640
    title: "確保配置了所有日誌檔案的權限。"
    description: "儲存在 /var/log/ 中的日誌檔案包含來自系統上或其他日誌主機上的許多服務的記錄資訊。"
    rationale: "確保日誌檔案具有正確的權限以確保敏感資料已歸檔和保護非常重要。"
    remediation: '執行以下指令以設定所有現有日誌檔案的權限：find /var/log -type f -exec chmod g-wx,o-rwx "{}" + -o -type d -exec chmod g-w,o-rwx "{}" +'
    compliance:
      - cis: ["4.2.3"]
      - cis_csc: ["5.1"]
      - pci_dss: ["10.5.1", "10.5.2"]
      - nist_800_53: ["CM.1", "AU.9"]
      - tsc: ["CC5.2", "CC7.2"]
    condition: none
    rules:
      - 'c:find /var/log -type f -ls -> r:-\w\w\w\ww\w\w\w\w|-\w\w\w\w\wx\w\w\w|-\w\w\w\w\w\w\ww\w|-\w\w\w\w\w\wr\w\w|-\w\w\w\w\w\w\w\wx'

  ############################################################
  # 5 Access, Authentication and Authorization
  ############################################################
  ############################################################
  # 5.1 Configure cron
  ############################################################
  - id: 18641
    title: "確保 cron 守護程式已啟用。"
    description: "cron 守護程式用於在系統上執行批次作業。"
    rationale: "雖然系統上可能沒有需要執行的使用者作業，但系統確實有維護作業，其中可能包括必須執行的安全監控，並且使用 cron 來執行它們。"
    remediation: "要啟用 Cron，請運行以下指令: systemctl --now enable cron"
    compliance:
      - cis: ["5.1.1"]
      - cis_csc: ["6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - "c:systemctl is-enabled cron -> enabled"

  # 5.1.2 Ensure permissions on /etc/crontab are configured (Scored)
  - id: 18642
    title: "確保配置了 /etc/crontab 的權限。"
    description: "/etc/crontab 檔案由 cron 使用來控制自己的作業。此項目中的指令確保 root 是該檔案的使用者和群組擁有者，並且只有所有者才能存取該檔案。"
    rationale: "該檔案包含有關 cron 運行哪些系統作業的資訊。對這些檔案的寫入存取權限可以為非特權使用者提供提升權限的能力。對這些檔案的讀取存取權限可以使用戶能夠深入了解系統上運行的系統作業，並為他們提供一種獲得未經授權的特權存取權的方法。"
    remediation: "執行以下指令來設置 /etc/crontab 的擁有權和權限 : chown root:root /etc/crontab 和 chmod og-rwx /etc/crontab"
    compliance:
      - cis: ["5.1.2"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - tsc: ["CC7.2", "CC6.1"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
    condition: all
    rules:
      - 'c:stat /etc/crontab -> r:^Access: \(0\d00/-\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  # 5.1.3 Ensure permissions on /etc/cron.hourly are configured (Scored)
  - id: 18643
    title: "確保配置了 /etc/cron.hourly 的權限。"
    description: "此目錄包含需要每小時運行的系統 cron 作業。該目錄中的檔案無法透過 crontab 指令操作，而是由系統管理員使用文字編輯器進行編輯。以下指令限制對使用者和群組 root 的讀取/寫入和搜尋存取，防止普通使用者存取此目錄。"
    rationale: "向非特權使用者授予對此目錄的寫入存取權限可以為他們提供獲得未經授權的提升權限的方法。授予對此目錄的讀取存取權限可以讓非特權使用者了解如何獲得提升的權限或規避審核控制。"
    remediation: "執行以下指令來設定 /etc/cron.hourly 的擁有權和權限：chown root:root /etc/cron.hourly 和 chmod og-rwx /etc/cron.hourly"
    compliance:
      - cis: ["5.1.3"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/cron.hourly -> r:^Access: \(0\d00/\w\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  # 5.1.4 Ensure permissions on /etc/cron.daily are configured (Scored)
  - id: 18644
    title: "確保配置了 /etc/cron.daily 的權限。"
    description: "/etc/cron.daily 目錄包含需要每天執行的系統 cron 作業。該目錄中的檔案無法透過 crontab 指令操作，而是由系統管理員使用文字編輯器進行編輯。以下指令限制對使用者和群組 root 的讀取/寫入和搜尋存取，防止普通使用者存取此目錄。"
    rationale: "向非特權使用者授予對此目錄的寫入存取權限可以為他們提供獲得未經授權的提升權限的方法。授予對此目錄的讀取存取權限可以讓非特權使用者了解如何獲得提升的權限或規避審核控制。"
    remediation: "執行以下指令來設置 /etc/cron.daily 的所有權和權限：chown root:root /etc/cron.daily 和 chmod og-rwx /etc/cron.daily"
    compliance:
      - cis: ["5.1.4"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/cron.daily -> r:^Access: \(0\d00/\w\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  # 5.1.5 Ensure permissions on /etc/cron.weekly are configured (Scored)
  - id: 18645
    title: "確保配置了 /etc/cron.weekly 的權限。"
    description: "/etc/cron.weekly 目錄包含需要每週執行的系統 cron 作業。該目錄中的檔案無法透過 crontab 指令操作，而是由系統管理員使用文字編輯器進行編輯。以下指令限制對使用者和群組 root 的讀取/寫入和搜尋存取，防止普通使用者存取此目錄。"
    rationale: "向非特權使用者授予對此目錄的寫入存取權限可以為他們提供獲得未經授權的提升權限的方法。授予對此目錄的讀取存取權限可以讓非特權使用者了解如何獲得提升的權限或規避審核控制。"
    remediation: "執行以下指令來設置 /etc/cron.weekly 的擁有權和權限：chown root:root /etc/cron.weekly 和 chmod og-rwx /etc/cron.weekly"
    compliance:
      - cis: ["5.1.5"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/cron.weekly -> r:^Access: \(0\d00/\w\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  # 5.1.6 Ensure permissions on /etc/cron.monthly are configured (Scored)
  - id: 18646
    title: "確保配置了 /etc/cron.monthly 的權限。"
    description: "/etc/cron.monthly 目錄包含需要每月執行的系統 cron 作業。該目錄中的檔案無法透過 crontab 指令操作，而是由系統管理員使用文字編輯器進行編輯。以下指令限制對使用者和群組 root 的讀取/寫入和搜尋存取，防止普通使用者存取此目錄。"
    rationale: "向非特權使用者授予對此目錄的寫入存取權限可以為他們提供獲得未經授權的提升權限的方法。授予對此目錄的讀取存取權限可以讓非特權使用者了解如何獲得提升的權限或規避審核控制。"
    remediation: "執行以下指令來設定 /etc/cron.monthly 的擁有權和權限：chown root:root /etc/cron.monthly 並且 chmod og-rwx /etc/cron.monthly"
    compliance:
      - cis: ["5.1.6"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/cron.monthly -> r:^Access: \(0\d00/\w\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  # 5.1.7 Ensure permissions on /etc/cron.d are configured (Scored)
  - id: 18647
    title: "確保配置了 /etc/cron.d 的權限。"
    description: "配置/etc/cron.allow和/etc/at.allow以允許特定使用者使用這些服務。如果 /etc/cron.allow 或 /etc/at.allow 不存在，則檢查 /etc/at.deny 和 /etc/cron.deny。任何未在這些檔案中明確定義的使用者都可以使用 at 和 cron。透過刪除這些檔案，僅允許 /etc/cron.allow 和 /etc/at.allow 中的使用者使用 at 和 cron。請注意，即使 cron.allow 中未列出給定用戶，仍可以以該用戶身分執行 cron 作業。 cron.allow 檔案僅控制對用於規劃和修改 cron 作業的 crontab 指令的管理存取。"
    rationale: "在許多系統上，只有系統管理員有權安排 cron 作業。使用 cron.allow 檔案來控制誰可以執行 cron 作業來強制執行此原則。管理允許清單比管理拒絕清單更容易。在拒絕清單中，您可能會在系統中新增使用者 ID，但忘記將其新增至拒絕檔案。"
    remediation: "運行以下指令來刪除 /etc/cron.deny 和 /etc/at.deny 並創建 /etc/cron.allow 和 /etc/at.allow 並設置其權限和所有權: rm /etc/cron.deny;rm /etc/at.deny;touch /etc/cron.allow; touch /etc/at.allow; chmod og-rwx /etc/cron.allow; chmod og-rwx /etc/at.allow; chown root:root /etc/cron.allow and chown root:root /etc/at.allow"
    compliance:
      - cis: ["5.1.7"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/cron.d -> r:^Access: \(0\d00/\w\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  # 5.1.8 Ensure at/cron is restricted to authorized users (Scored)
  - id: 18648
    title: "確保 at/cron 僅限授權使用者使用。"
    description: "配置/etc/cron.allow和/etc/at.allow以允許特定使用者使用這些服務。如果 /etc/cron.allow 或 /etc/at.allow 不存在，則檢查 /etc/at.deny 和 /etc/cron.deny。任何未在這些檔案中明確定義的使用者都可以使用 at 和 cron。透過刪除這些檔案，僅允許 /etc/cron.allow 和 /etc/at.allow 中的使用者使用 at 和 cron。請注意，即使 cron.allow 中未列出給定用戶，cron 作業仍可以以該用戶身分執行。 cron.allow 檔案僅控制對用於規劃和修改 cron 作業的 crontab 指令的管理存取。"
    rationale: "在許多系統上，只有系統管理員有權安排 cronjobs。使用 cron.allow 檔案來控制誰可以執行 cron 作業來強制執行此原則。管理允許清單比管理拒絕清單更容易。在拒絕清單中，您可能會在系統中新增使用者 ID，但忘記將其新增至拒絕檔案。"
    remediation: "執行以下指令來刪除 /etc/cron.deny 和 /etc/at.deny 並建立和設置 /etc/cron.allow 和 /etc/at.allow 的權限和所有權: # rm /etc/cron.deny # rm /etc/at.deny # touch /etc/cron.allow # touch /etc/at.allow # chmod og-rwx /etc/cron.allow # chmod og-rwx /etc/at.allow # chown root:root /etc/cron.allow # chown root:root /etc/at.allow"
    compliance:
      - cis: ["5.1.8"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - "f:/etc/cron.allow"
      - "f:/etc/at.allow"
      - "not f:/etc/cron.deny"
      - "not f:/etc/at.deny"
      - 'c:stat /etc/cron.allow -> r:^Access: \(0\d\d0/\w\w\w\w\w-----\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'
      - 'c:stat /etc/at.allow -> r:^Access: \(0\d\d0/\w\w\w\w\w-----\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  ######################################################
  # 5.2 SSH Server Configuration
  ######################################################
  # 5.2.1 Ensure permissions on /etc/ssh/sshd_config are configured
  - id: 18649
    title: "確保配置了 /etc/ssh/sshd_config 的權限。"
    description: "/etc/ssh/sshd_config 檔案包含 sshd 的設定規格。下面的指令將檔案的擁有者和群組設定為 root。"
    rationale: "需要保護 /etc/ssh/sshd_config 檔案免受非特權使用者未經授權的變更。"
    remediation: "執行以下指令以設定 /etc/ssh/sshd_config 的擁有權和權限： # chown root:root /etc/ssh/sshd_config # chmod og-rwx /etc/ssh/sshd_config"
    compliance:
      - cis: ["5.2.1"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/ssh/sshd_config -> r:^Access: \(0\d00/\w\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  # 5.2.2 Ensure permissions on SSH private host key files are configured (Scored)
  - id: 18650
    title: "確保配置了 SSH 私有主機金鑰檔案的權限。"
    description: "SSH 私鑰是 SSH 公鑰驗證中使用的兩個檔案之一。在這種認證方法中，私鑰的擁有就是身分的證明。只有與公鑰相對應的私鑰才能成功進行身份驗證。私鑰需要謹慎儲存和處理，不得分發私鑰副本。"
    rationale: "如果未經授權的使用者取得私有 SSH 主機金鑰檔案，則該主機可能會被冒充"
    remediation: "執行以下指令來設定私有 SSH 主機金鑰檔案的所有權和權限： # find /etc/ssh -xdev -type f -name 'ssh_host_*_key' -exec chown root:root {} \\; # find /etc/ssh -xdev -type f -name 'ssh_host_*_key' -exec chmod 0600 {} \\;"
    compliance:
      - cis: ["5.2.2"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/ssh/ssh_host_rsa_key -> r:^Access: \(0\d00/-\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'
      - 'c:stat /etc/ssh/ssh_host_ecdsa_key -> r:^Access: \(0\d00/-\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'
      - 'c:stat /etc/ssh/ssh_host_ed25519_key -> r:^Access: \(0\d00/-\w\w\w------\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  # 5.2.3 Ensure permissions on SSH public host key files are configured (Scored)
  - id: 18651
    title: "確保配置了 SSH 公共主機金鑰檔案的權限。"
    description: "SSH 公鑰是 SSH 公鑰驗證中使用的兩個檔案之一。在這個認證方法中，公鑰是可以用於驗證使用對應的私鑰產生的數位簽章的金鑰。只有與私鑰相對應的公鑰才能成功進行身份驗證。"
    rationale: "如果公用主機金鑰檔案已被未經授權的使用者修改，則 SSH 服務可能會受到損害。"
    remediation: "執行以下指令來設定 SSH 主機公鑰檔案的權限和所有權: # find /etc/ssh -xdev -type f -name 'ssh_host_*_key.pub' -exec chmod 0644 {} \\; #find /etc/ssh -xdev -type f -name 'ssh_host_*_key.pub' -exec chown root:root {} \\;"
    compliance:
      - cis: ["5.2.3"]
      - cis_csc: ["14.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/ssh/ssh_host_rsa_key.pub -> r:^Access: \(0\d\d\d/-\w\w\w\w--\w--\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'
      - 'c:stat /etc/ssh/ssh_host_ecdsa_key.pub -> r:^Access: \(0\d\d\d/-\w\w\w\w--\w--\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'
      - 'c:stat /etc/ssh/ssh_host_ed25519_key.pub -> r:^Access: \(0\d\d\d/-\w\w\w\w--\w--\)  Uid: \(    0/    root\)   Gid: \(    0/    root\)$'

  # 5.2.4 Ensure SSH Protocol is not set to 1 (Scored)
  - id: 18652
    title: "確保 SSH 協定未設定為 1。"
    description: "舊版的 SSH 支援兩種不同且不相容的協定：SSH1 和 SSH2。 SSH1 是最初的協定，存在安全性問題。 SSH2 更先進、更安全。"
    rationale: "SSH v1 有不安全問題，但不會影響 SSH v2。注意：此指令在較新版本的 SSH 中不再存在。對於可能執行舊版 SSH 的系統，仍包含此檢查。從 openSSH 版本 7.4 開始，包含此參數不會導致問題。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案並將參數設置如下: Protocol 2"
    compliance:
      - cis: ["5.2.4"]
      - cis_csc: ["4.5", "14.4"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7"]
    condition: none
    rules:
      - 'c:sshd -T -> r:Protocol\s*\t*1'

  # 5.2.5 Ensure SSH LogLevel is appropriate (Scored)
  - id: 18653
    title: "確保 SSH LogLevel 合適。"
    description: "INFO級別是基本級別，僅記錄SSH用戶的登入活動。在許多情況下，例如事件回應，確定特定使用者何時在系統上處於活動狀態非常重要。註銷記錄可以消除那些斷開連接的用戶，這有助於縮小範圍。 VERBOSE 等級指定將記錄登入和登出活動以及用於登入的任何 SSH 金鑰的金鑰指紋。此資訊對於 SSH 金鑰管理非常重要，尤其是在遺留環境中。"
    rationale: "SSH 提供了多個具有不同詳細程度的日誌記錄等級。除了嚴格除錯 SSH 通訊之外，特別不建議使用 DEBUG，因為它提供的資料太多，很難識別重要的安全資訊。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案以將參數設置如下: LogLevel VERBOSE 或 LogLevel INFO"
    references:
      - https://www.ssh.com/ssh/sshd_config/
    compliance:
      - cis: ["5.2.5"]
      - cis_csc: ["6.2", "6.3"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7"]
    condition: all
    rules:
      - 'c:sshd -T -> r:LogLevel\s+INFO|LogLevel\s+VERBOSE'

  # 5.2.6 Ensure SSH X11 forwarding is disabled (Scored)
  - id: 18654
    title: "確保 SSH X11 轉送已停用。"
    description: "X11Forwarding 參數提供透過連接隧道傳輸 X11 流量以啟用遠端圖形連接的能力。"
    rationale: "除非有直接使用 X11 應用程式的操作要求，否則停用 X11 轉送。透過 SSH 使用 X11 轉送登入的使用者的遠端 X11 伺服器可能會受到 X11 伺服器上其他使用者的危害，這是一個小風險。請注意，即使 X11 轉發已停用，使用者也始終可以安裝自己的轉發器。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案以設置參數如下：X11Forwarding no"
    compliance:
      - cis: ["5.2.6"]
      - cis_csc: ["9.2"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
    condition: all
    rules:
      - 'c:sshd -T -> r:X11Forwarding\s+no'

  # 5.2.7 Ensure SSH MaxAuthTries is set to 4 or less (Scored)
  - id: 18655
    title: "確保 SSH MaxAuthTries 設定為 4 或更少。"
    description: "MaxAuthTries 參數指定每個連線允許的最大驗證嘗試次數。當登入失敗計數達到一半時，錯誤訊息將寫入系統日誌檔案，詳細說明登入失敗。"
    rationale: "將 MaxAuthTries 參數設定為較低的數字可以最大限度地降低對 SSH 伺服器進行暴力攻擊的風險。雖然建議設定為 4，但請根據網站策略設定該數字。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案以設定參數如下：MaxAuthTries 4"
    compliance:
      - cis: ["5.2.7"]
      - cis_csc: ["16.13"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sshd -T -> n:^MaxAuthTries\s*\t*(\d+) compare <= 4'

  # 5.2.8 Ensure SSH IgnoreRhosts is enabled (Scored)
  - id: 18656
    title: "確保 SSH IgnoreRhosts 已啟用。"
    description: "IgnoreRhosts 參數指定 .rhosts 和 .shosts 檔案不會在 RhostsRSAAuthentication 或 HostbasedAuthentication 中使用。"
    rationale: "設定此參數會強制使用者在使用 ssh 進行身份驗證時輸入密碼。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案以設置參數如下: IgnoreRhosts yes"
    compliance:
      - cis: ["5.2.8"]
      - cis_csc: ["9.2"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7"]
    condition: all
    rules:
      - 'c:sshd -T -> r:IgnoreRhosts\s+yes'

  # 5.2.9 Ensure SSH HostbasedAuthentication is disabled (Scored)
  - id: 18657
    title: "確保停用 SSH HostbasedAuthentication。"
    description: "HostbasedAuthentication 參數指定是否允許透過 .rhosts 或 /etc/hosts.equiv 使用者透過可信任主機進行驗證，以及成功的公鑰用戶端主機驗證。此選項僅適用於 SSH 協定版本 2。"
    rationale: "儘管如果在 /etc/pam.conf 中停用支持，.rhosts 檔案將無效，但停用在 SSH 中使用 .rhosts 檔案的功能可提供額外的保護層。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案以設置參數如下：HostbasedAuthentication no"
    compliance:
      - cis: ["5.2.9"]
      - cis_csc: ["16.3"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7"]
    condition: all
    rules:
      - 'c:sshd -T -> r:HostbasedAuthentication\s+no'

  # 5.2.10 Ensure SSH root login is disabled (Scored)
  - id: 18658
    title: "確保 SSH root 登入已停用。"
    description: "PermitRootLogin 參數指定 root 使用者是否可以使用 ssh(1) 登入。預設為否。"
    rationale: "禁止透過 SSH 進行 root 登入需要伺服器管理員使用自己的個人帳戶進行身份驗證，然後透過 sudo 或 su 升級到 root。這反過來又限制了不可否認的機會，並在發生安全事件時提供清晰的審計追蹤。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案，將參數設置為：PermitRootLogin no"
    compliance:
      - cis: ["5.2.10"]
      - cis_csc: ["4.3"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7"]
    condition: all
    rules:
      - 'c:sshd -T -> r:PermitRootLogin\s+no'

  # 5.2.11 Ensure SSH PermitEmptyPasswords is disabled (Scored)
  - id: 18659
    title: "確保 SSH PermitEmptyPasswords 已停用。"
    description: "PermitEmptyPasswords 參數指定伺服器是否允許使用空密碼字串登入帳戶。"
    rationale: "禁止遠端 shell 存取具有空密碼的帳戶可降低未經授權存取系統的可能性"
    remediation: "編輯 /etc/ssh/sshd_config 檔案，將參數設定如下：PermitEmptyPasswords no"
    compliance:
      - cis: ["5.2.11"]
      - cis_csc: ["16.3"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7"]
    condition: all
    rules:
      - 'c:sshd -T -> r:PermitEmptyPasswords\s+no'

  # 5.2.12 Ensure SSH PermitUserEnvironment is disabled (Scored)
  - id: 18660
    title: "確保 SSH PermitUserEnvironment 已停用。"
    description: "PermitUserEnvironment 選項可讓使用者向 ssh 守護程式提供環境選項。"
    rationale: "允許使用者透過 SSH 守護程序設定環境變數的能力可能會允許使用者繞過安全控制（例如，設定讓 ssh 執行木馬程式的執行路徑）"
    remediation: "編輯 /etc/ssh/sshd_config 檔案來將參數設置如下: PermitUserEnvironment no"
    compliance:
      - cis: ["5.2.12"]
      - cis_csc: ["14.6"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7", "CC6.1", "CC7.2"]
    condition: all
    rules:
      - 'c:sshd -T -> r:PermitUserEnvironment\s+no'

  # 5.2.13 Ensure only strong Ciphers are used (Scored)
  - id: 18661
    title: "確保僅使用強密碼。"
    description: "此變數限制 SSH 在通訊期間可以使用的密碼。"
    rationale: '無法依賴用於對加密模組進行身份驗證的弱密碼來提供機密性或完整性，且系統資料可能會受到損害。遠端攻擊者更容易透過長時間加密會話的生日攻擊（又稱「Sweet32」攻擊）來取得明文資料TLS 協定和SSL 協定中使用的RC4 演算法無法正確組合狀態在初始化階段將資料與金鑰資料混合在一起，這使得遠端攻擊者更容易透過嗅聞偶爾依賴受不變性弱點影響的金鑰的網路流量，然後使用暴力破解來對流的初始位元組進行明文恢復攻擊。名「Bar Mitzvah」問題能夠捕捉並重播會話的攻擊者可以恢復使用RC4 加密的SSH 會話期間使用的密碼SSH 協定中的錯誤處理；當客戶端和伺服器在密碼塊連結(CBC) 模式下使用區塊密碼演算法時，可以使遠端攻擊者更輕鬆地透過未知向量從SSH 會話中的任意密文區塊中恢復某些明文資料Monitor_wrap.c 中的mm_newkeys_from_blob 函數，當使用 AES-GCM 密碼時，無法正確初始化 MAC 上下文資料結構的記憶體，這允許遠端身份驗證的使用者透過提供精心設計的回呼位址的封包資料繞過預期的 ForceCommand 和登入 shell 限制'
    remediation: "編輯 /etc/ssh/sshd_config 檔案，新增/修改 Ciphers 行以包含網站批准的加密演算法列表 例子: Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr"
    compliance:
      - cis: ["5.2.13"]
      - cis_csc: ["14.4"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7", "CC6.1", "CC7.2"]
    reference:
      - "https://nvd.nist.gov/vuln/detail/CVE-2016-2183"
      - "https://nvd.nist.gov/vuln/detail/CVE-2015-2808"
      - "https://www.kb.cert.org/vuls/id/565052"
      - "https://www.openssh.com/txt/cbc.adv"
      - "https://nvd.nist.gov/vuln/detail/CVE-2008-5161"
      - "https://nvd.nist.gov/vuln/detail/CVE-2013-4548"
      - "https://www.kb.cert.org/vuls/id/565052"
      - "https://www.openssh.com/txt/cbc.adv"
    condition: none
    rules:
      - "c:sshd -T -> r:ciphers && r:3des-cbc|aes128-cbc|aes192-cbc|aes256-cbc|arcfour|arcfour128|arcfour256|blowfish-cbc|cast128-cbc|rijndael-cbc@lysator.liu.se"

  # 5.2.14 Ensure only strong MAC algorithms are used (Scored)
  - id: 18662
    title: "確保僅使用強 MAC 演算法。"
    description: "此變數限制 SSH 在通訊過程中可以使用的 MAC 演算法的類型。"
    rationale: "MD5 和 96 位元 MAC 演算法被認為較弱，但已被證明可以提高 SSH 降級攻擊的可用性。弱演算法作為可以透過擴充計算能力來利用的弱點而繼續受到廣泛關注。破壞演算法的攻擊者可以利用 MiTM 位置來解密 SSH 隧道並捕獲憑證和訊息"
    remediation: "編輯 /etc/ssh/sshd_config 檔案並新增/修改 MACs 行以包含網站核准的 MAC 的逗號分隔列表 例如: MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256"
    compliance:
      - cis: ["5.2.14"]
      - cis_csc: ["14.4", "16.5"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7", "CC6.1", "CC7.2"]
    reference:
      - "http://www.mitls.org/pages/attacks/SLOTH"
    condition: none
    rules:
      - "c:sshd -T -> r:MACs && r:hmac-md5|hmac-md5-96|hmac-ripemd160|hmac-sha1|hmac-sha1-96|umac-64@openssh.com|umac-128@openssh.com|hmac-md5-etm@openssh.com|hmac-md5-96-etm@openssh.com|hmac-ripemd160-etm@openssh.com|hmac-sha1-etm@openssh.com|hmac-sha1-96-etm@openssh.com|umac-64-etm@openssh.com|umac-128-etm@openssh.com"

  # 5.2.15 Ensure only strong Key Exchange algorithms are used (Scored)
  - id: 18663
    title: "確保僅使用強密鑰交換演算法。"
    description: "密鑰交換是密碼學中的任何方法，透過該方法在兩方之間交換密碼密鑰，從而允許使用密碼演算法。如果發送者和接收者希望交換加密訊息，則雙方必須具備加密要傳送的訊息和解密接收到的訊息的能力"
    rationale: "應刪除被認為較弱的密鑰交換方法。密鑰交換方法可能很弱，因為使用的位元太少，或者散列演算法被認為太弱。使用弱演算法可能會使連線遭受中間人攻擊"
    remediation: "編輯 /etc/ssh/sshd_config 檔案，新增或修改 KexAlgorithms 行以包含網站批准的密鑰交換算法的逗號分隔列表 例如: KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256"
    compliance:
      - cis: ["5.2.15"]
      - cis_csc: ["14.4"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.7", "CC6.1", "CC7.2"]
    condition: none
    rules:
      - "c:sshd -T -> r:kexalgorithms && r:diffie-hellman-group1-sha1|diffie-hellman-group14-sha1|diffie-hellman-group-exchange-sha1"

  # 5.2.16 Ensure SSH Idle Timeout Interval is configured (Scored)
  - id: 18664
    title: "確保已配置 SSH 空閒逾時間隔。"
    description: "ClientAliveInterval 和 ClientAliveCountMax 兩個選項控制 ssh 會話的逾時。設定 ClientAliveInterval 變數後，在指定時間長度內沒有活動的 ssh 會話將會終止。設定 ClientAliveCountMax 變數後，sshd 會在每個 ClientAliveInterval 間隔發送客戶端活動訊息。當連續發送了一定數量的客戶端活動訊息而客戶端沒有回應時，ssh 會話將終止。例如，如果 ClientAliveInterval 設定為 15 秒，ClientAliveCountMax 設定為 3，則用戶端 ssh 會話將在 45 秒空閒時間後終止。"
    rationale: "沒有與連線關聯的逾時值可能會允許未經授權的使用者存取另一個使用者的 ssh 會話（例如，使用者離開電腦並且不鎖定螢幕）。設定超時值至少可以降低發生這種情況的風險。雖然建議設定為 300 秒（5 分鐘），但請根據網站策略設定此逾時值。 ClientAliveCountMax 的建議設定為 0。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案以根據站點策略設置參數：ClientAliveInterval 300 ClientAliveCountMax 0"
    compliance:
      - cis: ["5.2.16"]
      - cis_csc: ["16.11"]
      - pci_dss: ["12.3.8"]
    condition: all
    rules:
      - 'c:sshd -T -> n:ClientAliveInterval\s*\t*(\d+) compare <= 300 && n:ClientAliveInterval\s*\t*(\d+) compare != 0'
      - 'c:sshd -T -> n:ClientAliveCountMax\s*\t*(\d+) compare <= 3'

  # 5.2.17 Ensure SSH LoginGraceTime is set to one minute or less (Scored)
  - id: 18665
    title: "確保 SSH LoginGraceTime 設定為一分鐘或更短。"
    description: "LoginGraceTime 參數指定成功對 SSH 伺服器進行驗證所允許的時間。寬限期越長，存在的開放式未經身份驗證的連線就越多。與此會話中的其他會話控制一樣，寬限期應限制在適當的組織限制內，以確保服務可用於所需的存取。"
    rationale: "將 LoginGraceTime 參數設定為較小的數字將最大限度地降低對 SSH 伺服器進行暴力攻擊的成功風險。它還會限制平行未經身份驗證的連接的數量。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案並設定參數如下: LoginGraceTime 60"
    compliance:
      - cis: ["5.2.17"]
      - cis_csc: ["5.1"]
      - pci_dss: ["8.1"]
      - tsc: ["CC6.1"]
    condition: all
    rules:
      - 'c:sshd -T -> n:LoginGraceTime\s*\t*(\d+) compare <= 60 && n:LoginGraceTime\s*\t*(\d+) compare >= 1'

  # 5.2.18 Ensure SSH access is limited (Scored)
  - id: 18666
    title: "確保 SSH 存取受到限制。"
    description: "有多個選項可用於限制哪些使用者和群組可以透過 SSH 存取系統。建議至少利用以下選項之一：AllowUsers、AllowGroups、DenyUsers、DenyGroups。"
    rationale: "限制哪些使用者可以透過 SSH 遠端存取系統將有助於確保只有授權使用者才能存取系統。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案來設置以下參數之一或多個：AllowUsers <userlist>    AllowGroups <grouplist>    DenyUsers <userlist>    DenyGroups <grouplist>"
    compliance:
      - cis: ["5.2.18"]
      - cis_csc: ["4.3"]
      - pci_dss: ["8.1"]
      - tsc: ["CC6.1"]
    condition: all
    rules:
      - 'c:sshd -T -> r:AllowUsers\s+\w+|AllowGroups\s+\w+|DenyUsers\s+\w+|DenyGroups\s+\w+'

  # 5.2.19 Ensure SSH warning banner is configured (Scored)
  - id: 18667
    title: "確保已配置 SSH 警告橫幅。"
    description: "Banner 參數指定一個檔案，在允許身份驗證之前，必須將其內容傳送給遠端使用者。預設情況下，不顯示橫幅。"
    rationale: "橫幅用於警告連接使用者特定網站的連線策略。在正常使用者登入之前呈現警告訊息可以幫助起訴電腦系統上的侵入者。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案以設定參數如下：Banner /etc/issue.net"
    compliance:
      - cis: ["5.2.19"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sshd -T -> r:Banner\s*\t*/etc/issue.net'

  # 5.2.20 Ensure SSH PAM is enabled (Scored)
  - id: 18668
    title: "確保 SSH PAM 已啟用。"
    description: "UsePAM 啟用可插入身份驗證模組介面。如果設定為“yes”，除了所有身份驗證類型的 PAM 帳戶和會話模組處理之外，還將使用 ChallengeResponseAuthentication 和 PasswordAuthentication 啟用 PAM 身份驗證。"
    rationale: "當 usePAM 設定為 yes 時，PAM 會正確執行帳戶和會話類型。如果您想根據帳戶的 IP、時間或其他因素限制對服務的存取，這一點很重要。此外，您可以確保使用者在登入時繼承某些環境變數或禁止存取伺服器。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案以設定參數如下: UsePAM yes"
    compliance:
      - cis: ["5.2.20"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sshd -T -> r:^\s*usepam\s+yes'

  # 5.2.21 Ensure SSH AllowTcpForwarding is disabled (Scored)
  - id: 18669
    title: "確保 SSH AllowTcpForwarding 已停用。"
    description: "SSH 連接埠轉送是 SSH 中的一種機制，用於將應用程式連接埠從用戶端傳送到伺服器，或將伺服器傳送到用戶端。它可用於向遺留應用程式添加加密、穿過防火牆，一些系統管理員和 IT 專業人員使用它從家用電腦打開進入內部網路的後門。"
    rationale: "啟用連接埠轉送可能會使組織面臨安全風險和後門。 SSH 連線受到強加密的保護。這使得它們的內容對於大多數部署的網路監控和流量過濾解決方案來說是不可見的。如果這種不可見性被用於惡意目的（例如資料外洩），則會帶來相當大的潛在風險。網路犯罪分子或惡意軟體可能會利用 SSH 隱藏其未經授權的通訊，或從目標網路中洩露被盜資料。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案，將參數設置如下： AllowTcpForwarding no"
    compliance:
      - cis: ["5.2.21"]
      - cis_csc: ["9.2"]
      - pci_dss: ["4.1"]
      - hipaa: ["164.312.a.2.IV", "164.312.e.1", "164.312.e.2.I", "164.312.e.2.II"]
      - nist_800_53: ["SC.8"]
      - tsc: ["CC6.1", "CC6.7", "CC7.2"]
    references:
      - https://www.ssh.com/ssh/tunneling/example
    condition: all
    rules:
      - 'c:sshd -T -> r:^\s*AllowTcpForwarding\s+no'

  - id: 18670
    title: "確保已配置 SSH MaxStartups。"
    description: "MaxStartups 參數指定 SSH 守護程式的平行未經驗證連線的最大數量。"
    rationale: "為了防止系統因大量待處理的身份驗證連線嘗試而導致拒絕服務，請使用 MaxStartups 的速率限制功能來保護 sshd 登入的可用性並防止守護程序不堪重負。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案以設置參數如下：maxstartups 10:30:60"
    compliance:
      - cis: ["5.2.22"]
      - cis_csc: ["5.1"]
    condition: all
    rules:
      - 'c:sshd -T -> r:^\s*maxstartups\s+10:30:60'

  # 5.2.23 Ensure SSH MaxSessions is  set to 4 or less (Scored)
  - id: 18671
    title: "確保 SSH MaxSessions 設定為 4 或更少。"
    description: "MaxSessions 參數指定給定連線允許的最大開啟會話數。"
    rationale: "為了防止系統因大量平行會話而導致拒絕服務，請使用 MaxSessions 的速率限制功能來保護 sshd 登入的可用性並防止守護程序不堪重負。"
    remediation: "編輯 /etc/ssh/sshd_config 檔案並將參數設定如下: MaxSessions 4"
    compliance:
      - cis: ["5.2.19"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sshd -T -> n:^MaxSessions\s+(\d+) compare <= 4'

  ######################################################
  # 5.3 Configure PAM
  ######################################################
  # 5.3.1 Ensure password creation requirements are configured (Scored)
  - id: 18672
    title: "確保配置密碼建立要求。"
    description: "pam_pwquality.so 模組檢查密碼的強度。它執行檢查，例如確保密碼不是字典單字、具有一定長度、包含混合字元（例如字母、數字、其他）等。以下是 pam_pwquality.so 選項的定義： - retry=3（在發回失敗之前允許嘗試 3 次）。在 /etc/security/pwquality.conf 檔案中設定以下選項： - minlen = 14 dcredit = -1 ucredit = -1 ocredit = -1 lcredit = -1 （上面顯示的設定是一種可能的策略。更改這些值以符合您自己組織的密碼策略。"
    rationale: "強密碼可以保護系統免於暴力破解。"
    remediation: "1) 執行以下指令以安裝 pam_pwquality 模組: apt install libpam-pwquality 2) 編輯 /etc/pam.d/common-password 檔案以包含適當的 pam_pwquality.so 選項並符合網站政策: password requisite pam_pwquality.so retry=3 3) 編輯 /etc/security/pwquality.conf 以新增或更新以下設定以符合網站政策: minlen = 14 dcredit = -1 ucredit = -1 ocredit = -1 lcredit = -1。注意: 可以設定額外的模組選項, 建議的要求僅涵蓋包括 try_first_pass 和 minlen 設為 14 或以上的部分。/etc/security/pwquality.conf 中的設定必須在 = 符號周圍使用空格。"
    compliance:
      - cis: ["5.3.1"]
      - cis_csc: ["4.4"]
      - pci_dss: ["8.2.3"]
      - tsc: ["CC6.1"]
    condition: all
    rules:
      - 'f:/etc/security/pwquality.conf -> !r:^# && n:minlen\s*\t*=\s*\t*(\d+) compare >= 14'
      - 'f:/etc/pam.d/common-password -> !r:^# && n:password\s*\t*requisite\s*\t*pam_pwquality.so\s*\t*retry=(\d+) compare <=3'

  # 5.3.2 Ensure lockout for failed password attempts is configured (Scored)
  - id: 18673
    title: "確保配置了針對失敗的密碼嘗試的鎖定。"
    description: "連續 n 次登入嘗試失敗後鎖定使用者。第一組變更是對 PAM 設定檔進行的。第二組變更應用於程式特定的 PAM 設定檔。第二組變更必須套用於將鎖定使用者的每個程式。檢查每個輔助程式的檔案，以了解如何配置它們以與 PAM 一起使用的說明。將鎖定號碼設定為您網站上有效的策略。"
    rationale: "在連續 n 次不成功的登入嘗試後鎖定使用者 ID 可減輕針對系統的暴力密碼攻擊。"
    remediation: '編輯 /etc/pam.d/common-auth 檔案並新增如下的 auth 行：auth required pam_tally2.so onerr=fail audit silent deny=5 unlock_time=900。編輯 /etc/pam.d/common-account 檔案並新增如下的 account 行：account requisite pam_deny.so account required pam_tally2.so。注意：如果用戶因達到 pam_tally2.so 模組定義的 deny= 的最大連續失敗次數被鎖定，可以通過發出指令 /sbin/pam_tally2 -u <username> --reset 解鎖用戶。此指令將失敗計數設為 0，有效地解鎖用戶。注意：pam_tally2.so 的BUG為了解決此問題，已在 /etc/pam.d/common-account 檔案的 accounts 部分中新增 pam_tally2.so 到審計和補救部分。pam_tally2 行必須新增以在使用 sudo 時將計數重置為 0。使用 "audit" 關鍵字可能會在身份驗證過程中由於用戶錯誤而記錄憑證。這風險應在您組織的站點政策背景下進行評估。'
    compliance:
      - cis: ["5.3.2"]
      - cis_csc: ["16.7"]
      - pci_dss: ["8.2.5"]
      - tsc: ["CC6.1"]
    condition: all
    rules:
      - 'f:/etc/pam.d/common-auth -> !r:^# && r:auth\s*\t*required\s*\t*pam_tally2.so && r:onerr=fail && r:audit && r:silent && r:deny\s*=\s*\d+ && r:unlock_time\s*=\s*\d+'
      - 'f:/etc/pam.d/common-account -> !r:^# && r:account\s*\t*requisite\s*\t*pam_deny.so'
      - 'f:/etc/pam.d/common-account -> !r:^# && r:account\s*\t*required\s*\t*pam_tally2.so'

  # 5.3.3 Ensure password reuse is limited (Scored)
  - id: 18674
    title: "確保密碼重複使用受到限制。"
    description: "/etc/security/opasswd 檔案儲存使用者的舊密碼，可以檢查該檔案以確保使用者沒有重複使用最近的密碼。"
    rationale: "強制使用者不要重複使用過去 5 個密碼，可以降低攻擊者猜測密碼的可能性。請注意，這些變更僅適用於本機系統上配置的帳戶。"
    remediation: "編輯 /etc/pam.d/common-password 檔案，加入remember選項並符合網站政策，如下所示： password required pam_pwhistory.so remember=5。 注意：可以設定其他模組選項，此建議僅涵蓋這裡列出的部分。"
    compliance:
      - cis: ["5.3.3"]
      - cis_csc: ["16"]
      - pci_dss: ["8.2.5"]
      - tsc: ["CC6.1"]
    condition: none
    rules:
      - 'f:/etc/pam.d/common-password -> !r:^# && r:password\s*\t*required\s*\t*pam_pwhistory.so && n:remember\s*\t*=\s*\t*(\d+) compare < 5'
      - 'f:/etc/pam.d/common-password -> !r:^# && r:password\s*\t*required\s*\t*pam_pwhistory.so && !r:remember'

  # 5.3.4 Ensure password hashing algorithm is SHA-512 (Scored)
  - id: 18675
    title: "確保密碼雜湊演算法為 SHA-512。"
    description: "以下指令將密碼加密從 md5 更改為 sha512（一種更強的雜湊演算法）。所有現有帳戶都需要執行密碼更改，以將儲存的雜湊值升級到新演算法。"
    rationale: "SHA-512 演算法提供比 MD5 更強的雜湊，從而透過增加攻擊者成功確定密碼的難度來為系統提供額外的保護。請注意，這些變更僅適用於本機系統上配置的帳戶。"
    remediation: "編輯 /etc/pam.d/common-password 檔案，將 pam_unix.so 包含 sha512 選項，如下所示：password [success=1 default=ignore] pam_unix.so sha512"
    compliance:
      - cis: ["5.3.4"]
      - cis_csc: ["16.14"]
      - pci_dss: ["3.6.1", "8.2.1"]
      - tsc: ["CC6.1", "CC6.7"]
    condition: none
    rules:
      - 'f:/etc/pam.d/common-password -> r:^password\.+pam_unix.so && !r:sha512'

  ####################################################
  # 5.4 User Accounts and Environment
  ####################################################
  ####################################################
  # 5.4.1 Set Shadow Password Suite Parameters
  ####################################################
  # 5.4.1.1 Ensure password expiration is 365 days or less (Scored)
  - id: 18676
    title: "確保密碼有效期限為 365 天或更短。"
    description: "/etc/login.defs 中的 PASS_MAX_DAYS 參數允許管理者在密碼達到定義的期限後強制密碼過期。建議將PASS_MAX_DAYS參數設定為小於或等於365天。"
    rationale: "攻擊者利用受損憑證或透過線上暴力攻擊成功破解憑證的機會視窗受到密碼期限的限制。因此，降低密碼的最長使用期限也會減少攻擊者的機會視窗。"
    remediation: "將PASS_MAX_DAYS參數設定為符合站點策略在/etc/login.defs中：PASS_MAX_DAYS 90。修改所有設有密碼的用戶參數以匹配：# chage --maxdays 90 <user>。注意：您也可以直接在/etc/shadow中檢查此設置。對於所有設有密碼的用戶，第5個字段應為365或更少。設為-1將禁用密碼過期。此外，密碼過期必須大於密碼更改之間的最小天數，否則用戶將無法更改密碼。"
    compliance:
      - cis: ["5.4.1.1"]
      - cis_csc: ["4.4"]
      - pci_dss: ["8.2.4"]
      - tsc: ["CC6.1"]
    condition: all
    rules:
      - 'f:/etc/login.defs -> n:^\s*\t*PASS_MAX_DAYS\s*\t*(\d+) compare <= 365'
      - 'not f:/etc/login.defs -> n:^\s*\t*PASS_MAX_DAYS\s*\t*(\d+) compare < 0'

  # 5.4.1.2 Ensure minimum days between password changes is configured
  - id: 18677
    title: "確保密碼變更之間的最短天數為 7 或更長。"
    description: "/etc/login.defs 中的 PASS_MIN_DAYS 參數允許管理員阻止使用者更改其密碼，直到自使用者上次更改密碼以來經過最少天數。建議將 PASS_MIN_DAYS 參數設定為 7 天或更多天。"
    rationale: "透過限制密碼變更頻率，管理者可以防止使用者重複更改密碼以試圖規避密碼重複使用控制。"
    remediation: "將PASS_MIN_DAYS參數設為7在/etc/login.defs中：PASS_MIN_DAYS 7。修改所有設定了密碼的用戶參數以匹配：# chage --mindays 7 <user>。備註：你也可以直接在/etc/shadow中檢查這個設定。第四個欄位應該是7或者更大，對於所有有密碼的用戶來說。"
    compliance:
      - cis: ["5.4.1.2"]
      - cis_csc: ["4.4", "16"]
      - pci_dss: ["8.2"]
      - tsc: ["CC6.1"]
    condition: all
    rules:
      - 'f:/etc/login.defs -> n:^\s*\t*PASS_MIN_DAYS\s*\t*(\d+) compare >= 1'

  # 5.4.1.3 Ensure password expiration warning days is 7 or more (Scored)
  - id: 18678
    title: "確保密碼過期警告天數為 7 或更長。"
    description: "/etc/login.defs 中的 PASS_WARN_AGE 參數可讓管理者通知使用者其密碼將在定義的天數內過期。建議將PASS_WARN_AGE參數設定為7天或更多天。"
    rationale: "提供密碼即將過期的預先警告，讓使用者有時間考慮安全的密碼。不知情的用戶可能會選擇一個簡單的密碼或將其寫在可能被發現的地方。"
    remediation: "將 /etc/login.defs 中的 PASS_WARN_AGE 參數設定為 7: PASS_WARN_AGE 7。修改所有已設置密碼的用戶參數以匹配：# chage --warndays 7 <user>。注意：您也可以直接在 /etc/shadow 中檢查此設置。第六欄對於所有已設置密碼的用戶應為 7 或更多。"
    compliance:
      - cis: ["5.4.1.3"]
      - cis_csc: ["4.4"]
      - pci_dss: ["8.2"]
      - tsc: ["CC6.1"]
    condition: all
    rules:
      - 'f:/etc/login.defs -> n:^\s*\t*PASS_WARN_AGE\s*\t*(\d+) compare >= 7'

  # 5.4.1.4 Ensure inactive password lock is 30 days or less (Scored)
  - id: 18679
    title: "確保非活動密碼鎖定時間不超過 30 天。"
    description: "在給定時間段內不活動的使用者帳戶可以自動停用。建議停用密碼過期後 30 天內不活動的帳號。"
    rationale: "不活動的帳戶對系統安全性構成威脅，因為使用者登入時不會注意到失敗的登入嘗試或其他異常情況。"
    remediation: "執行以下指令將預設的密碼不活動期限設置為30天: # useradd -D -f 30. 修改所有設置了密碼的用戶參數以匹配此項: # chage --inactive 30 <user>. 注意: 您也可以直接在 /etc/shadow 中檢查此設置。對於所有設置了密碼的用戶，第七個字段應為30或更小。-1的值將禁用此設置。"
    compliance:
      - cis: ["5.4.1.4"]
      - cis_csc: ["4.4", "16"]
      - pci_dss: ["8.2"]
      - tsc: ["CC6.1"]
    condition: all
    rules:
      - 'c:useradd -D -> n:^INACTIVE=(\d+) compare <= 30'
      - 'not c:useradd -D -> n:^INACTIVE=(\d+) compare < 0'

  # 5.4.3 Ensure default group for the root account is GID 0 (Scored)
  - id: 18680
    title: "確保 root 帳號的預設群組是 GID 0。"
    description: "usermod指令可用來指定root使用者屬於哪個群組。這會影響 root 使用者所建立的檔案的權限。"
    rationale: "對 root 帳號使用 GID 0 有助於防止非特權使用者意外存取 root 擁有的檔案。"
    remediation: "運行以下指令來將 root 使用者的預設群組設置為 GID 0: # usermod -g 0 root"
    compliance:
      - cis: ["5.4.3"]
      - cis_csc: ["14.6"]
      - pci_dss: ["8.2"]
      - tsc: ["CC6.1"]
    condition: all
    rules:
      - 'f:/etc/passwd -> !r:^# && r:root:\w+:\w+:0:'

  # 5.4.4 Ensure default user umask is 027 or more restrictive (Scored)
  - id: 18681
    title: "確保預設使用者 umask 為 027 或更具限制性。"
    description: "預設umask決定了使用者建立的檔案的權限。建立檔案的使用者可以自行決定透過 chmod 指令使其檔案和目錄可供其他人讀取。希望預設允許其他人讀取其檔案和目錄的使用者可以透過將 umask 指令插入其主目錄中的標準 shell 設定檔（ .profile 、 .bashrc 等）來選擇不同的預設 umask。"
    rationale: "為 umask 設定一個非常安全的預設值可確保使用者對其檔案權限做出有意識的選擇。預設 umask 設定 077 會導致系統上的任何其他使用者無法讀取使用者建立的檔案和目錄。 umask 為 027 將使檔案和目錄可供同一 Unix 群組中的使用者讀取，而 umask 為 022 將使檔案可供系統上的每個使用者讀取。"
    remediation: "編輯 /etc/bash.bashrc 、/etc/profile 和 /etc/profile.d/*.sh 檔案（以及系統上任何其他支援shell的相應檔案），添加或編輯任何umask參數如下：umask 027"
    compliance:
      - cis: ["5.4.4"]
      - cis_csc: ["14.6"]
      - pci_dss: ["8.2"]
      - tsc: ["CC6.1"]
    condition: none
    rules:
      - 'f:/etc/bash.bashrc -> !r:^\s*\t*# && r:umask \d0\d|umask \d1\d|umask \d4\d|umask \d5\d'
      - 'f:/etc/bash.bashrc -> !r:^\s*\t*# && n:umask \d\d(\d) compare != 7'
      - 'f:/etc/profile -> !r:^\s*\t*# && r:umask \d0\d|umask \d1\d|umask \d4\d|umask \d5\d'
      - 'f:/etc/profile -> !r:^\s*\t*# && n:umask \d\d(\d) compare != 7'
      - 'd:/etc/profile.d -> .sh -> !r:^\s*\t*# && r:umask \d0\d|umask \d1\d|umask \d4\d|umask \d5\d'
      - 'd:/etc/profile.d -> .sh -> !r:^\s*t*# && n:umask \d\d(\d) compare != 7'

  # 5.4.5 Ensure default user shell timeout is 900 seconds or less (Scored)
  - id: 18682
    title: "確保預設使用者 shell 逾時為 900 秒或更短。"
    description: "預設的 TMOUT 決定使用者的 shell 逾時。 TMOUT 值以秒為單位測量。"
    rationale: "沒有與 shell 關聯的逾時值可能會允許未經授權的使用者存取另一個使用者的 shell 會話（例如，使用者離開電腦並且不鎖定螢幕）。設定超時值至少可以降低發生這種情況的風險。"
    remediation: "編輯 /etc/bash.bashrc 、 /etc/profile 和 /etc/profile.d/*.sh 檔案（以及系統上支持的任何其他 Shell 的相關檔案），添加或編輯以下 umask 參數： readonly TMOUT=900 ; export TMOUT 。請注意，將該值設為 readonly 可以防止在運行期間的意外修改。"
    compliance:
      - cis: ["5.4.5"]
      - cis_csc: ["16.11"]
      - pci_dss: ["12.3.8"]
    condition: all
    rules:
      - 'not d:/etc/profile.d -> .sh -> r:^\s*\t*readonly && n:TMOUT\s*\t*=\s*\t*(\d+) compare > 900'
      - 'not f:/etc/bash.bashrc -> r:^\s*\t*readonly && n:TMOUT\s*\t*=\s*\t*(\d+) compare > 900'
      - 'not f:/etc/profile -> r:^\s*\t*readonly && n:TMOUT\s*\t*=\s*\t*(\d+) compare > 900'
      - 'd:/etc/profile.d -> .sh -> r:^\s*\t*readonly && n:TMOUT\s*\t*=\s*\t*(\d+) compare <= 900'
      - 'f:/etc/bash.bashrc -> r:^\s*\t*readonly && n:TMOUT\s*\t*=\s*\t*(\d+) compare <= 900'
      - 'f:/etc/profile -> r:^\s*\t*readonly && n:TMOUT\s*\t*=\s*\t*(\d+) compare <= 900'

  # 5.6 Ensure access to the su command is restricted (Scored)
  - id: 18683
    title: "確保對 su 指令的存取受到限制。"
    description: "su 指令允許使用者以另一個使用者的身分執行指令或 shell。該程式已被 sudo 取代，它允許對特權存取進行更精細的控制。通常，su 指令可以由任何使用者執行。透過取消/etc/pam.d/su中pam_wheel.so語句的註釋，su指令將只允許sudo群組中的使用者執行su。"
    rationale: "限制 su 的使用並使用 sudo 代替它，可以使系統管理員更好地控制使用者權限的升級以執行特權指令。 sudo 實用程式還提供了更好的日誌記錄和審核機制，因為它可以記錄透過 sudo 執行的每個指令，而 su 只能記錄使用者執行了 su 程式。"
    remediation: "建立一個指定用於 su 指令的空群組。群組名稱應符合站點策略。示例 # groupadd sugroup 將以下行添加到 /etc/pam.d/su 檔案中，指定空群組：auth required pam_wheel.so use_uid group=sugroup"
    compliance:
      - cis: ["5.6"]
      - cis_csc: ["5.1"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - tsc: ["CC7.2", "CC6.1", "CC6.8", "CC7.3", "CC7.4"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
    condition: all
    rules:
      - 'f:/etc/pam.d/su -> !r:^# && r:auth\s*\t*required\s*\t*pam_wheel.so && r:use_uid && r:group='

  ############################################################
  # 6 System Maintenance
  ############################################################

  ############################################################
  # 6.1 System File Permissions
  ############################################################
  # 6.1.2 Ensure permissions on /etc/passwd are configured (Scored)
  - id: 18684
    title: "確保配置了 /etc/passwd 的權限。"
    description: "/etc/passwd 檔案包含許多系統實用程式使用的使用者帳戶訊息，因此必須可讀，這些實用程式才能運作。"
    rationale: "確保 /etc/passwd 檔案免受未經授權的寫入存取至關重要。儘管預設情況下它受到保護，但檔案權限可能會被無意或透過惡意操作更改。"
    remediation: "執行以下指令以設置 /etc/passwd 的權限: # chown root:root /etc/passwd # chmod 644 /etc/passwd"
    compliance:
      - cis: ["6.1.2"]
      - cis_csc: ["16.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/passwd -> r:Access:\s*\(0644/-rw-r--r--\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  # 6.1.3 Ensure permissions on /etc/gshadow- are configured (Scored)
  - id: 18685
    title: "確保 /etc/gshadow- 上的權限已配置。"
    description: "/etc/gshadow- 檔案用於儲存對這些帳戶的安全性至關重要的群組的備份訊息，例如散列密碼和其他安全資訊。"
    rationale: "確保 /etc/gshadow- 檔案免受未經授權的存取至關重要。儘管預設情況下它受到保護，但檔案權限可能會被無意或透過惡意操作更改。"
    remediation: "根據需要執行以下其中一個 chown 指令，然後使用 chmod 設置 /etc/gshadow- 的權限： # chown root:root /etc/gshadow- # chown root:shadow /etc/gshadow- # chmod o-rwx,g-wx /etc/gshadow-"
    compliance:
      - cis: ["6.1.3"]
      - cis_csc: ["16.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/gshadow- -> r:Access:\s*\(0\d\d0/-\w\w-\w-----\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*\d+/\s*\t*shadow\)|Access:\s*\(0\d\d0/-\w\w-\w-----\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  # 6.1.4 Ensure permissions on /etc/shadow are configured (Scored)
  - id: 18686
    title: "確保配置了 /etc/shadow 的權限。"
    description: "/etc/shadow 檔案用於儲存對這些帳戶的安全性至關重要的有關使用者帳戶的資訊，例如雜湊密碼和其他安全資訊。"
    rationale: "如果攻擊者可以獲得 /etc/shadow 檔案的讀取權限，他們就可以輕鬆地針對雜湊密碼執行密碼破解程式來破解它。儲存在 /etc/shadow 檔案中的其他安全資訊（例如到期時間）也可能有助於破壞使用者帳戶。"
    remediation: "執行以下指令來設定 /etc/shadow 的權限：# chown root:shadow /etc/shadow # chmod o-rwx,g-wx /etc/shadow"
    compliance:
      - cis: ["6.1.4"]
      - cis_csc: ["16.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/shadow -> r:Access:\s*\(0\d\d0/-\w\w-\w-----\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*\d+/\s*\t*shadow\)'

  # 6.1.5 Ensure permissions on /etc/group are configured (Scored)
  - id: 18687
    title: "確保配置了 /etc/group 的權限。"
    description: "/etc/group 檔案包含系統中定義的所有有效群組的清單。下面的指令允許 root 進行讀取/寫入存取，並允許其他人進行讀取存取。"
    rationale: "/etc/group 檔案需要受到保護，防止非特權使用者進行未經授權的更改，但需要可讀，因為此資訊與許多非特權程式一起使用。"
    remediation: "執行以下指令以設定 /etc/group 的權限: # chown root:root /etc/group # chmod 644 /etc/group"
    compliance:
      - cis: ["6.1.5"]
      - cis_csc: ["16.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/group -> r:Access:\s*\(0644/-rw-r--r--\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  # 6.1.6 Ensure permissions on /etc/passwd- are configured (Scored)
  - id: 18688
    title: "確保配置了 /etc/passwd- 的權限。"
    description: "/etc/passwd- 檔案包含備份使用者帳號資訊。"
    rationale: "確保 /etc/passwd- 檔案免受未經授權的存取至關重要。儘管預設情況下它受到保護，但檔案權限可能會被無意或透過惡意操作更改。"
    remediation: "執行以下指令來設定 /etc/passwd- 的權限: # chown root:root /etc/passwd- # chmod u-x,go-rwx /etc/passwd-"
    compliance:
      - cis: ["6.1.6"]
      - cis_csc: ["16.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/passwd- -> r:Access:\s*\(0\d00/-\w\w-------\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  # 6.1.7 Ensure permissions on /etc/shadow- are configured (Scored)
  - id: 18689
    title: "確保配置了 /etc/shadow- 上的權限。"
    description: "/etc/shadow- 檔案用於儲存對使用者帳戶的安全性至關重要的備份訊息，例如雜湊密碼和其他安全資訊。"
    rationale: "確保 /etc/shadow- 檔案免受未經授權的存取至關重要。儘管預設情況下它受到保護，但檔案權限可能會被無意或透過惡意操作更改。"
    remediation: "運行以下指令來設置 /etc/shadow- 的許可權: # chown root:shadow /etc/shadow- # chmod u-x,go-rwx /etc/shadow-"
    compliance:
      - cis: ["6.1.7"]
      - cis_csc: ["16.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/shadow- -> r:Access:\s*\(0\d\d0/-\w\w-\w-----\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*\d+/\s*\t*shadow\)|Access:\s*\(0\d\d0/-\w\w-\w-----\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  # 6.1.8 Ensure permissions on /etc/group- are configured (Scored)
  - id: 18690
    title: "確保配置了 /etc/group- 的權限。"
    description: "/etc/group- 檔案包含系統中定義的所有有效群組的備份清單。"
    rationale: "確保 /etc/group- 檔案免受未經授權的存取至關重要。儘管預設情況下它受到保護，但檔案權限可能會被無意或透過惡意操作更改。"
    remediation: "執行以下指令以設定 /etc/group- 的權限：# chown root:root /etc/group- # chmod u-x,go-rwx /etc/group-"
    compliance:
      - cis: ["6.1.8"]
      - cis_csc: ["16.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/group- -> r:Access:\s*\(0\d00/-\w\w-------\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'

  # 6.1.9 Ensure permissions on /etc/gshadow are configured (Scored)
  - id: 18691
    title: "確保配置了 /etc/gshadow 的權限。"
    description: "/etc/gshadow 檔案用於儲存對這些帳戶的安全性至關重要的群組訊息，例如雜湊密碼和其他安全資訊。"
    rationale: "如果攻擊者可以獲得 /etc/gshadow 檔案的讀取權限，他們就可以輕鬆地針對雜湊密碼執行密碼破解程式來破解它。儲存在 /etc/gshadow 檔案中的其他安全資訊（例如群組管理員）也可能有助於破壞群組"
    remediation: "運行以下指令以設置 /etc/gshadow 的權限 : # chown root:shadow /etc/gshadow # chmod o-rwx,g-rw /etc/gshadow"
    compliance:
      - cis: ["6.1.9"]
      - cis_csc: ["16.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:stat /etc/gshadow -> r:Access:\s*\(0\d\d0/-\w\w-\w-----\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*\d+/\s*\t*shadow\)'

  ####################################################
  # 6.2 User and Group Settings
  ####################################################

  # 6.2.1 Ensure password fields are not empty (Scored)
  - id: 18692
    title: "確保密碼欄位不為空。"
    description: "密碼欄位為空的帳戶意味著任何人都可以登入該使用者而無需提供密碼。"
    rationale: "所有帳戶必須有密碼或被鎖定，以防止未經授權的使用者使用該帳戶。"
    remediation: "如果 /etc/shadow 檔案中任何帳號沒有密碼，請運行以下指令來鎖定該帳號，直到查明為何沒有密碼為止：# passwd -l <em><username></em>。同時，檢查該帳號是否已登入，並調查其用途，以確定是否需要強制登出。"
    compliance:
      - cis: ["6.2.1"]
      - cis_csc: ["4.4"]
      - pci_dss: ["8.2"]
      - tsc: ["CC6.1"]
    condition: none
    rules:
      - 'f:/etc/shadow -> r:^\w+::'

  # 6.2.2 Ensure no legacy "+" entries exist in /etc/passwd (Scored)
  - id: 18693
    title: "確保 /etc/passwd 中不存在遺留 + 條目"
    description: "各種檔案中的字元 + 曾經是系統在系統設定檔中的某個點插入來自 NIS 映射的資料的標記。大多數系統不再需要這些條目，但可能存在於從其他平台匯入的檔案中。"
    rationale: "這些條目可能為攻擊者提供獲得系統特權存取的途徑。"
    remediation: "如果存在，請移除/etc/passwd中的任何舊有的+條目。"
    compliance:
      - cis: ["6.2.2"]
      - cis_csc: ["16.2"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
    condition: none
    rules:
      - "f:/etc/passwd -> !r:^# && r:^+:"

  # 6.2.4 Ensure no legacy "+" entries exist in /etc/shadow (Scored)
  - id: 18694
    title: "確保 /etc/shadow 中不存在遺留 + 條目"
    description: "各種檔案中的字元 + 曾經是系統在系統設定檔中的某個點插入來自 NIS 映射的資料的標記。大多數系統不再需要這些條目，但可能存在於從其他平台匯入的檔案中。"
    rationale: "這些條目可能為攻擊者提供獲得系統特權存取的途徑。"
    remediation: "如果存在的話，從 /etc/shadow 中移除任何遺留的 + 條目。"
    compliance:
      - cis: ["6.2.4"]
      - cis_csc: ["16.9"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
    condition: none
    rules:
      - "f:/etc/shadow -> !r:^# && r:^+:"

  # 6.2.5 Ensure no legacy "+" entries exist in /etc/group (Scored)
  - id: 18695
    title: "確保 /etc/group 中不存在舊 + 條目"
    description: "各種檔案中的字元 + 曾經是系統在系統設定檔中的某個點插入來自 NIS 映射的資料的標記。大多數系統不再需要這些條目，但可能存在於從其他平台匯入的檔案中。"
    rationale: "這些條目可能為攻擊者提供獲得系統特權存取的途徑。"
    remediation: "如果存在，請從 /etc/group 中移除所有舊版的 + 條目。"
    compliance:
      - cis: ["6.2.5"]
      - cis_csc: ["16.2"]
      - pci_dss: ["2.2.3"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"]
    condition: none
    rules:
      - "f:/etc/group -> !r:^# && r:^+:"

  # 6.2.6 Ensure root is the only UID 0 account (Scored)
  - id: 18696
    title: "確保 root 是唯一的 UID 0 帳號。"
    description: "任何 UID 為 0 的帳戶都具有系統的超級使用者權限。"
    rationale: "此存取必須僅限於預設 root 帳戶並且只能透過系統控制台進行。管理存取必須透過非特權帳戶使用經批准的機制進行，如第 5.6 項所述，確保對 su 指令的存取受到限制。"
    remediation: "移除除了 root 以外 UID 為 0 的任何使用者，或在適當時分配新的 UID 給他們。"
    compliance:
      - cis: ["6.2.6"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - tsc: ["CC7.2", "CC6.1", "CC6.8", "CC7.3", "CC7.4"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
    condition: none
    rules:
      - 'f:/etc/passwd -> !r:^# && !r:^root: && r:^\w+:\w+:0:'

  # 6.2.20 Ensure shadow group is empty (Scored)
  - id: 18697
    title: "確保影子組為空。"
    description: "影子群組允許需要存取權限的系統程式讀取 /etc/shadow 檔案。不應將任何使用者指派到影子群組。"
    rationale: "分配給影子群組的任何使用者都將被授予對 /etc/shadow 檔案的讀取權限。如果攻擊者可以獲得 /etc/shadow 檔案的讀取權限，他們就可以輕鬆地針對雜湊密碼執行密碼破解程式來破解它們。儲存在 /etc/shadow 檔案中的其他安全資訊（例如到期時間）也可能有助於破壞其他使用者帳戶。"
    remediation: "從 shadow 群組中移除所有用戶，並更改所有以 shadow 作為主要群組的用戶的主要群組。"
    compliance:
      - cis: ["6.2.20"]
      - pci_dss: ["10.2.5"]
      - hipaa: ["164.312.b"]
      - nist_800_53: ["AU.14", "AC.7"]
      - tsc: ["CC7.2", "CC6.1", "CC6.8", "CC7.3", "CC7.4"]
      - gpg_13: ["7.8"]
      - gdpr_IV: ["35.7", "32.2"]
    condition: none
    rules:
      - 'f:/etc/group -> !r:^# && r:shadow:\w*:\w*:\S+'
